[{"title":"argo workflows quick start","url":"/argo/argo-workflows-quick-start/","content":"<h2 id=\"安装部署\"><a href=\"#安装部署\" class=\"headerlink\" title=\"安装部署\"></a>安装部署</h2><p>新建命名空间并部署项目资源</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl create namespace argo</span><br><span class=\"line\">kubectl apply -n argo -f https://github.com/argoproj/argo-workflows/releases/download/v3.5.10/install.yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"暴露服务\"><a href=\"#暴露服务\" class=\"headerlink\" title=\"暴露服务\"></a>暴露服务</h2><p>默认情况下， argo workflows 服务不对外暴露服务，可以通过 LoadBalancer 或者 NodePort 类型的 Service、Ingress、Kubectl 端口转发等方式将 argo workflows 服务发布到 Kubernetes 集群外部。</p>\n<p>由于是 vm 自建，所以选择使用 NodePort 的方式暴露服务。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl patch svc argo-server -n argo -p <span class=\"string\">&#x27;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>查看随机暴露的端口</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~# kubectl get svc -n argo</span><br><span class=\"line\">NAME          TYPE       CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE</span><br><span class=\"line\">argo-server   NodePort   10.43.35.195   &lt;none&gt;        2746:30701/TCP   4m28s</span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<h2 id=\"访问-UI\"><a href=\"#访问-UI\" class=\"headerlink\" title=\"访问 UI\"></a>访问 UI</h2><p>使用 node:30701 访问</p>\n<p><img src=\"/argo/argo-workflows-quick-start/image-20240806212341598.png\" alt=\"image-20240806212341598\"></p>\n<p>由于默认部署后需要集成登录。但是本机为了测试，可以手动更改鉴权方式，让他走 k8s 的 serviceaccount 认证。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">patch</span> <span class=\"string\">deployment</span> <span class=\"string\">\\</span></span><br><span class=\"line\">  <span class=\"string\">argo-server</span> <span class=\"string\">\\</span></span><br><span class=\"line\">  <span class=\"string\">--namespace</span> <span class=\"string\">argo</span> <span class=\"string\">\\</span></span><br><span class=\"line\">  <span class=\"string\">--type=&#x27;json&#x27;</span> <span class=\"string\">\\</span></span><br><span class=\"line\">  <span class=\"string\">-p=&#x27;[&#123;&quot;op&quot;:</span> <span class=\"string\">&quot;replace&quot;</span><span class=\"string\">,</span> <span class=\"attr\">&quot;path&quot;:</span> <span class=\"string\">&quot;/spec/template/spec/containers/0/args&quot;</span><span class=\"string\">,</span> <span class=\"attr\">&quot;value&quot;:</span> [</span><br><span class=\"line\">  <span class=\"string\">&quot;server&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;--auth-mode=server&quot;</span></span><br><span class=\"line\">]<span class=\"string\">&#125;]&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>再次访问 UI</p>\n<p><img src=\"/argo/argo-workflows-quick-start/image-20240806212507410.png\" alt=\"image-20240806212507410\"></p>\n<h2 id=\"安装-argo-命令\"><a href=\"#安装-argo-命令\" class=\"headerlink\" title=\"安装 argo 命令\"></a>安装 argo 命令</h2><figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Download the binary</span></span><br><span class=\"line\">curl -sLO https://github.com/argoproj/argo-workflows/releases/download/v3.5.10/argo-linux-amd64.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Unzip</span></span><br><span class=\"line\">gunzip argo-linux-amd64.gz</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Make binary executable</span></span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x argo-linux-amd64</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Move binary to path</span></span><br><span class=\"line\"><span class=\"built_in\">mv</span> ./argo-linux-amd64 /usr/local/bin/argo</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Test installation</span></span><br><span class=\"line\">argo version</span><br><span class=\"line\">------------------------------------</span><br><span class=\"line\">root@devops:~/argo# argo version</span><br><span class=\"line\">argo: v3.5.10</span><br><span class=\"line\">  BuildDate: 2024-08-01T05:52:04Z</span><br><span class=\"line\">  GitCommit: 25829927431d9a0f46d17b72ae74aedb8d700884</span><br><span class=\"line\">  GitTreeState: clean</span><br><span class=\"line\">  GitTag: v3.5.10</span><br><span class=\"line\">  GoVersion: go1.21.12</span><br><span class=\"line\">  Compiler: gc</span><br><span class=\"line\">  Platform: linux/amd64</span><br><span class=\"line\">root@devops:~/argo#</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"创建-hello-world\"><a href=\"#创建-hello-world\" class=\"headerlink\" title=\"创建 hello world\"></a>创建 hello world</h2><p>提交工作流的时候，需要指定 serviceaccount 账号，不指定会使用默认的 default 账号，default 账号没有相关权限，会执行失败<br>为了本地测试方便，可以给<code>serviceaccount</code>直接<code>admin</code>权限</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl create rolebinding default-admin --clusterrole=admin --serviceaccount=argo:default -n argo</span><br><span class=\"line\">argo submit --serviceaccount argo  -n argo --watch https://raw.githubusercontent.com/argoproj/argo-workflows/main/examples/hello-world.yaml</span><br></pre></td></tr></table></figure>\n\n<p>执行命令后，控制台看到的执行信息</p>\n<p><img src=\"/argo/argo-workflows-quick-start/image-20240806215614777.png\" alt=\"image-20240806215614777\"></p>\n<p>ui 中可以看到提交的工作流</p>\n<p><img src=\"/argo/argo-workflows-quick-start/image-20240806215519679.png\" alt=\"image-20240806215519679\"></p>\n","categories":["argo"],"tags":["argo"]},{"title":"argo workflows step之间传参","url":"/argo/argo-workflows-step-share-parameter/","content":"<h1 id=\"步骤间参数传递\"><a href=\"#步骤间参数传递\" class=\"headerlink\" title=\"步骤间参数传递\"></a>步骤间参数传递</h1><ul>\n<li>将当前 step 的结果导出为<code>Output Parameter</code></li>\n<li>将前一个 step 的<code>Output Parameter</code>导入为当前步骤的<code>Input Parameter</code></li>\n</ul>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Workflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">generateName:</span> <span class=\"string\">output-parameter-</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">output-parameter</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">output-parameter</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">generate-parameter</span></span><br><span class=\"line\">        <span class=\"attr\">template:</span> <span class=\"string\">hello-world-to-file</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">consume-parameter</span></span><br><span class=\"line\">        <span class=\"attr\">template:</span> <span class=\"string\">print-message</span></span><br><span class=\"line\">        <span class=\"attr\">arguments:</span></span><br><span class=\"line\">          <span class=\"attr\">parameters:</span></span><br><span class=\"line\">          <span class=\"comment\"># 将第一步写入到文件中的信息读取出来，传递给下一个步骤</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;steps.generate-parameter.outputs.parameters.hello-param&#125;&#125;</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">hello-world-to-file</span></span><br><span class=\"line\">    <span class=\"attr\">container:</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">sh</span>, <span class=\"string\">-c</span>]</span><br><span class=\"line\">      <span class=\"attr\">args:</span> [<span class=\"string\">&quot;echo -n Output And Input Test &gt; /tmp/hello_world.txt&quot;</span>]  <span class=\"comment\"># 将信息输出到文件中</span></span><br><span class=\"line\">    <span class=\"attr\">outputs:</span></span><br><span class=\"line\">      <span class=\"attr\">parameters:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">hello-param</span>  <span class=\"comment\"># name of output parameter</span></span><br><span class=\"line\">        <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/tmp/hello_world.txt</span> <span class=\"comment\"># set the value of hello-param to the contents of this hello-world.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">print-message</span></span><br><span class=\"line\">    <span class=\"attr\">inputs:</span></span><br><span class=\"line\">      <span class=\"attr\">parameters:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">    <span class=\"attr\">container:</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">echo</span>]</span><br><span class=\"line\">      <span class=\"attr\">args:</span> [<span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;inputs.parameters.message&#125;&#125;</span>&quot;</span>]</span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<p>在<code>arguments.parameters</code>中直接引用了之前步骤的<code>Output Parameter</code>，语法为 <code>&#123;&#123;steps.$stepName.outputs.parameters.$parameterName&#125;&#125;</code>。</p>\n<h1 id=\"内置的-result-参数\"><a href=\"#内置的-result-参数\" class=\"headerlink\" title=\"内置的 result 参数\"></a>内置的 result 参数</h1><p>除了手动导出的参数之外，<code>ArgoWorkflow</code>还会默认生成一个<code>Output Parameter</code>，就是<code>result</code>。和其他<code>Output Parameter</code>一样，可以通过 <code>&#123;&#123;steps.$stepName.outputs.parameters.$parameterName&#125;&#125;</code> 语法进行引用。这个<code>result</code>参数会捕获最大<code>256KB</code>的标准输出作为<code>value</code>。</p>\n<p>因此<code>result</code>包含以下内容：</p>\n<ul>\n<li>1）script 的运行结果</li>\n<li>2）容器的标准输出</li>\n</ul>\n<p>只要是在容器中输出到标准输出的，内容都可以被<code>result</code>捕获。</p>\n<h2 id=\"script-的运行结果\"><a href=\"#script-的运行结果\" class=\"headerlink\" title=\"script 的运行结果\"></a>script 的运行结果</h2><figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Workflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">generateName:</span> <span class=\"string\">scripts-bash-</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">bash-script-example</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">bash-script-example</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">generate</span></span><br><span class=\"line\">        <span class=\"attr\">template:</span> <span class=\"string\">gen-random-int-python</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">print</span></span><br><span class=\"line\">        <span class=\"attr\">template:</span> <span class=\"string\">print-message</span></span><br><span class=\"line\">        <span class=\"attr\">arguments:</span></span><br><span class=\"line\">          <span class=\"attr\">parameters:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;steps.generate.outputs.result&#125;&#125;</span>&quot;</span>  <span class=\"comment\"># 这里会将pythond的print信息收集，然后传递给下一个步骤作为输入信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">gen-random-int-python</span></span><br><span class=\"line\">    <span class=\"attr\">script:</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">python:alpine3.6</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">python</span>]</span><br><span class=\"line\">      <span class=\"attr\">source:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">        import random</span></span><br><span class=\"line\"><span class=\"string\">        i = random.randint(1, 100)</span></span><br><span class=\"line\"><span class=\"string\">        print(i)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">print-message</span></span><br><span class=\"line\">    <span class=\"attr\">inputs:</span></span><br><span class=\"line\">      <span class=\"attr\">parameters:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">    <span class=\"attr\">container:</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">alpine:latest</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">sh</span>, <span class=\"string\">-c</span>]</span><br><span class=\"line\">      <span class=\"attr\">args:</span> [<span class=\"string\">&quot;echo result was: <span class=\"template-variable\">&#123;&#123;inputs.parameters.message&#125;&#125;</span>&quot;</span>]</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"容器的标准输出\"><a href=\"#容器的标准输出\" class=\"headerlink\" title=\"容器的标准输出\"></a>容器的标准输出</h2><figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Workflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">generateName:</span> <span class=\"string\">scripts-bash-</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">bash-script-example</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">bash-script-example</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">generate</span></span><br><span class=\"line\">        <span class=\"attr\">template:</span> <span class=\"string\">whalesay-logs</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">print</span></span><br><span class=\"line\">        <span class=\"attr\">template:</span> <span class=\"string\">print-message</span></span><br><span class=\"line\">        <span class=\"attr\">arguments:</span></span><br><span class=\"line\">          <span class=\"attr\">parameters:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;steps.generate.outputs.result&#125;&#125;</span>&quot;</span> <span class=\"comment\">#将whalesay容器打印在控制台的logs收集并传递给下一个步骤作为输入</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">whalesay-logs</span></span><br><span class=\"line\">    <span class=\"attr\">container:</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">docker/whalesay</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">sh</span>, <span class=\"string\">-c</span>]</span><br><span class=\"line\">      <span class=\"attr\">args:</span> [<span class=\"string\">&quot;cowsay test container logs&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">print-message</span></span><br><span class=\"line\">    <span class=\"attr\">inputs:</span></span><br><span class=\"line\">      <span class=\"attr\">parameters:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">    <span class=\"attr\">container:</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">alpine:latest</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">sh</span>, <span class=\"string\">-c</span>]</span><br><span class=\"line\">      <span class=\"attr\">args:</span> [<span class=\"string\">&#x27;echo result was: &quot;<span class=\"template-variable\">&#123;&#123;inputs.parameters.message&#125;&#125;</span>&quot;&#x27;</span>] <span class=\"comment\">#特殊处理上面容器打印的换行log信息</span></span><br></pre></td></tr></table></figure>\n\n<p>相关具体信息见，<a href=\"https://argo-workflows.readthedocs.io/en/latest/walk-through/output-parameters/\">官方文档链接</a></p>\n","categories":["argo"],"tags":["argo"]},{"title":"argo workflows template","url":"/argo/argo-workflows-template/","content":"<h1 id=\"argo-workflow-template\"><a href=\"#argo-workflow-template\" class=\"headerlink\" title=\"argo workflow &amp; template\"></a>argo workflow &amp; template</h1><h2 id=\"Workflow-的相关类型\"><a href=\"#Workflow-的相关类型\" class=\"headerlink\" title=\"Workflow 的相关类型\"></a>Workflow 的相关类型</h2><h3 id=\"Workflow\"><a href=\"#Workflow\" class=\"headerlink\" title=\"Workflow\"></a>Workflow</h3><ul>\n<li><strong>定义</strong>: 是一个具体的工作流实例，描述了要执行的任务和步骤。</li>\n<li><strong>使用</strong>: 可以直接包含 <code>templates</code>，或者引用 <code>WorkflowTemplate</code> 和 <code>ClusterWorkflowTemplate</code>。</li>\n</ul>\n<h3 id=\"WorkflowTemplate\"><a href=\"#WorkflowTemplate\" class=\"headerlink\" title=\"WorkflowTemplate\"></a>WorkflowTemplate</h3><ul>\n<li><strong>定义</strong>: 是一个可重用的工作流模板，适用于同一命名空间内的多个工作流。</li>\n<li><strong>使用</strong>: <code>Workflow</code> 可以引用 <code>WorkflowTemplate</code> 以使用其定义的步骤和任务。</li>\n</ul>\n<h3 id=\"ClusterWorkflowTemplate\"><a href=\"#ClusterWorkflowTemplate\" class=\"headerlink\" title=\"ClusterWorkflowTemplate\"></a>ClusterWorkflowTemplate</h3><ul>\n<li><strong>定义</strong>: 与 <code>WorkflowTemplate</code> 类似，但在集群范围内可用，适用于跨命名空间的工作流。</li>\n<li><strong>使用</strong>: <code>Workflow</code> 可以引用 <code>ClusterWorkflowTemplate</code>，这使得模板在所有命名空间中都可用。</li>\n</ul>\n<h3 id=\"Templates\"><a href=\"#Templates\" class=\"headerlink\" title=\"Templates\"></a>Templates</h3><ul>\n<li><strong>定义</strong>: 是工作流中定义的实际可执行单元，可以是单个任务、步骤或 DAG。</li>\n<li><strong>使用</strong>: 定义在 <code>Workflow</code>、<code>WorkflowTemplate</code> 或 <code>ClusterWorkflowTemplate</code> 中。<code>templates</code> 可以相互引用，支持复用和组合。</li>\n</ul>\n<h3 id=\"关系\"><a href=\"#关系\" class=\"headerlink\" title=\"关系\"></a>关系</h3><ul>\n<li><strong>Workflow</strong> 可以包含 <code>templates</code> 直接执行，也可以引用 <code>WorkflowTemplate</code> 或 <code>ClusterWorkflowTemplate</code>。</li>\n<li><strong>WorkflowTemplate</strong> 和 <strong>ClusterWorkflowTemplate</strong> 提供了复用和参数化的能力，使得工作流定义更加灵活和可维护。</li>\n<li><strong>Templates</strong> 是工作流各组件的基本构建块，定义了具体的执行逻辑。</li>\n</ul>\n<span id=\"more\"></span>\n\n<h3 id=\"Workflow-的-yaml-解析\"><a href=\"#Workflow-的-yaml-解析\" class=\"headerlink\" title=\"Workflow 的 yaml 解析\"></a>Workflow 的 yaml 解析</h3><figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Workflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">generateName:</span> <span class=\"string\">steps-</span> <span class=\"comment\"># 自动生成工作流名称，以 steps- 开头。</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">hello</span> <span class=\"comment\"># 指定工作流的起始模板是 hello。entrypoint和java的main方法类似，是Workflow的入口</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">hello</span> <span class=\"comment\"># 这个是hello模板，被entrypoint引用，</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span> <span class=\"comment\"># 这是一个步骤模板，定义了顺序执行的任务</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">hello</span></span><br><span class=\"line\">        <span class=\"attr\">template:</span> <span class=\"string\">whalesay</span> <span class=\"comment\"># 该步骤引用了名为 whalesay 的模板。</span></span><br><span class=\"line\">        <span class=\"attr\">arguments:</span> <span class=\"comment\"># 传递参数 message，其值为 &quot;hello&quot;。</span></span><br><span class=\"line\">          <span class=\"attr\">parameters:</span> [&#123;<span class=\"attr\">name:</span> <span class=\"string\">message</span>, <span class=\"attr\">value:</span> <span class=\"string\">&quot;hello&quot;</span>&#125;]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">whalesay</span> <span class=\"comment\"># 这个是whalesay模板，被上面的hello模板中的hello步骤引用</span></span><br><span class=\"line\">    <span class=\"attr\">inputs:</span>\t<span class=\"comment\"># 定义输入参数</span></span><br><span class=\"line\">      <span class=\"attr\">parameters:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">    <span class=\"attr\">container:</span> <span class=\"comment\"># 定义一个容器任务。说明whalesay模板是个容器模板</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">docker/whalesay</span> <span class=\"comment\"># 使用 docker/whalesay 镜像。</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">cowsay</span>] <span class=\"comment\"># 执行 cowsay 命令，下面的&#123;&#123;&#125;&#125;获取上面的输入的参数</span></span><br><span class=\"line\">      <span class=\"attr\">args:</span> [<span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;inputs.parameters.message&#125;&#125;</span>&quot;</span>]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Template\"><a href=\"#Template\" class=\"headerlink\" title=\"Template\"></a>Template</h2><p>Templates 有下面这几种。</p>\n<h3 id=\"Container-Template\"><a href=\"#Container-Template\" class=\"headerlink\" title=\"Container Template\"></a><strong>Container Template</strong></h3><ul>\n<li>用于定义要运行的容器任务。</li>\n<li>包含镜像、命令、参数等。</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Workflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">generateName:</span> <span class=\"string\">container-example-</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">container-example</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">container-example</span></span><br><span class=\"line\">    <span class=\"attr\">container:</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">alpine:latest</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">echo</span>]</span><br><span class=\"line\">      <span class=\"attr\">args:</span> [<span class=\"string\">&quot;Hello, World!&quot;</span>]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Script-Template\"><a href=\"#Script-Template\" class=\"headerlink\" title=\"Script Template\"></a><strong>Script Template</strong></h3><ul>\n<li>用于运行脚本。</li>\n<li>可以指定脚本语言和内容。</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Workflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">generateName:</span> <span class=\"string\">script-example-</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">script-example</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">script-example</span></span><br><span class=\"line\">    <span class=\"attr\">script:</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">python:alpine</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">python</span>]</span><br><span class=\"line\">      <span class=\"attr\">source:</span> <span class=\"string\">|</span></span><br><span class=\"line\">        <span class=\"string\">print(&quot;Hello,</span> <span class=\"string\">World!&quot;)</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Steps-Template\"><a href=\"#Steps-Template\" class=\"headerlink\" title=\"Steps Template\"></a><strong>Steps Template</strong></h3><ul>\n<li>用于定义一系列顺序执行的任务。</li>\n<li>每个步骤可以引用其他模板。</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Workflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">generateName:</span> <span class=\"string\">steps-example-</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">steps-example</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">steps-example</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">step1</span></span><br><span class=\"line\">        <span class=\"attr\">template:</span> <span class=\"string\">print-message</span></span><br><span class=\"line\">        <span class=\"attr\">arguments:</span></span><br><span class=\"line\">          <span class=\"attr\">parameters:</span> [&#123;<span class=\"attr\">name:</span> <span class=\"string\">message</span>, <span class=\"attr\">value:</span> <span class=\"string\">&quot;Hello&quot;</span>&#125;]</span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">step2</span></span><br><span class=\"line\">        <span class=\"attr\">template:</span> <span class=\"string\">print-message</span></span><br><span class=\"line\">        <span class=\"attr\">arguments:</span></span><br><span class=\"line\">          <span class=\"attr\">parameters:</span> [&#123;<span class=\"attr\">name:</span> <span class=\"string\">message</span>, <span class=\"attr\">value:</span> <span class=\"string\">&quot;World&quot;</span>&#125;]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">print-message</span></span><br><span class=\"line\">    <span class=\"attr\">inputs:</span></span><br><span class=\"line\">      <span class=\"attr\">parameters:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">    <span class=\"attr\">container:</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">alpine:latest</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">echo</span>]</span><br><span class=\"line\">      <span class=\"attr\">args:</span> [<span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;inputs.parameters.message&#125;&#125;</span>&quot;</span>]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"DAG-Template\"><a href=\"#DAG-Template\" class=\"headerlink\" title=\"DAG Template\"></a><strong>DAG Template</strong></h3><ul>\n<li>使用有向无环图定义任务之间的依赖关系。</li>\n<li>适合并行和条件执行。</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Workflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">generateName:</span> <span class=\"string\">dag-example-</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">dag-example</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">dag-example</span></span><br><span class=\"line\">    <span class=\"attr\">dag:</span></span><br><span class=\"line\">      <span class=\"attr\">tasks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">A</span></span><br><span class=\"line\">        <span class=\"attr\">template:</span> <span class=\"string\">print-message</span></span><br><span class=\"line\">        <span class=\"attr\">arguments:</span></span><br><span class=\"line\">          <span class=\"attr\">parameters:</span> [&#123;<span class=\"attr\">name:</span> <span class=\"string\">message</span>, <span class=\"attr\">value:</span> <span class=\"string\">&quot;Task A&quot;</span>&#125;]</span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">B</span></span><br><span class=\"line\">        <span class=\"attr\">template:</span> <span class=\"string\">print-message</span></span><br><span class=\"line\">        <span class=\"attr\">dependencies:</span> [<span class=\"string\">A</span>]</span><br><span class=\"line\">        <span class=\"attr\">arguments:</span></span><br><span class=\"line\">          <span class=\"attr\">parameters:</span> [&#123;<span class=\"attr\">name:</span> <span class=\"string\">message</span>, <span class=\"attr\">value:</span> <span class=\"string\">&quot;Task B&quot;</span>&#125;]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">print-message</span></span><br><span class=\"line\">    <span class=\"attr\">inputs:</span></span><br><span class=\"line\">      <span class=\"attr\">parameters:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">    <span class=\"attr\">container:</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">alpine:latest</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">echo</span>]</span><br><span class=\"line\">      <span class=\"attr\">args:</span> [<span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;inputs.parameters.message&#125;&#125;</span>&quot;</span>]</span><br></pre></td></tr></table></figure>\n\n<p><strong>Resource Template</strong></p>\n<ul>\n<li>用于创建、更新、删除 Kubernetes 资源。</li>\n<li>适用于操作外部资源。</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Workflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">generateName:</span> <span class=\"string\">resource-example-</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">resource-example</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">resource-example</span></span><br><span class=\"line\">    <span class=\"attr\">resource:</span></span><br><span class=\"line\">      <span class=\"attr\">action:</span> <span class=\"string\">create</span></span><br><span class=\"line\">      <span class=\"attr\">manifest:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">        apiVersion: v1</span></span><br><span class=\"line\"><span class=\"string\">        kind: ConfigMap</span></span><br><span class=\"line\"><span class=\"string\">        metadata:</span></span><br><span class=\"line\"><span class=\"string\">          name: my-configmap</span></span><br><span class=\"line\"><span class=\"string\">        data:</span></span><br><span class=\"line\"><span class=\"string\">          key: value</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Suspend-Template\"><a href=\"#Suspend-Template\" class=\"headerlink\" title=\"Suspend Template\"></a><strong>Suspend Template</strong></h3><ul>\n<li>暂停工作流，等待手动恢复。</li>\n<li>适用于需要人工干预的步骤。</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">delay</span></span><br><span class=\"line\">  <span class=\"attr\">suspend:</span></span><br><span class=\"line\">    <span class=\"attr\">duration:</span> <span class=\"string\">&quot;20s&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"参数传递\"><a href=\"#参数传递\" class=\"headerlink\" title=\"参数传递\"></a>参数传递</h2><ul>\n<li>inputs：形参，申明该 template 需要使用哪些参数，可指定默认值</li>\n<li>arguments：实参，为对应 template 中的参数赋值，会覆盖 inputs 提供的默认值</li>\n</ul>\n<h4 id=\"inputs-形式参数\"><a href=\"#inputs-形式参数\" class=\"headerlink\" title=\"inputs 形式参数\"></a>inputs 形式参数</h4><figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">whalesay</span></span><br><span class=\"line\">    <span class=\"attr\">inputs:</span></span><br><span class=\"line\">      <span class=\"attr\">parameters:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">    <span class=\"attr\">container:</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">docker/whalesay</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">cowsay</span>]</span><br><span class=\"line\">      <span class=\"attr\">args:</span> [<span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;inputs.parameters.message&#125;&#125;</span>&quot;</span>] <span class=\"comment\"># 直接获取上面inputs的参数</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"arguments-全局参数\"><a href=\"#arguments-全局参数\" class=\"headerlink\" title=\"arguments 全局参数\"></a>arguments 全局参数</h4><figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">arguments:</span></span><br><span class=\"line\">  <span class=\"attr\">parameters:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span> <span class=\"comment\"># 下面引用&#123;&#123;workflow.parameters.message&#125;&#125;</span></span><br><span class=\"line\">    <span class=\"attr\">value:</span> <span class=\"string\">&quot;Hello from Workflow&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p><code>spec.arguments</code>用于定义要传递的全局参数，全局参数在当前 Workflow 下的所有 Template 中都可以使用，可以使用 <code>&#123;&#123;workflow.parameters.$name&#125;&#125;</code> 语法来引用。</p>\n<h1 id=\"WorkflowTemplate-1\"><a href=\"#WorkflowTemplate-1\" class=\"headerlink\" title=\"WorkflowTemplate\"></a>WorkflowTemplate</h1><p><code>WorkflowTemplate</code>就是 <code>Workflow </code>的定义，<code>WorkflowTemplate</code>描述了这个流水线的详细信息，包括有哪些任务，任务之间的先后顺序等等。</p>\n<p>在 Argo Workflows 中，工作流模板根据范围不同分为两种：<code>WorkflowTemplate</code> 和 <code>ClusterWorkflowTemplate</code>。</p>\n<h3 id=\"WorkflowTemplate-2\"><a href=\"#WorkflowTemplate-2\" class=\"headerlink\" title=\"WorkflowTemplate\"></a>WorkflowTemplate</h3><ul>\n<li><strong>范围</strong>：仅限于命名空间。</li>\n<li><strong>使用场景</strong>：适用于需要在同一命名空间内多次使用的模板。</li>\n<li><strong>引用</strong>：只能在创建它的命名空间中引用。</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">WorkflowTemplate</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">workflow-template-submittable</span> <span class=\"comment\">#WorkflowTemplate的名字</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">workflowMetadata:</span>\t<span class=\"comment\">#Template的元数据，由这个WorkflowTemplate创建的Workflow都会带有这个labels</span></span><br><span class=\"line\">    <span class=\"attr\">labels:</span></span><br><span class=\"line\">      <span class=\"attr\">dou:</span> <span class=\"string\">bao</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">whalesay-template</span> <span class=\"comment\">#入口模板的名字</span></span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">argo</span>\t<span class=\"comment\">#将来执行Workflow的sa账号</span></span><br><span class=\"line\">  <span class=\"attr\">arguments:</span>  <span class=\"comment\">#全局参数</span></span><br><span class=\"line\">    <span class=\"attr\">parameters:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">        <span class=\"attr\">value:</span> <span class=\"string\">wf-test-01</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">whalesay-template</span> <span class=\"comment\">#模板的名字，被入口引用</span></span><br><span class=\"line\">      <span class=\"attr\">inputs:</span></span><br><span class=\"line\">        <span class=\"attr\">parameters:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span> <span class=\"comment\">#模板的输入参数</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">twf-test-02</span></span><br><span class=\"line\">      <span class=\"attr\">container:</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">docker/whalesay</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span> [<span class=\"string\">cowsay</span>]</span><br><span class=\"line\">        <span class=\"attr\">args:</span> [<span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;inputs.parameters.message&#125;&#125;</span>&quot;</span>]\t<span class=\"comment\">#引用模板的入参</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ClusterWorkflowTemplate-1\"><a href=\"#ClusterWorkflowTemplate-1\" class=\"headerlink\" title=\"ClusterWorkflowTemplate\"></a>ClusterWorkflowTemplate</h3><ul>\n<li><strong>范围</strong>：集群范围。</li>\n<li><strong>使用场景</strong>：适用于需要跨多个命名空间共享的模板。</li>\n<li><strong>引用</strong>：可以在集群的任何命名空间中引用。</li>\n</ul>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterWorkflowTemplate</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cluster-workflow-template-submittable</span> <span class=\"comment\">#clusterWorkflowTemplate的名字</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">workflowMetadata:</span>\t<span class=\"comment\">#Template的元数据，由这个clusterWorkflowTemplate创建的Workflow都会带有这个labels</span></span><br><span class=\"line\">    <span class=\"attr\">labels:</span></span><br><span class=\"line\">      <span class=\"attr\">dou:</span> <span class=\"string\">bao</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">whalesay-template</span> <span class=\"comment\">#入口模板的名字</span></span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">argo</span>\t<span class=\"comment\">#将来执行Workflow的sa账号</span></span><br><span class=\"line\">  <span class=\"attr\">arguments:</span> <span class=\"comment\">#全局参数</span></span><br><span class=\"line\">    <span class=\"attr\">parameters:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">        <span class=\"attr\">value:</span> <span class=\"string\">wf-test-01</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">whalesay-template</span> <span class=\"comment\">#模板的名字，被入口引用</span></span><br><span class=\"line\">      <span class=\"attr\">inputs:</span></span><br><span class=\"line\">        <span class=\"attr\">parameters:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span> <span class=\"comment\">#模板的输入参数</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">twf-test-02</span></span><br><span class=\"line\">      <span class=\"attr\">container:</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">docker/whalesay</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span> [<span class=\"string\">cowsay</span>]</span><br><span class=\"line\">        <span class=\"attr\">args:</span> [<span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;inputs.parameters.message&#125;&#125;</span>&quot;</span>]\t<span class=\"comment\">#引用模板的入参</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"TemplateRef\"><a href=\"#TemplateRef\" class=\"headerlink\" title=\"TemplateRef\"></a>TemplateRef</h3><p>上面创建的 WorkflowTemplate 可以在 Workflow 中使用 TemplateRef 引用对应的模板，这样 Workflow 对象就会比较干净</p>\n<h4 id=\"workflowTemplateRef\"><a href=\"#workflowTemplateRef\" class=\"headerlink\" title=\"workflowTemplateRef\"></a>workflowTemplateRef</h4><p>引用完整的 WorkflowTemplate，Workflow 中只需要指定全局参数即可。<strong>Workflow</strong> <strong>和 WorkflowTemplate 需要在同一个命名空间</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Workflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">generateName:</span> <span class=\"string\">workflow-templateref-test-</span> <span class=\"comment\">#由于是动态的名字，kubectl apply无法使用，可以使用kubectl create</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">arguments:</span> <span class=\"comment\">#全局参数，如果写了就覆盖template中的，不写就用template默认的</span></span><br><span class=\"line\">    <span class=\"attr\">parameters:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">        <span class=\"attr\">value:</span> <span class=\"string\">&quot;i am from workflow&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">workflowTemplateRef:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">workflow-template-submittable</span> <span class=\"comment\">#引用上面的WorkflowTemplate的名字</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"clusterWorkflowTemplateRef\"><a href=\"#clusterWorkflowTemplateRef\" class=\"headerlink\" title=\"clusterWorkflowTemplateRef\"></a>clusterWorkflowTemplateRef</h4><p>与<code>workflowTemplateRef</code>类似，只需要增加 <code>clusterScope: true</code> 配置即可。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Workflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">generateName:</span> <span class=\"string\">cluster-workflow-template-ref-test-</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">whalesay</span></span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">argo</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">whalesay</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span>   <span class=\"comment\"># 执行步骤</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">run-whalesay</span></span><br><span class=\"line\">          <span class=\"attr\">templateRef:</span>   </span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">cluster-workflow-template-submittable</span>  <span class=\"comment\">#引用的模板名字</span></span><br><span class=\"line\">            <span class=\"attr\">template:</span> <span class=\"string\">whalesay-template</span> <span class=\"comment\"># 模板中的具体模板</span></span><br><span class=\"line\">            <span class=\"attr\">clusterScope:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 设置true来引用clustertemplate</span></span><br><span class=\"line\">          <span class=\"attr\">arguments:</span> <span class=\"comment\"># 全局参数，设置就覆盖template中的，不设置就用template中默认的</span></span><br><span class=\"line\">            <span class=\"attr\">parameters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&quot;hello cluster template&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"templateRef\"><a href=\"#templateRef\" class=\"headerlink\" title=\"templateRef\"></a>templateRef</h4><p>引用<code>WorkflowTemplate</code>中的某一个<code>template</code>。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Workflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">generateName:</span> <span class=\"string\">workflow-templateref-test-</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">whalesay</span></span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">argo</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">whalesay</span></span><br><span class=\"line\">    <span class=\"attr\">steps:</span>  <span class=\"comment\"># 执行步骤</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">call-whalesay-template</span></span><br><span class=\"line\">          <span class=\"attr\">templateRef:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">workflow-template-submittable</span> <span class=\"comment\"># 引用的模板</span></span><br><span class=\"line\">            <span class=\"attr\">template:</span> <span class=\"string\">whalesay-template</span>  <span class=\"comment\"># 模板中的具体模板</span></span><br><span class=\"line\">          <span class=\"attr\">arguments:</span>  <span class=\"comment\"># 全局参数，设置就覆盖template中的，不设置就用template中默认的</span></span><br><span class=\"line\">            <span class=\"attr\">parameters:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">&quot;hello whalesay template &quot;</span></span><br></pre></td></tr></table></figure>\n","categories":["argo"],"tags":["argo"]},{"title":"argo workflows触发方式","url":"/argo/argo-workflows-trigger-mode/","content":"<h1 id=\"定时触发\"><a href=\"#定时触发\" class=\"headerlink\" title=\"定时触发\"></a>定时触发</h1><p>类似于 k8s 中的 job 和 cronjob，CronWorkflow 会定时创建 Workflow 来实现定时触发。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">CronWorkflow</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">test-cron</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">workflowMetadata:</span> <span class=\"comment\">#元数据，由这个CronWorkflow创建的Workflow都会带有这个labels</span></span><br><span class=\"line\">    <span class=\"attr\">labels:</span></span><br><span class=\"line\">      <span class=\"attr\">dou:</span> <span class=\"string\">bao</span></span><br><span class=\"line\">  <span class=\"attr\">schedule:</span> <span class=\"string\">&quot;* * * * *&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">concurrencyPolicy:</span> <span class=\"string\">&quot;Replace&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">startingDeadlineSeconds:</span> <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">argo</span></span><br><span class=\"line\">  <span class=\"attr\">workflowSpec:</span></span><br><span class=\"line\">    <span class=\"attr\">entrypoint:</span> <span class=\"string\">whalesay</span></span><br><span class=\"line\">    <span class=\"attr\">templates:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">whalesay</span></span><br><span class=\"line\">      <span class=\"attr\">inputs:</span></span><br><span class=\"line\">        <span class=\"attr\">parameters:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span> <span class=\"comment\">#模板的输入参数</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">cron-test</span></span><br><span class=\"line\">      <span class=\"attr\">container:</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">docker/whalesay</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span> [<span class=\"string\">cowsay</span>]</span><br><span class=\"line\">        <span class=\"attr\">args:</span> [<span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;inputs.parameters.message&#125;&#125;</span>&quot;</span>]\t<span class=\"comment\">#引用模板的入参</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<p>yaml 内容据分析</p>\n<ul>\n<li>WorkflowSpec ：就是 Workflow 的 Spec。</li>\n<li>Cron Spec：一些 Cron 相关字段，<ul>\n<li>schedule：cron 表达式，<code>* * * * *</code> 每分钟创建一次</li>\n<li>concurrencyPolicy：并发模式，支持 Allow、Forbid、Replace<ul>\n<li>Allow：允许同时运行多个 Workflow</li>\n<li>Forbid：禁止并发，有 Workflow 运行时，就不会再创建新的</li>\n<li>Replace： 表示新创建 Workflow 替换掉旧的，不会同时运行多个 Workflow。</li>\n</ul>\n</li>\n<li>startingDeadlineSeconds：Workflow 创建出来到第一个 Pod 启动的最大时间，超时后就会被标记为失败。</li>\n<li>suspend：flag 是否停止 CronWorkflow，在定时任务不需要执行是可以设置为 true。</li>\n<li>timezone：时区，默认使用机器上的本地时间</li>\n</ul>\n</li>\n<li>WorkflowMetadata：元数据，由这个 CronWorkflow 创建的 Workflow 都会带有这个 labels</li>\n</ul>\n<h1 id=\"Event\"><a href=\"#Event\" class=\"headerlink\" title=\"Event\"></a>Event</h1><p>argo 提供了一个 Event API：<code>/api/v1/events/&#123;namespace&#125;/&#123;discriminator&#125;</code>,此 API 可以接受任意 json 数据。</p>\n<p>示例：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl https://localhost:2746/api/v1/events/argo/ \\</span><br><span class=\"line\">  -H <span class=\"string\">&quot;Authorization: <span class=\"variable\">$ARGO_TOKEN</span>&quot;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;message&quot;: &quot;hello&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>或者</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl https://localhost:2746/api/v1/events/argo/my-discriminator \\</span><br><span class=\"line\">  -H <span class=\"string\">&quot;Authorization: <span class=\"variable\">$ARGO_TOKEN</span>&quot;</span> \\</span><br><span class=\"line\">  -d <span class=\"string\">&#x27;&#123;&quot;message&quot;: &quot;hello&quot;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"创建-access-token\"><a href=\"#创建-access-token\" class=\"headerlink\" title=\"创建 access token\"></a>创建 access token</h2><p>新建一个 role</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl create role jenkins --verb=list,update --resource=workflows.argoproj.io</span><br></pre></td></tr></table></figure>\n\n<p>新建一个 sa 账号</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl create sa jenkins</span><br></pre></td></tr></table></figure>\n\n<p>绑定 role 和 sa 账号</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl create rolebinding jenkins --role=jenkins --serviceaccount=argo:jenkins -n argo</span><br></pre></td></tr></table></figure>\n\n<p>创建 access token</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f - &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: v1</span></span><br><span class=\"line\"><span class=\"string\">kind: Secret</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: jenkins.service-account-token</span></span><br><span class=\"line\"><span class=\"string\">  annotations:</span></span><br><span class=\"line\"><span class=\"string\">    kubernetes.io/service-account.name: jenkins</span></span><br><span class=\"line\"><span class=\"string\">type: kubernetes.io/service-account-token</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br></pre></td></tr></table></figure>\n\n<p>查看 token 信息</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~/argo/host-data# ARGO_TOKEN=<span class=\"string\">&quot;Bearer <span class=\"subst\">$(kubectl get secret jenkins.service-account-token -o=jsonpath=&#x27;&#123;.data.token&#125;&#x27; | base64 --decode)</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"variable\">$ARGO_TOKEN</span></span><br><span class=\"line\">Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6IjFDazhnZ2ozUU1nWGxoUGwtaTMzMGcwc183Q0JzSE5Mc0lUMS1FQmhJcmMifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImplbmtpbnMuc2VydmljZS1hY2NvdW50LXRva2VuIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImplbmtpbnMiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJiNTk2ZjAzOC01MmJlLTRjMmEtYjAzNi03YmNkNjQzMjMwYjQiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6ZGVmYXVsdDpqZW5raW5zIn0.do-IZT-k2-Hx8sk8_R-f8z5RKN0WGBGenYq-hyxszAGy7BXRIUpwdKqBGz48ZZOsJxBixfMjvdWEqeRTSJ870P8yJFHYOROA1exrcR8fWxjiC_VOqii9_bwKEA1z38zumuMpw3NopfZ-oqhRj9f2bucC2Gq3XypIRt5Zlnsb6__Vk8TQMO0rKnuELDNzqF1A6dgPU1ZGu_ZPRCwZNj_2r5bAnlId5mOnUDwCX8BydColtVn0J4GkmYefXRFVjW6C8PPy3lXneLBeofrWDggnsASd5A_J4Gb_gmuScq0GfKLR68QG4phOkFktUcLNUVhwWTVyy4hxNYAsHabSIxaKDw</span><br><span class=\"line\">root@devops:~/argo/host-data#</span><br></pre></td></tr></table></figure>\n\n<p>测试 access token 是否可用，-k 忽略 ssl 校验</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~/argo/host-data# curl https://192.168.121.210:30701/api/v1/workflow-event-bindings/default -k -H <span class=\"string\">&quot;Authorization: <span class=\"variable\">$ARGO_TOKEN</span>&quot;</span></span><br><span class=\"line\">&#123;<span class=\"string\">&quot;metadata&quot;</span>:&#123;<span class=\"string\">&quot;resourceVersion&quot;</span>:<span class=\"string\">&quot;655035&quot;</span>&#125;,<span class=\"string\">&quot;items&quot;</span>:null&#125;root@devops:~/argo/host-data#</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"WorkflowEventBinding\"><a href=\"#WorkflowEventBinding\" class=\"headerlink\" title=\"WorkflowEventBinding\"></a>WorkflowEventBinding</h2><p>为了接收 Event，可以创建 WorkflowEventBinding 对象</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">WorkflowEventBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">event-consumer</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">event:</span></span><br><span class=\"line\">    <span class=\"comment\"># metadata header name must be lowercase to match in selector</span></span><br><span class=\"line\">    <span class=\"attr\">selector:</span> <span class=\"string\">payload.message</span> <span class=\"type\">!=</span> <span class=\"string\">&quot;&quot;</span> <span class=\"string\">&amp;&amp;</span> <span class=\"string\">metadata[&quot;x-argo-e2e&quot;]</span> <span class=\"string\">==</span> [<span class=\"string\">&quot;true&quot;</span>] <span class=\"string\">&amp;&amp;</span> <span class=\"string\">discriminator</span> <span class=\"string\">==</span> <span class=\"string\">&quot;my-discriminator&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">submit:</span></span><br><span class=\"line\">    <span class=\"attr\">workflowTemplateRef:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">my-wf-tmple</span></span><br><span class=\"line\">    <span class=\"attr\">arguments:</span></span><br><span class=\"line\">      <span class=\"attr\">parameters:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">        <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">          <span class=\"attr\">event:</span> <span class=\"string\">payload.message</span></span><br></pre></td></tr></table></figure>\n\n<p>创建被引用的模板</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">WorkflowTemplate</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-wf-tmple</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">templates:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">main</span></span><br><span class=\"line\">      <span class=\"attr\">inputs:</span></span><br><span class=\"line\">        <span class=\"attr\">parameters:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">message</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;workflow.parameters.message&#125;&#125;</span>&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">container:</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">docker/whalesay:latest</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span> [<span class=\"string\">cowsay</span>]</span><br><span class=\"line\">        <span class=\"attr\">args:</span> [<span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;inputs.parameters.message&#125;&#125;</span>&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">entrypoint:</span> <span class=\"string\">main</span></span><br></pre></td></tr></table></figure>\n\n<p>测试 api 触发 event 来触发 workflow</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~/argo/host-data# curl https://192.168.121.210:30701/api/v1/events/argo/my-discriminator \\</span><br><span class=\"line\">    -H <span class=\"string\">&quot;Authorization: <span class=\"variable\">$ARGO_TOKEN</span>&quot;</span> \\</span><br><span class=\"line\">    -H <span class=\"string\">&quot;X-Argo-E2E: true&quot;</span> \\</span><br><span class=\"line\">    -k \\</span><br><span class=\"line\">    -d <span class=\"string\">&#x27;&#123;&quot;message&quot;: &quot;hello events&quot;&#125;&#x27;</span></span><br><span class=\"line\">&#123;&#125;root@devops:~/argo/host-datakubectl get workflow -n argo |grep my</span><br><span class=\"line\">my-wf-tmple-4ynl1                             Running     6s</span><br><span class=\"line\">my-wf-tmple-84vly                             Succeeded   60s</span><br><span class=\"line\">my-wf-tmple-w7udm                             Succeeded   96s</span><br><span class=\"line\">root@devops:~/argo/host-data#</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Webhook\"><a href=\"#Webhook\" class=\"headerlink\" title=\"Webhook\"></a>Webhook</h1><p>Event 可以通过发送 HTTP 请求的方式来触发 Workflow，但是需要客户端提供 AuthToken。</p>\n<p>但是 Github、Gitlab 等 Git 仓库配置 Webhook 触发的 hook 是没有 token 的，因此需要额外配置来进行验证，保证 argo 只处理来自 Github、Gitlab 等等平台的 Webhook 请求。</p>\n<ul>\n<li>1）创建 RBAC 相关对象,role、rolebinding、sa 准备好 token</li>\n<li>2）配置 Webhook-clients，告诉 argo 什么类型的 Webhook 过来使用那个 secret 作为 token</li>\n</ul>\n<h2 id=\"webhook-clients-config\"><a href=\"#webhook-clients-config\" class=\"headerlink\" title=\"webhook-clients config\"></a>webhook-clients config</h2><p>新建一个<code>Secret</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">argo-workflows-webhook-clients</span></span><br><span class=\"line\"><span class=\"comment\"># The data keys must be the name of a service account.</span></span><br><span class=\"line\"><span class=\"attr\">stringData:</span></span><br><span class=\"line\">  <span class=\"comment\"># https://support.atlassian.com/bitbucket-cloud/docs/manage-webhooks/</span></span><br><span class=\"line\">  <span class=\"attr\">bitbucket.org:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    type: bitbucket</span></span><br><span class=\"line\"><span class=\"string\">    secret: &quot;my-uuid&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span>  <span class=\"comment\"># https://confluence.atlassian.com/bitbucketserver/managing-webhooks-in-bitbucket-server-938025878.html</span></span><br><span class=\"line\">  <span class=\"attr\">bitbucketserver:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    type: bitbucketserver</span></span><br><span class=\"line\"><span class=\"string\">    secret: &quot;shh!&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span>  <span class=\"comment\"># https://developer.github.com/webhooks/securing/</span></span><br><span class=\"line\">  <span class=\"attr\">github.com:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    type: github</span></span><br><span class=\"line\"><span class=\"string\">    secret: &quot;shh!&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span>  <span class=\"comment\"># https://docs.gitlab.com/ee/user/project/integrations/webhooks.html</span></span><br><span class=\"line\">  <span class=\"attr\">gitlab.com:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    type: gitlab</span></span><br><span class=\"line\"><span class=\"string\">    secret: &quot;shh!&quot;</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>其中 Key 必须是当前 Namespace 下的 Serviceaccount 名称。</li>\n<li>Value 则包含 type 和 secret 两部分。<ul>\n<li>type：Webhook 来源，比如 github、gitlab</li>\n<li>secret：一个字符串，非 k8s secret，一般在对应平台添加 Webhook 时进行配置</li>\n</ul>\n</li>\n</ul>\n<p>以 Github 具体，secret 配置如下：</p>\n<p>在添加 Webhook 时可以填一个 Secret 配置，实际就是一串加密字符，随便填什么都可以。</p>\n<p>这样 Github 发送 Webhook 请求时就会携带上这个 Secret 信息，Argo 收到后就根据<code>argo-workflows-webhook-clients</code> 的 Secret 里配置的 type&#x3D;github 的 secret 字段进行对比，如果匹配上就处理，否则就忽略该请求。</p>\n<p>如果能匹配上就从对应的 Serviceaccount 中解析 Token 作为 Authorization 信息。</p>\n<p><img src=\"/argo/argo-workflows-trigger-mode/image-20240810180437311.png\" alt=\"image-20240810180437311\"></p>\n","categories":["argo"],"tags":["argo"]},{"title":"安装argo cd","url":"/argo/argocd-install/","content":"<h2 id=\"安装部署\"><a href=\"#安装部署\" class=\"headerlink\" title=\"安装部署\"></a>安装部署</h2><p>新建命名空间并部署项目资源</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl create namespace argocd</span><br><span class=\"line\">kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"暴露服务\"><a href=\"#暴露服务\" class=\"headerlink\" title=\"暴露服务\"></a>暴露服务</h2><p>默认情况下， Argo CD 服务不对外暴露服务，可以通过 LoadBalancer 或者 NodePort 类型的 Service、Ingress、Kubectl 端口转发等方式将 Argo CD 服务发布到 Kubernetes 集群外部。</p>\n<p>由于是 vm 自建，所以选择使用 NodePort 的方式暴露服务。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl patch svc argocd-server -n argocd -p <span class=\"string\">&#x27;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>查看随机暴露的端口</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~# kubectl get svc -n argocd</span><br><span class=\"line\">NAME                                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class=\"line\">argocd-applicationset-controller          ClusterIP   10.43.49.182    &lt;none&gt;        7000/TCP,8080/TCP            78m</span><br><span class=\"line\">argocd-dex-server                         ClusterIP   10.43.155.32    &lt;none&gt;        5556/TCP,5557/TCP,5558/TCP   78m</span><br><span class=\"line\">argocd-metrics                            ClusterIP   10.43.241.106   &lt;none&gt;        8082/TCP                     78m</span><br><span class=\"line\">argocd-notifications-controller-metrics   ClusterIP   10.43.239.240   &lt;none&gt;        9001/TCP                     78m</span><br><span class=\"line\">argocd-redis                              ClusterIP   10.43.37.52     &lt;none&gt;        6379/TCP                     78m</span><br><span class=\"line\">argocd-repo-server                        ClusterIP   10.43.79.21     &lt;none&gt;        8081/TCP,8084/TCP            78m</span><br><span class=\"line\">argocd-server                             NodePort    10.43.65.157    &lt;none&gt;        80:32221/TCP,443:31046/TCP   78m</span><br><span class=\"line\">argocd-server-metrics                     ClusterIP   10.43.235.50    &lt;none&gt;        8083/TCP                     78m</span><br><span class=\"line\">root@devops:~#</span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<h2 id=\"访问-UI\"><a href=\"#访问-UI\" class=\"headerlink\" title=\"访问 UI\"></a>访问 UI</h2><p>使用 node:31046 访问</p>\n<p><img src=\"/argo/argocd-install/image-20240708103122048.png\" alt=\"image-20240708103122048\"></p>\n<h2 id=\"添加-git-仓库\"><a href=\"#添加-git-仓库\" class=\"headerlink\" title=\"添加 git 仓库\"></a>添加 git 仓库</h2><p>因为本机 vm 访问 git 不通，所以选择 gitlab，使用 ui 添加也可以使用命令行添加</p>\n<p><img src=\"/argo/argocd-install/image-20240825160336188.png\" alt=\"image-20240825160336188.png\"></p>\n<h2 id=\"添加-app\"><a href=\"#添加-app\" class=\"headerlink\" title=\"添加 app\"></a>添加 app</h2><h3 id=\"使用-argo-cli-创建\"><a href=\"#使用-argo-cli-创建\" class=\"headerlink\" title=\"使用 argo cli 创建\"></a>使用 argo cli 创建</h3><figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">argocd app create myapp \\</span><br><span class=\"line\">--repo https://gitlab.com/doubao2/doubao.git \\</span><br><span class=\"line\">--path nginx --dest-server \\</span><br><span class=\"line\">https://kubernetes.default.svc \\</span><br><span class=\"line\">--dest-namespace doubao</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用-yaml-创建\"><a href=\"#使用-yaml-创建\" class=\"headerlink\" title=\"使用 yaml 创建\"></a>使用 yaml 创建</h3><figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">argoproj.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Application</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">argocd</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">destination:</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">doubao</span> <span class=\"comment\"># 部署应用的命名空间</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"string\">https://kubernetes.default.svc</span> <span class=\"comment\"># API Server 地址</span></span><br><span class=\"line\">  <span class=\"attr\">project:</span> <span class=\"string\">default</span> <span class=\"comment\"># 项目名</span></span><br><span class=\"line\">  <span class=\"attr\">source:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">nginx</span> <span class=\"comment\"># 资源文件路径</span></span><br><span class=\"line\">    <span class=\"attr\">repoURL:</span> <span class=\"string\">https://gitlab.com/douba0/argo-cd-poc.git</span> <span class=\"comment\"># Git 仓库地址</span></span><br><span class=\"line\">    <span class=\"attr\">targetRevision:</span> <span class=\"string\">main</span> <span class=\"comment\"># 分支名</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用-ui-创建\"><a href=\"#使用-ui-创建\" class=\"headerlink\" title=\"使用 ui 创建\"></a>使用 ui 创建</h3><p>添加对应的参数<br><img src=\"/argo/argocd-install/image-20240825160538368.png\" alt=\"image-20240825160538368.png\"></p>\n<h2 id=\"手动同步-gitlab-配置\"><a href=\"#手动同步-gitlab-配置\" class=\"headerlink\" title=\"手动同步 gitlab 配置\"></a>手动同步 gitlab 配置</h2><p><img src=\"/argo/argocd-install/image-20240825161747562.png\" alt=\"argocd-install/image-20240825161747562.png\"></p>\n<h2 id=\"发布和回滚\"><a href=\"#发布和回滚\" class=\"headerlink\" title=\"发布和回滚\"></a>发布和回滚</h2><p>手动同步 gitlab 配置后，可以看到详细的部署信息，并且可以进行版本的发布和回滚的管理</p>\n<p><img src=\"/argo/argocd-install/image-20240825161830895.png\" alt=\"image-20240825161830895.png\"></p>\n<h2 id=\"自定义配置\"><a href=\"#自定义配置\" class=\"headerlink\" title=\"自定义配置\"></a>自定义配置</h2><p>Argocd 在自动部署的时候，会自动给资源添加 labels。默认值是<code>app.kubernetes.io/instance: $name</code>，可以在 argocd-cm 中设置 labels 的 key。</p>\n<p><a href=\"https://argo-cd.readthedocs.io/en/stable/operator-manual/argocd-cm-yaml/https://argo-cd.readthedocs.io/en/stable/operator-manual/argocd-cm-yaml/\">argocd-cm 官方样例</a></p>\n<p>由于自动添加 labels 会导致 Kustomization 编排的资源会被覆盖 labels，这样会导致不同 app 引用相同的 configmap 后，会出现 OutOfSync 的问题。</p>\n<p>由于目前没有禁止自动添加 labels 的功能和配置，但是可以自定义忽略不同的资源信息。所以曲线救国可以直接忽略掉这个 labels 的变更，这样 argocd 在 sync 后就不会出现 OutOfSync 了。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">argocd-cm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/part-of:</span> <span class=\"string\">argocd</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">argocd-cm</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">argocd</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">resource.customizations.ignoreDifferences.all:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    managedFieldsManagers:</span></span><br><span class=\"line\"><span class=\"string\">    - kube-controller-manager</span></span><br><span class=\"line\"><span class=\"string\">    jsonPointers:</span></span><br><span class=\"line\"><span class=\"string\">    - /metadata/labels/app.kubernetes.io~1instance</span></span><br></pre></td></tr></table></figure>\n","categories":["argo"],"tags":["argo"]},{"title":"sealed-secrets","url":"/argo/sealed-secrets-install/","content":"<h1 id=\"安装-Controller\"><a href=\"#安装-Controller\" class=\"headerlink\" title=\"安装 Controller\"></a>安装 Controller</h1><p>部署项目资源</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.27.0/controller.yaml</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"安装二进制命令\"><a href=\"#安装二进制命令\" class=\"headerlink\" title=\"安装二进制命令\"></a>安装二进制命令</h1><p>安装目前最新版本<code>0.27.1</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">KUBESEAL_VERSION=<span class=\"string\">&#x27;0.27.1&#x27;</span> <span class=\"comment\"># Set this to, for example, KUBESEAL_VERSION=&#x27;0.23.0&#x27;</span></span><br><span class=\"line\">curl -OL <span class=\"string\">&quot;https://github.com/bitnami-labs/sealed-secrets/releases/download/v<span class=\"variable\">$&#123;KUBESEAL_VERSION:?&#125;</span>/kubeseal-<span class=\"variable\">$&#123;KUBESEAL_VERSION:?&#125;</span>-linux-amd64.tar.gz&quot;</span></span><br><span class=\"line\">tar -xvzf kubeseal-<span class=\"variable\">$&#123;KUBESEAL_VERSION:?&#125;</span>-linux-amd64.tar.gz kubeseal</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> install -m 755 kubeseal /usr/local/bin/kubeseal</span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<h1 id=\"加密现有的-secret\"><a href=\"#加密现有的-secret\" class=\"headerlink\" title=\"加密现有的 secret\"></a>加密现有的 secret</h1><p>现有的 secret 的配置文件</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">secret-data</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">Opaque</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">username:</span> <span class=\"string\">&#x27;YWRtaW4=&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">password:</span> <span class=\"string\">&#x27;MWYyZDFlMmU2N2Rm&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>使用<code>kubeseal</code>加密 secret</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">kubeseal &lt; secret.yaml &gt; sealed-secret.yaml -n doubao</span><br></pre></td></tr></table></figure>\n\n<p>加密后的 sealed-secret.yaml</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;kind&quot;:</span> <span class=\"string\">&quot;SealedSecret&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;apiVersion&quot;:</span> <span class=\"string\">&quot;bitnami.com/v1alpha1&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;metadata&quot;:</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;name&quot;:</span> <span class=\"string\">&quot;secret-data&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;namespace&quot;:</span> <span class=\"string\">&quot;doubao&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;creationTimestamp&quot;:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">&quot;spec&quot;:</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;template&quot;:</span> &#123;</span><br><span class=\"line\">      <span class=\"attr\">&quot;metadata&quot;:</span> &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;name&quot;:</span> <span class=\"string\">&quot;secret-data&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;namespace&quot;:</span> <span class=\"string\">&quot;doubao&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;creationTimestamp&quot;:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"attr\">&quot;type&quot;:</span> <span class=\"string\">&quot;Opaque&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"attr\">&quot;encryptedData&quot;:</span> &#123;</span><br><span class=\"line\">      <span class=\"attr\">&quot;password&quot;:</span> <span class=\"string\">&quot;AgBeGhg/QichjPxn1IiFNp07imo3srzor8eiXkm9KKQcB3KHVMza1QId1JlJNLntrA7J+9dX78TbIZ8b3ioqfGInZPe89PhN4BBS0RZDLarn6+Lh3Yl9g4e+EA+7bNVkm8Sk1iEABO5cTJ3VW2rZiIBp0ENl62LBPhR9BYvQLiN0T/e8LCgVOs9nzByjXjDdxRL1R6jhLIpVhyvTQ7hzy6c348EJlxU/3/mX+efMnAiwZpiF0b/OJThW8Yg3CuKicNaK/zhBLt7QwZ33oqA9EnD2px+LPQnPNUXJW6mM+g/vszJMoEFhQJRev5ghZwkDeya/5lOaPCvMG31cYKShvqLGbW31+csWimMbXmom31sDTnp8j+BBji+1hnfkCC5cjE8RVrUPcc6Mhv/JBxkjVxuzJblfH+qHdr+7LTvMXPw7sgfTtQedb4pQ77wk6FWaIXMs8pud92UFaubF2+XTERKkPLik5b6sRX33Cc+quUfg2kxnUCnX+qmMXl6YleFw8j8uBLMH+NREHzVPLmAQmbf5xUD5Opi1cID2ySVfNNI+vEhMCNh1DtXy5WhFUS0Qy+lknmLW/V+IGKDVXD19wxL9OK9ClfSmWjRVinL5Wez9fIiPLvry3L69cavzd3OJDAWQoOCkGRKNXLt5YyW/cnR2Dz9IiRs3/I8PfrAewqmEU1nwyHAuWOo3JpoXrWI/9l9Ny75mjvgK2NZPf9I=&quot;</span>,</span><br><span class=\"line\">      <span class=\"attr\">&quot;username&quot;:</span> <span class=\"string\">&quot;AgC59C1VoIEqqimk9iiyeGULkW9aYKG4oacXXGPY0K1+Nd2q0U9fC1N5emnrjV7pRaCH3VdCgvOMyHSBnNv5Xk2ZtNRRlBdjhJoABhixvTrxPz2Q9Fk2pApZriZ51jGeVH6XtOwrKfCB1SrTHjC5Y5A9ZXB3NkQmOX0bKVZVAKD/Vg2Y7ZZxvi/ZmL6WbBYWypneb3x5Tgn6d+POIsD6qURw0xEwmeneNlZDqmGraBW0y5Ry4bYfIqG7ra/ukMqMaKj9eBL3ROSNKPPCXFpI8sLt6BxUjJ7dlPo5b787yXYzhQl8skIb7WtPSuiBms/fKqrIEklNCI/enReHDJezS6nNOkjA/wWgcfwkcyuBOrqkJUp2YToXX1QJivmeQGHjBiM6Y271skkv7D+F+B2qT6ZjZ5SgSbECuAzsp7UxO79KsAOTzBzYIk70NkWxKUT+VunMABxVZz5dCOtxVa0eq050X7pzEp1i7fZ4PLupNwz6rJvNopgIKopQo4dxNo2szD9Lwvd6sQRdl0X8la2ShNX83Zwprlv/UBd+4dPlteGFrrq1xKSXW7K7mXFYYJDoJBmGiZYwUmSaVvIErwYoC1AmVUCxp97GcpEV0ndyK+o9zAL5NAnVPSa/jxlcTWAqHF9ssXM4095RR1L85V0v9+URZ1ngoeRnkrWownF34RYWoqZArwj0DGgHI3NmQs+C7jq2EqppWw==&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"应用到集群中\"><a href=\"#应用到集群中\" class=\"headerlink\" title=\"应用到集群中\"></a>应用到集群中</h1><p>当 apply 后，<code>SealedSecret</code>会帮忙管理原有的 secret，如果想查看原值，可以在 k8s 集群中查看。</p>\n<p><code>SealedSecret</code>加密后的密文，可以提交到 git 上，因为加解密都在 k8s 集群中的 SealedSecret Controller 中执行。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~/argo# kubeseal &lt; secret.yaml &gt; sealed-secret.yaml -n doubao</span><br><span class=\"line\">root@devops:~/argo# <span class=\"built_in\">cat</span> sealed-secret.yaml</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;kind&quot;</span>: <span class=\"string\">&quot;SealedSecret&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;apiVersion&quot;</span>: <span class=\"string\">&quot;bitnami.com/v1alpha1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;metadata&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;secret-data&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;namespace&quot;</span>: <span class=\"string\">&quot;doubao&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;creationTimestamp&quot;</span>: null</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;spec&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;template&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;metadata&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;secret-data&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;namespace&quot;</span>: <span class=\"string\">&quot;doubao&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;creationTimestamp&quot;</span>: null</span><br><span class=\"line\">      &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;type&quot;</span>: <span class=\"string\">&quot;Opaque&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;encryptedData&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;password&quot;</span>: <span class=\"string\">&quot;AgAOcZC6+c6tpm0g0+DDVYNOF2Qzy+PoEhJahpFoJncgCH7WYTmGW3PgygT9YlveVoC3gft4BsFHsCmB8m9Q/Dph4dkQWwcS8LtcEk5Zbtt0aeFyHD6LFGaKt7DB9N7XsF3HDu1RxEbTlEsalzIvTgoG3wovk3WimkrWaidIa2a4TY+lXgfjoKEG6ci9c4tUdFHPgTVuBxHTrgASnUjY535Gy06KyBRCEz42l7D+J7uUXOFC+FKkMqmSjN0g/uJTErMRg0oacqY4XprP6HKt7ugHtBrHOZgvrEhULbQOsTi9D/ZdXBwgWQDor8TqjI3yGvSkNC9/DJA0IEQc/xft2/YK+SZy1MbCeOTUXDIsQFAiI+BA39b3ZjIKjDtw78OqwNqU5KcHzPzpAzKjvqS3Q+vl6LPPhZMus05wNILgo3T5sq1kqc7ZHduIPCkleCxNJI9rh/dQM+Cj7hlGRjC3NYIOSW8L2vyC1gwAJ/esq6Ric2h4x8yeYZFDZrozDRtYNXF0+TgAZJsgQ+GzHrc6w8YsslFrmokwg89vAKNzYw+uPlBYFHMaYR+cU11baMROs0l35RRVP9MUc2YVpPOwVwJDjv5p74ua2bSMs9wz4vaIyCytwApsxQzvPWc+oHFJ8Wp0ZD1C8oiC5hHefhIfu0nADBvK87ZnE5NrHp4AFaeywAlT4npMdqPhmrT1CY6UUaBwWNy2qTc3g4OYpbs=&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;username&quot;</span>: <span class=\"string\">&quot;AgBufp8vfJpJ/IdXs3z4Etxi7mKt1s6dNjvXxBcdE2If6X1mzDjm78jbu+1yxo1d/yTdv28uibTghQlIBHRNa6uQlWxz+Nl6UBIKBm7yYlXZYvmC/cqbzNw28SbuEwhUGKycznz5+M81Aj+kQMLCgLGvCD7qCgOf2G5fljb6/z0icGIjlWnMX3wZ/en66mgik91tCZaHrd01EW1uAcywY075y7tGf4N7sIhn3USkFOpPAuowUYWSYSEvEUbmZ1HXj/h3eVU7E6lbc28RepqsYZLasLRdSdmQmZZjaQoynQ47vgOwI+IrN0DlwqffHX4cyiGSeZXNvD6ORmoEaJwlr/uL9O67MktdysjQSdHlkZdW4yL2Foftmr7o9893/Ut6FOHy2qATGhmVRjC+IwxM5r/iizJuxov30+GuOu2KAXhRfjsHMs6nKFv+j8iXlA24qPjh5Y/aa3nopAzuojWHoDhCJgFS9z+hH1UdSifw8N4V5/mAM3v2MUGWtMLelLNtrgKwt24lNULfGZCp4D9e00ANpwSccGMm0WukvxzWrBhCfDP+tatnqts6XlRjUeV1wfy2j2xTRuuDhx5a5wS30rWa7Ij5xtI3/1MFv24qeWFn6TG7aIYzkV2n04GO5ruc3M/wfzZDX/kRHaujJwo7yqE3BNujN2uYyHSuYwPOgbJceVlFb9txjuy2GRZvBWT6gtRCCocE5A==&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">root@devops:~/argo# kubectl apply -f sealed-secret.yaml -n doubao</span><br><span class=\"line\">sealedsecret.bitnami.com/secret-data configured</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"查看-pod-中引用结果\"><a href=\"#查看-pod-中引用结果\" class=\"headerlink\" title=\"查看 pod 中引用结果\"></a>查看 pod 中引用结果</h1><figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~/k8s# kubectl get po -n doubao</span><br><span class=\"line\">NAME                     READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">nginx-d56bbf567-s94bw    1/1     Running   0          14h</span><br><span class=\"line\">redis-6b5f9c8866-hdlmc   1/1     Running   0          14h</span><br><span class=\"line\">root@devops:~/k8s# kubectl <span class=\"built_in\">exec</span> -it -n doubao redis-6b5f9c8866-hdlmc  bash -- <span class=\"built_in\">env</span>|grep -E <span class=\"string\">&#x27;user|pass&#x27;</span></span><br><span class=\"line\">password=1f2d1e2e67df</span><br><span class=\"line\">username=admin</span><br><span class=\"line\">root@devops:~/k8s#</span><br></pre></td></tr></table></figure>\n","categories":["argo"],"tags":["argo"]},{"title":"buildkit","url":"/docker/buildkit/","content":"<h2 id=\"安装-buildkit\"><a href=\"#安装-buildkit\" class=\"headerlink\" title=\"安装 buildkit\"></a>安装 buildkit</h2><figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">wget https://github.com/moby/buildkit/releases/download/v0.15.1/buildkit-v0.15.1.linux-amd64.tar.gz</span><br><span class=\"line\">tar zxvf  buildkit-v0.15.1.linux-amd64.tar.gz</span><br><span class=\"line\"><span class=\"built_in\">mv</span> ./bin/* /usr/local/bin</span><br></pre></td></tr></table></figure>\n\n<p>启动<code>buildkitd</code>服务，使用<code>--oci-worker=false --containerd-worker=true</code>参数,可以让 buildkitd 服务使用 containerd 后端</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">buildkitd --oci-worker=false --containerd-worker=true &amp;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"使用\"><a href=\"#使用\" class=\"headerlink\" title=\"使用\"></a>使用</h2><p><code>dockerfile</code></p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> dockerhub.qingcloud.com/doubao/nginx</span><br><span class=\"line\"><span class=\"keyword\">LABEL</span><span class=\"language-bash\"> doubao=cute</span></span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<p>构建镜像</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~/data# buildctl build \\</span><br><span class=\"line\">    --frontend=dockerfile.v0 \\</span><br><span class=\"line\">    --<span class=\"built_in\">local</span> context=. \\</span><br><span class=\"line\">    --<span class=\"built_in\">local</span> dockerfile=. \\</span><br><span class=\"line\">    --output <span class=\"built_in\">type</span>=image,name=dockerhub.qingcloud.com/doubao/nginx:doubao</span><br><span class=\"line\">[+] Building 0.5s (6/6) FINISHED</span><br><span class=\"line\"> =&gt; [internal] load build definition from Dockerfile                                                                                                                                                                                                                                    0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring dockerfile: 97B                                                                                                                                                                                                                                                     0.0s</span><br><span class=\"line\"> =&gt; [internal] load metadata <span class=\"keyword\">for</span> dockerhub.qingcloud.com/doubao/nginx:latest                                                                                                                                                                                                            0.3s</span><br><span class=\"line\"> =&gt; [auth] doubao/nginx:pull token <span class=\"keyword\">for</span> dockerhub.qingcloud.com                                                                                                                                                                                                                          0.0s</span><br><span class=\"line\"> =&gt; [internal] load .dockerignore                                                                                                                                                                                                                                                       0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring context: 2B                                                                                                                                                                                                                                                         0.0s</span><br><span class=\"line\"> =&gt; CACHED [1/1] FROM dockerhub.qingcloud.com/doubao/nginx:latest@sha256:c94f3436f3bfcb467e9723bdb4957e2e86c00cc5f21e38a40d668c1a4c324696                                                                                                                                               0.0s</span><br><span class=\"line\"> =&gt; =&gt; resolve dockerhub.qingcloud.com/doubao/nginx:latest@sha256:c94f3436f3bfcb467e9723bdb4957e2e86c00cc5f21e38a40d668c1a4c324696                                                                                                                                                      0.0s</span><br><span class=\"line\"> =&gt; exporting to image                                                                                                                                                                                                                                                                  0.0s</span><br><span class=\"line\"> =&gt; =&gt; exporting layers                                                                                                                                                                                                                                                                 0.0s</span><br><span class=\"line\"> =&gt; =&gt; exporting manifest sha256:1fee4f91e595af322b8aaf7b3d74a1de6de0e12798097631b1e2fc063a3818dc                                                                                                                                                                                       0.0s</span><br><span class=\"line\"> =&gt; =&gt; exporting config sha256:70fddb68d1e838d671f94e3c579b75e81d6e4717fc25e3c8decec405cf3b7f67                                                                                                                                                                                         0.0s</span><br><span class=\"line\"> =&gt; =&gt; naming to dockerhub.qingcloud.com/doubao/nginx:doubao</span><br></pre></td></tr></table></figure>\n\n<p>查看本地镜像，这个<code>docker</code>无法查看到，可以使用<code>ctr</code>来查看，<code>ctr</code>是有<code>namespace</code>概念的</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~/data# ctr -n buildkit i <span class=\"built_in\">ls</span></span><br><span class=\"line\">REF                                         TYPE                                                 DIGEST                                                                  SIZE     PLATFORMS   LABELS</span><br><span class=\"line\">dockerhub.qingcloud.com/doubao/nginx:doubao application/vnd.docker.distribution.manifest.v2+json sha256:1fee4f91e595af322b8aaf7b3d74a1de6de0e12798097631b1e2fc063a3818dc 67.7 MiB linux/amd64 -</span><br><span class=\"line\">root@devops:~/data#</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>推送到远程仓库里面</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~/data# ctr -n buildkit i push -u username:password dockerhub.qingcloud.com/doubao/nginx:doubao</span><br><span class=\"line\">manifest-sha256:1fee4f91e595af322b8aaf7b3d74a1de6de0e12798097631b1e2fc063a3818dc: <span class=\"keyword\">done</span>           |++++++++++++++++++++++++++++++++++++++|</span><br><span class=\"line\">config-sha256:70fddb68d1e838d671f94e3c579b75e81d6e4717fc25e3c8decec405cf3b7f67:   <span class=\"keyword\">done</span>           |++++++++++++++++++++++++++++++++++++++|</span><br><span class=\"line\">elapsed: 2.4 s                                                                    total:  8.9 Ki (3.7 KiB/s)</span><br><span class=\"line\">root@devops:~/data#</span><br></pre></td></tr></table></figure>\n","categories":["docker"],"tags":["docker"]},{"title":"Docker in Docker","url":"/docker/docker%20in%20docker/","content":"<h1 id=\"Docker-in-Docker-DinD-深入解析\"><a href=\"#Docker-in-Docker-DinD-深入解析\" class=\"headerlink\" title=\"Docker in Docker (DinD) 深入解析\"></a>Docker in Docker (DinD) 深入解析</h1><p>Docker 技术在现代软件开发中已经成为一种标准，尤其是在微服务架构和持续集成&#x2F;持续部署（CI&#x2F;CD）流程中。随着 Docker 的普及，开发者们开始探索在容器内部运行 Docker 的能力，这种技术被称为 Docker in Docker（DinD）。</p>\n<h1 id=\"什么是-Docker-in-Docker？\"><a href=\"#什么是-Docker-in-Docker？\" class=\"headerlink\" title=\"什么是 Docker in Docker？\"></a>什么是 Docker in Docker？</h1><p>Docker in Docker 是指在一个 Docker 容器内部运行 Docker 守护进程的技术。这意味着你可以在一个容器中创建、管理和操作其他 Docker 容器。这种模式通常用于 CI&#x2F;CD 流程中，允许在隔离环境中构建和测试应用程序。</p>\n<h2 id=\"DinD-的实现方式\"><a href=\"#DinD-的实现方式\" class=\"headerlink\" title=\"DinD 的实现方式\"></a>DinD 的实现方式</h2><h3 id=\"1-直接挂载-Docker-sock\"><a href=\"#1-直接挂载-Docker-sock\" class=\"headerlink\" title=\"1. 直接挂载 Docker.sock\"></a>1. 直接挂载 Docker.sock</h3><p>最简单的实现方式是将宿主机的 Docker 套接字（<code>/var/run/docker.sock</code>）挂载到容器中，这样容器内的应用可以直接与宿主机的 Docker 守护进程进行交互。</p>\n<span id=\"more\"></span>\n\n<h4 id=\"验证\"><a href=\"#验证\" class=\"headerlink\" title=\"验证\"></a>验证</h4><figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~# docker run -it --<span class=\"built_in\">rm</span> -v /var/run/docker.sock:/var/run/docker.sock docker:latest sh</span><br><span class=\"line\">/ <span class=\"comment\"># docker run hello-world</span></span><br><span class=\"line\">Unable to find image <span class=\"string\">&#x27;hello-world:latest&#x27;</span> locally</span><br><span class=\"line\">latest: Pulling from library/hello-world</span><br><span class=\"line\">c1ec31eb5944: Pull complete</span><br><span class=\"line\">Digest: sha256:1408fec50309afee38f3535383f5b09419e6dc0925bc69891e79d84cc4cdcec6</span><br><span class=\"line\">Status: Downloaded newer image <span class=\"keyword\">for</span> hello-world:latest</span><br><span class=\"line\"></span><br><span class=\"line\">Hello from Docker!</span><br><span class=\"line\">This message shows that your installation appears to be working correctly.</span><br><span class=\"line\"></span><br><span class=\"line\">To generate this message, Docker took the following steps:</span><br><span class=\"line\"> 1. The Docker client contacted the Docker daemon.</span><br><span class=\"line\"> 2. The Docker daemon pulled the <span class=\"string\">&quot;hello-world&quot;</span> image from the Docker Hub.</span><br><span class=\"line\">    (amd64)</span><br><span class=\"line\"> 3. The Docker daemon created a new container from that image <span class=\"built_in\">which</span> runs the</span><br><span class=\"line\">    executable that produces the output you are currently reading.</span><br><span class=\"line\"> 4. The Docker daemon streamed that output to the Docker client, <span class=\"built_in\">which</span> sent it</span><br><span class=\"line\">    to your terminal.</span><br><span class=\"line\"></span><br><span class=\"line\">To try something more ambitious, you can run an Ubuntu container with:</span><br><span class=\"line\"> $ docker run -it ubuntu bash</span><br><span class=\"line\"></span><br><span class=\"line\">Share images, automate workflows, and more with a free Docker ID:</span><br><span class=\"line\"> https://hub.docker.com/</span><br><span class=\"line\"></span><br><span class=\"line\">For more examples and ideas, visit:</span><br><span class=\"line\"> https://docs.docker.com/get-started/</span><br><span class=\"line\"></span><br><span class=\"line\">/ <span class=\"comment\">#</span></span><br></pre></td></tr></table></figure>\n\n<p>这样启动的 hello-world 会再宿主机上真实的启动一个容器</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">root@devops:~/poc# docker ps -a</span><br><span class=\"line\">CONTAINER ID   IMAGE                                           COMMAND                  CREATED              STATUS                      PORTS                                                                      NAMES</span><br><span class=\"line\">174757c01f08   hello-world                                     <span class=\"string\">&quot;/hello&quot;</span>                 About a minute ago   Exited (0) 59 seconds ago                                                                              inspiring_morse</span><br><span class=\"line\">c0d09eee09a6   docker:latest                                   <span class=\"string\">&quot;dockerd-entrypoint.…&quot;</span>   About a minute ago   Up About a minute           2375-2376/tcp                                                              sharp_dubinsky</span><br><span class=\"line\">e244d45174b3   dockerhub.qingcloud.com/doubao/rancher:latest   <span class=\"string\">&quot;entrypoint.sh&quot;</span>          2 weeks ago          Up 39 minutes               0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, :::443-&gt;443/tcp   rancher</span><br><span class=\"line\">root@devops:~/poc#</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"优点\"><a href=\"#优点\" class=\"headerlink\" title=\"优点\"></a>优点</h4><ul>\n<li><strong>简单性</strong>：设置和使用非常简单，快速上手。</li>\n<li><strong>性能</strong>：直接使用宿主机的 Docker 守护进程，避免了性能开销。</li>\n</ul>\n<h4 id=\"缺点\"><a href=\"#缺点\" class=\"headerlink\" title=\"缺点\"></a>缺点</h4><ul>\n<li><strong>安全风险</strong>：容器内应用拥有对宿主机 Docker 的完全控制，存在安全隐患。</li>\n<li><strong>环境污染</strong>：容器内的操作可能影响宿主机上的 Docker 环境，导致不一致性。</li>\n</ul>\n<h3 id=\"2-使用-Docker-的-DinD-镜像\"><a href=\"#2-使用-Docker-的-DinD-镜像\" class=\"headerlink\" title=\"2. 使用 Docker 的 DinD 镜像\"></a>2. 使用 Docker 的 DinD 镜像</h3><p>Docker 官方提供了一个名为 <code>docker:dind</code> 的镜像，专门用于在容器中运行 Docker。这种方式允许你在容器内启动一个独立的 Docker 守护进程。</p>\n<h4 id=\"验证-1\"><a href=\"#验证-1\" class=\"headerlink\" title=\"验证\"></a>验证</h4><figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~#  docker run --privileged  --name dind-container -d docker:latest</span><br><span class=\"line\">8cecade0bdc3e3a8de171caaf5706253bdc7920473512692a5f5ea6610725ef2</span><br><span class=\"line\">root@devops:~# docker exec -it dind-container sh</span><br><span class=\"line\">/ # docker run hello-world</span><br><span class=\"line\">Unable to find image &#x27;hello-world:latest&#x27; locally</span><br><span class=\"line\">latest: Pulling from library/hello-world</span><br><span class=\"line\">c1ec31eb5944: Pull complete</span><br><span class=\"line\">Digest: sha256:1408fec50309afee38f3535383f5b09419e6dc0925bc69891e79d84cc4cdcec6</span><br><span class=\"line\">Status: Downloaded newer image for hello-world:latest</span><br><span class=\"line\"></span><br><span class=\"line\">Hello from Docker!</span><br><span class=\"line\">This message shows that your installation appears to be working correctly.</span><br><span class=\"line\"></span><br><span class=\"line\">To generate this message, Docker took the following steps:</span><br><span class=\"line\"> 1. The Docker client contacted the Docker daemon.</span><br><span class=\"line\"> 2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.</span><br><span class=\"line\">    (amd64)</span><br><span class=\"line\"> 3. The Docker daemon created a new container from that image which runs the</span><br><span class=\"line\">    executable that produces the output you are currently reading.</span><br><span class=\"line\"> 4. The Docker daemon streamed that output to the Docker client, which sent it</span><br><span class=\"line\">    to your terminal.</span><br><span class=\"line\"></span><br><span class=\"line\">To try something more ambitious, you can run an Ubuntu container with:</span><br><span class=\"line\"> $ docker run -it ubuntu bash</span><br><span class=\"line\"></span><br><span class=\"line\">Share images, automate workflows, and more with a free Docker ID:</span><br><span class=\"line\"> https://hub.docker.com/</span><br><span class=\"line\"></span><br><span class=\"line\">For more examples and ideas, visit:</span><br><span class=\"line\"> https://docs.docker.com/get-started/</span><br><span class=\"line\"></span><br><span class=\"line\">/ # docker ps -a</span><br><span class=\"line\">CONTAINER ID   IMAGE         COMMAND    CREATED              STATUS                          PORTS     NAMES</span><br><span class=\"line\">1253974190f1   hello-world   &quot;/hello&quot;   About a minute ago   Exited (0) About a minute ago             thirsty_mclean</span><br><span class=\"line\">/ #</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>这样启动的 hello-world 只会在容器内启动，宿主机上是没有 hello-world 的容器。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~/poc# docker ps -a</span><br><span class=\"line\">CONTAINER ID   IMAGE                                           COMMAND                  CREATED              STATUS              PORTS                                                                      NAMES</span><br><span class=\"line\">8cecade0bdc3   docker:latest                                   <span class=\"string\">&quot;dockerd-entrypoint.…&quot;</span>   About a minute ago   Up About a minute   2375-2376/tcp                                                              dind-container</span><br><span class=\"line\">e244d45174b3   dockerhub.qingcloud.com/doubao/rancher:latest   <span class=\"string\">&quot;entrypoint.sh&quot;</span>          2 weeks ago          Up 56 minutes       0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp, :::443-&gt;443/tcp   rancher</span><br><span class=\"line\">root@devops:~/poc#</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"踩坑\"><a href=\"#踩坑\" class=\"headerlink\" title=\"踩坑\"></a>踩坑</h4><p>第一种 DinD 的启动方式，是直接挂载 sock，然后直接 docker run -it 容器 sh 就直接进入到容器中了，就可以直接操作容器内部的 docker。</p>\n<p>第二种 DinD 的启动方式，是没有挂载 sock，所以不可以直接 docker run -it 容器 sh，这样进入到容器中，docker 的 sock 还没有完全启动，所以需要先 docker run 启动容器，然后再 docker exec 进入容器，然后就可以操作容器内的 docker 了。</p>\n<h4 id=\"优点-1\"><a href=\"#优点-1\" class=\"headerlink\" title=\"优点\"></a>优点</h4><ul>\n<li><strong>官方支持</strong>：由 Docker 官方维护，确保兼容性和稳定性。</li>\n<li><strong>隔离性</strong>：每个 DinD 容器都有自己的 Docker 守护进程，彼此之间完全隔离。</li>\n</ul>\n<h4 id=\"缺点-1\"><a href=\"#缺点-1\" class=\"headerlink\" title=\"缺点\"></a>缺点</h4><ul>\n<li><strong>性能开销</strong>：由于在容器内管理 Docker，可能会引入额外的性能开销。</li>\n<li><strong>复杂性</strong>：需要配置网络和存储，以确保容器间的通信。</li>\n</ul>\n<h3 id=\"3-使用-Sysbox\"><a href=\"#3-使用-Sysbox\" class=\"headerlink\" title=\"3. 使用 Sysbox\"></a>3. 使用 Sysbox</h3><p>Sysbox 是一个增强型容器运行时，允许你在容器中运行完整的系统服务，包括 Docker。与直接挂载 Docker.sock 相比，Sysbox 提供了更好的隔离性。</p>\n<h4 id=\"验证-2\"><a href=\"#验证-2\" class=\"headerlink\" title=\"验证\"></a>验证</h4><p>由于需要更改 docker 的 runtime，由于现在的默认 runtimes 是 runc，更改成 sysbox 有挑战。目前没有技术知识，等后续。。。</p>\n<h4 id=\"优点-2\"><a href=\"#优点-2\" class=\"headerlink\" title=\"优点\"></a>优点</h4><ul>\n<li><strong>增强的隔离性</strong>：容器内的操作不会影响宿主机 Docker 环境。</li>\n<li><strong>支持复杂应用</strong>：可以在容器中运行更复杂的应用程序和服务。</li>\n</ul>\n<h4 id=\"缺点-2\"><a href=\"#缺点-2\" class=\"headerlink\" title=\"缺点\"></a>缺点</h4><ul>\n<li><strong>安装复杂性</strong>：需要额外的步骤来安装和配置 Sysbox。</li>\n<li><strong>性能开销</strong>：可能引入额外的性能开销。</li>\n</ul>\n","categories":["docker"],"tags":["docker"]},{"title":"docker containerd runc","url":"/docker/docker-containerd-runc/","content":"<h1 id=\"OCI-Open-Container-Initiative\"><a href=\"#OCI-Open-Container-Initiative\" class=\"headerlink\" title=\"OCI (Open Container Initiative)\"></a>OCI (Open Container Initiative)</h1><p>OCI（Open Container Initiative）即开放的容器运行时<strong>规范</strong>，目的在于定义一个容器运行时及镜像的相关标准和规范，其中包括</p>\n<ul>\n<li>runtime-spec：容器的生命周期管理，具体参考<a href=\"https://github.com/opencontainers/runtime-spec/blob/master/runtime.md\">runtime-spec</a>。</li>\n<li>image-spec：镜像的生命周期管理，具体参考<a href=\"https://github.com/opencontainers/image-spec/blob/main/spec.md\">image-spec</a>。</li>\n</ul>\n<p>实现 OCI 标准的容器运行时有<code>runc</code>，<code>kata</code>等。</p>\n<h1 id=\"CRI-Container-Runtime-Interface\"><a href=\"#CRI-Container-Runtime-Interface\" class=\"headerlink\" title=\"CRI (Container Runtime Interface)\"></a>CRI (Container Runtime Interface)</h1><p><strong>CRI 即容器运行时接口，主要用来定义 k8s 与容器运行时的 API 调用</strong>，kubelet 通过 CRI 来调用容器运行时，只要实现了 CRI 接口的容器运行时就可以对接到 k8s 的 kubelet 组件。</p>\n<p><img src=\"/docker/docker-containerd-runc/image-20240818154100206.png\" alt=\"image-20240818154100206\"></p>\n<span id=\"more\"></span>\n\n<h1 id=\"Containerd\"><a href=\"#Containerd\" class=\"headerlink\" title=\"Containerd\"></a>Containerd</h1><p><a href=\"https://github.com/containerd/containerd\">containerd</a> 是一个开源的容器运行时，可以管理和运行容器，是 Docker 默认使用的容器运行时，并实现了 CRI 规范。<br>containerd 通过其 CRI 插件实现了 Kubernetes 容器运行时接口（CRI），它可以管理容器的整个生命周期，包括从镜像的传输、存储到容器的执行、监控再到网络。</p>\n<h2 id=\"containerd-支持的-shim？\"><a href=\"#containerd-支持的-shim？\" class=\"headerlink\" title=\"containerd 支持的 shim？\"></a>containerd 支持的 shim？</h2><p>shim：垫片，一般用来表示对第三方组件 API 调用的适配插件，例如 k8s 使用 Dockershim 来实现对 docker 接口的适配调用。<br>Containerd 目前官方支持的 shim 清单：</p>\n<h3 id=\"io-containerd-runtime-v1-linux\"><a href=\"#io-containerd-runtime-v1-linux\" class=\"headerlink\" title=\"io.containerd.runtime.v1.linux\"></a>io.containerd.runtime.v1.linux</h3><p><code>io.containerd.runtime.v1.linux</code> 是最原始的 shim API 和实现的 v1 版本，在 Containerd 1.0 之前被设计出来。该 shim 使用 <code>runc</code> 来执行容器，并且只支持 <code>cgroup v1</code>。目前 v1 版 shim API 已被废弃，并将于 Containerd 2.0 被删除。</p>\n<h3 id=\"io-containerd-runc-v1\"><a href=\"#io-containerd-runc-v1\" class=\"headerlink\" title=\"io.containerd.runc.v1\"></a>io.containerd.runc.v1</h3><p><code>io.containerd.runc.v1</code> 与 <code>io.containerd.runtime.v1.linux</code> 的实现类似，唯一的区别是它使用了 v2 版本 shim API。该 shim 仍然只支持 cgroup v1。</p>\n<h3 id=\"io-containerd-runc-v2\"><a href=\"#io-containerd-runc-v2\" class=\"headerlink\" title=\"io.containerd.runc.v2\"></a>io.containerd.runc.v2</h3><p>该 shim 与 <strong>v1</strong> 采用了完全不同的实现，并且使用了 v2 版本 shim API，同时支持 cgroup v1 和 v2。该 shim 进程以运行多个容器，用于 Kubernetes 的 CRI 实现，可以在一个 Pod 中运行多个容器。</p>\n<h3 id=\"io-containerd-runhcs-v1\"><a href=\"#io-containerd-runhcs-v1\" class=\"headerlink\" title=\"io.containerd.runhcs.v1\"></a>io.containerd.runhcs.v1</h3><p>这是 Windows 平台的 shim，使用 Window 的 <code>HCSv2 API</code> 来管理容器。</p>\n<h1 id=\"CRI-O\"><a href=\"#CRI-O\" class=\"headerlink\" title=\"CRI-O\"></a>CRI-O</h1><p>CRI-O 是另一个实现了容器运行时接口（CRI）的高级别容器运行时，可以使用 OCI（开放容器倡议）兼容的运行时，它是 containerd 的一个替代品。<br>CRI-O 诞生于 RedHat、IBM、英特尔、SUSE、Hyper 等公司。它是专门从头开始创建的，作为 Kubernetes 的一个容器运行时，它提供了启动、停止和重启容器的能力，就像 containerd 一样。</p>\n<h1 id=\"RunC\"><a href=\"#RunC\" class=\"headerlink\" title=\"RunC\"></a>RunC</h1><p><a href=\"https://github.com/opencontainers/runc\">runc(run container)</a>是一个基于 OCI 标准实现的一个轻量级容器运行工具，用来创建和运行容器。而 Containerd 是用来维持通过 runc 创建的容器的运行状态。即 runc 用来创建和运行容器，containerd 作为常驻进程用来管理容器。<br>runc 包含 libcontainer，包括对 namespace 和 cgroup 的调用操作。<br>安装 docker 后，会自动安装 runc，linux 上可以直接运行 runc 命令。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:/usr/bin# runc</span><br><span class=\"line\">NAME:</span><br><span class=\"line\">   runc - Open Container Initiative runtime</span><br><span class=\"line\"></span><br><span class=\"line\">runc is a <span class=\"built_in\">command</span> line client <span class=\"keyword\">for</span> running applications packaged according to</span><br><span class=\"line\">the Open Container Initiative (OCI) format and is a compliant implementation of the</span><br><span class=\"line\">Open Container Initiative specification.</span><br><span class=\"line\"></span><br><span class=\"line\">runc integrates well with existing process supervisors to provide a production</span><br><span class=\"line\">container runtime environment <span class=\"keyword\">for</span> applications. It can be used with your</span><br><span class=\"line\">existing process monitoring tools and the container will be spawned as a</span><br><span class=\"line\">direct child of the process supervisor.</span><br><span class=\"line\"></span><br><span class=\"line\">Containers are configured using bundles. A bundle <span class=\"keyword\">for</span> a container is a directory</span><br><span class=\"line\">that includes a specification file named <span class=\"string\">&quot;config.json&quot;</span> and a root filesystem.</span><br><span class=\"line\">The root filesystem contains the contents of the container.</span><br><span class=\"line\"></span><br><span class=\"line\">To start a new instance of a container:</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># runc run [ -b bundle ] &lt;container-id&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">Where <span class=\"string\">&quot;&lt;container-id&gt;&quot;</span> is your name <span class=\"keyword\">for</span> the instance of the container that you</span><br><span class=\"line\">are starting. The name you provide <span class=\"keyword\">for</span> the container instance must be unique on</span><br><span class=\"line\">your host. Providing the bundle directory using <span class=\"string\">&quot;-b&quot;</span> is optional. The default</span><br><span class=\"line\">value <span class=\"keyword\">for</span> <span class=\"string\">&quot;bundle&quot;</span> is the current directory.</span><br><span class=\"line\"></span><br><span class=\"line\">USAGE:</span><br><span class=\"line\">   runc [global options] <span class=\"built_in\">command</span> [<span class=\"built_in\">command</span> options] [arguments...]</span><br><span class=\"line\"></span><br><span class=\"line\">VERSION:</span><br><span class=\"line\">   1.7.19</span><br><span class=\"line\">commit: v1.1.13-0-g58aa920</span><br><span class=\"line\">spec: 1.0.2-dev</span><br><span class=\"line\">go: go1.21.12</span><br><span class=\"line\">libseccomp: 2.5.5</span><br><span class=\"line\"></span><br><span class=\"line\">COMMANDS:</span><br><span class=\"line\">   checkpoint  checkpoint a running container</span><br><span class=\"line\">   create      create a container</span><br><span class=\"line\">   delete      delete any resources held by the container often used with detached container</span><br><span class=\"line\">   events      display container events such as OOM notifications, cpu, memory, and IO usage statistics</span><br><span class=\"line\">   <span class=\"built_in\">exec</span>        execute new process inside the container</span><br><span class=\"line\">   <span class=\"built_in\">kill</span>        <span class=\"built_in\">kill</span> sends the specified signal (default: SIGTERM) to the container<span class=\"string\">&#x27;s init process</span></span><br><span class=\"line\"><span class=\"string\">   list        lists containers started by runc with the given root</span></span><br><span class=\"line\"><span class=\"string\">   pause       pause suspends all processes inside the container</span></span><br><span class=\"line\"><span class=\"string\">   ps          ps displays the processes running inside a container</span></span><br><span class=\"line\"><span class=\"string\">   restore     restore a container from a previous checkpoint</span></span><br><span class=\"line\"><span class=\"string\">   resume      resumes all processes that have been previously paused</span></span><br><span class=\"line\"><span class=\"string\">   run         create and run a container</span></span><br><span class=\"line\"><span class=\"string\">   spec        create a new specification file</span></span><br><span class=\"line\"><span class=\"string\">   start       executes the user defined process in a created container</span></span><br><span class=\"line\"><span class=\"string\">   state       output the state of a container</span></span><br><span class=\"line\"><span class=\"string\">   update      update container resource constraints</span></span><br><span class=\"line\"><span class=\"string\">   features    show the enabled features</span></span><br><span class=\"line\"><span class=\"string\">   help, h     Shows a list of commands or help for one command</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">GLOBAL OPTIONS:</span></span><br><span class=\"line\"><span class=\"string\">   --debug             enable debug logging</span></span><br><span class=\"line\"><span class=\"string\">   --log value         set the log file to write runc logs to (default is &#x27;</span>/dev/stderr<span class=\"string\">&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">   --log-format value  set the log format (&#x27;</span>text<span class=\"string\">&#x27; (default), or &#x27;</span>json<span class=\"string\">&#x27;) (default: &quot;text&quot;)</span></span><br><span class=\"line\"><span class=\"string\">   --root value        root directory for storage of container state (this should be located in tmpfs) (default: &quot;/run/runc&quot;)</span></span><br><span class=\"line\"><span class=\"string\">   --criu value        path to the criu binary used for checkpoint and restore (default: &quot;criu&quot;)</span></span><br><span class=\"line\"><span class=\"string\">   --systemd-cgroup    enable systemd cgroup support, expects cgroupsPath to be of form &quot;slice:prefix:name&quot; for e.g. &quot;system.slice:runc:434234&quot;</span></span><br><span class=\"line\"><span class=\"string\">   --rootless value    ignore cgroup permission errors (&#x27;</span><span class=\"literal\">true</span><span class=\"string\">&#x27;, &#x27;</span><span class=\"literal\">false</span><span class=\"string\">&#x27;, or &#x27;</span>auto<span class=\"string\">&#x27;) (default: &quot;auto&quot;)</span></span><br><span class=\"line\"><span class=\"string\">   --help, -h          show help</span></span><br><span class=\"line\"><span class=\"string\">   --version, -v       print the version</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Docker\"><a href=\"#Docker\" class=\"headerlink\" title=\"Docker\"></a>Docker</h1><p>从 Docker 1.11 版本开始，Docker 容器运行就不是简单通过 Docker Daemon 来启动了，而是通过集成 <a href=\"https://www.docker.com/blog/docker-engine-1-11-runc/\">containerd、runc</a> 等多个组件来完成的。</p>\n<p><img src=\"/docker/docker-containerd-runc/image-20240818151314490.png\" alt=\"image-20240818151314490\"></p>\n<!--more-->\n\n<p>每一个 Containerd 或 Docker 容器都有一个相应的 shim 守护进程，这个守护进程会提供一个 API，Containerd 使用该 API 来管理容器基本的生命周期（启动&#x2F;停止）。shim 还有一个作用是向 Containerd 报告容器的退出状态，在容器退出状态被 Containerd 收集之前，shim 会一直存在。这一点和僵尸进程很像，僵尸进程在被父进程回收之前会一直存在，只不过僵尸进程不会占用资源，而 shim 会占用资源。</p>\n<p>shim 将 Containerd 进程从容器的生命周期中分离出来，具体的做法是 runc 在创建和运行容器之后退出，并将 shim 作为容器的父进程，即使 Containerd 进程挂掉或者重启，也不会对容器造成任何影响。这样做的好处，可以在线升级或者重启 Containerd，不会对运行中的容器产生任何影响。Docker 的 <a href=\"https://icloudnative.io/go/?target=aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vY29uZmlnL2NvbnRhaW5lcnMvbGl2ZS1yZXN0b3JlLw==\">–live-restore</a> 特征也实现了类似的功能。</p>\n<h1 id=\"docker-和-k8s-管理容器的关系图\"><a href=\"#docker-和-k8s-管理容器的关系图\" class=\"headerlink\" title=\"docker 和 k8s 管理容器的关系图\"></a>docker 和 k8s 管理容器的关系图</h1><p>关系流程如下</p>\n<ul>\n<li><p>Docker，Kubernetes 等工具来运行一个容器时会调用容器运行时（CRI）比如 containerd，CRI-O</p>\n</li>\n<li><p>通过容器运行时来完成容器的创建、运行、销毁等实际工作</p>\n</li>\n<li><p>Docker 使用的是 containerd 作为其运行时；Kubernetes 支持 containerd，CRI-O 等多种容器运行时</p>\n</li>\n<li><p>这些容器运行时都遵循了 OCI 规范，并通过 runc 来实现与操作系统内核交互来完成容器的创建和运行</p>\n</li>\n</ul>\n<p><img src=\"/docker/docker-containerd-runc/image-20240818154926633.png\" alt=\"image-20240818154926633\"></p>\n","categories":["docker"],"tags":["docker"]},{"title":"hexo文件夹大小写","url":"/hexo/hexo-filename-case/","content":"<h1 id=\"hexo-生成文件大小写问题\"><a href=\"#hexo-生成文件大小写问题\" class=\"headerlink\" title=\"hexo 生成文件大小写问题\"></a>hexo 生成文件大小写问题</h1><p>将<code>_config.yaml</code>中的配置更改。清理后重新生成新的文件夹就是小写的。</p>\n<p>默认是<code>0</code>，文件夹首字母是大写的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">filename_case: 1</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"hexo-设置-category-页面分类小写\"><a href=\"#hexo-设置-category-页面分类小写\" class=\"headerlink\" title=\"hexo 设置 category 页面分类小写\"></a>hexo 设置 category 页面分类小写</h1><p>找到主题文件夹中的 layout 目录，我的是<code>D:\\hexo\\themes\\next\\layout\\category.njk</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">extends</span> <span class=\"string\">&#x27;_layout.njk&#x27;</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">import</span> <span class=\"string\">&#x27;_macro/post-collapse.njk&#x27;</span> <span class=\"string\">as</span> <span class=\"string\">post_template</span> <span class=\"string\">with</span> <span class=\"string\">context</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">import</span> <span class=\"string\">&#x27;_macro/sidebar.njk&#x27;</span> <span class=\"string\">as</span> <span class=\"string\">sidebar_template</span> <span class=\"string\">with</span> <span class=\"string\">context</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"comment\">#####注释掉，不想显示 ###&#125;</span></span><br><span class=\"line\"> &#123;<span class=\"comment\">###&#123;% block title %&#125;&#123;&#123; __(&#x27;title.category&#x27;) &#125;&#125;: &#123;&#123; page.category &#125;&#125; | &#123;&#123; title &#125;&#125;&#123;% endblock %&#125;###&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">block</span> <span class=\"string\">title</span> <span class=\"string\">%</span>&#125; &#123;&#123; <span class=\"string\">page.category.toLowerCase()</span> &#125;&#125; <span class=\"string\">|</span> &#123;&#123; <span class=\"string\">title</span> &#125;&#125;&#123;<span class=\"string\">%</span> <span class=\"string\">endblock</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">block</span> <span class=\"string\">class</span> <span class=\"string\">%</span>&#125;<span class=\"string\">category</span> <span class=\"string\">posts-collapse</span>&#123;<span class=\"string\">%</span> <span class=\"string\">endblock</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">block</span> <span class=\"string\">content</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"comment\">######################&#125;</span></span><br><span class=\"line\">  &#123;<span class=\"comment\">### CATEGORY BLOCK ###&#125;</span></span><br><span class=\"line\">  &#123;<span class=\"comment\">######################&#125;</span></span><br><span class=\"line\">  <span class=\"string\">&lt;div</span> <span class=\"string\">class=&quot;post-block&quot;&gt;</span></span><br><span class=\"line\">    <span class=\"string\">&lt;div</span> <span class=\"string\">class=&quot;post-content&quot;&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;div</span> <span class=\"string\">class=&quot;collection-title&quot;&gt;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;h1</span> <span class=\"string\">class=&quot;collection-header&quot;&gt;</span></span><br><span class=\"line\">\t\t&#123;<span class=\"comment\">#####这里设置，添加toLowerCase()，不然是驼峰大写命名法###&#125;</span></span><br><span class=\"line\">          &#123;&#123;<span class=\"bullet\">-</span> <span class=\"string\">page.category.toLowerCase()</span> &#125;&#125;</span><br><span class=\"line\">          &#123;<span class=\"comment\">####注释掉，不想显示 &lt;small&gt;&#123;&#123; __(&#x27;title.category&#x27;) &#125;&#125;&lt;/small&gt;###&#125;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;/h1&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;/div&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      &#123;&#123; <span class=\"string\">post_template.render(page.posts)</span> &#125;&#125;</span><br><span class=\"line\">    <span class=\"string\">&lt;/div&gt;</span></span><br><span class=\"line\">  <span class=\"string\">&lt;/div&gt;</span></span><br><span class=\"line\">  &#123;<span class=\"comment\">##########################&#125;</span></span><br><span class=\"line\">  &#123;<span class=\"comment\">### END CATEGORY BLOCK ###&#125;</span></span><br><span class=\"line\">  &#123;<span class=\"comment\">##########################&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">include</span> <span class=\"string\">&#x27;_partials/pagination.njk&#x27;</span> <span class=\"string\">-%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">endblock</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">block</span> <span class=\"string\">sidebar</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">  &#123;&#123; <span class=\"string\">sidebar_template.render(false)</span> &#125;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">endblock</span> <span class=\"string\">%</span>&#125;</span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<h1 id=\"hexo-设置-tag-页面标签小写\"><a href=\"#hexo-设置-tag-页面标签小写\" class=\"headerlink\" title=\"hexo 设置 tag 页面标签小写\"></a>hexo 设置 tag 页面标签小写</h1><p>找到主题文件夹中的 layout 目录，我的是<code>D:\\hexo\\themes\\next\\layout\\tag.njk</code></p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">extends</span> <span class=\"string\">&#x27;_layout.njk&#x27;</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">import</span> <span class=\"string\">&#x27;_macro/post-collapse.njk&#x27;</span> <span class=\"string\">as</span> <span class=\"string\">post_template</span> <span class=\"string\">with</span> <span class=\"string\">context</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">import</span> <span class=\"string\">&#x27;_macro/sidebar.njk&#x27;</span> <span class=\"string\">as</span> <span class=\"string\">sidebar_template</span> <span class=\"string\">with</span> <span class=\"string\">context</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"comment\">####注释掉，不想显示####&#125;</span></span><br><span class=\"line\">&#123;<span class=\"comment\">####&#123;% block title %&#125;&#123;&#123; __(&#x27;title.tag&#x27;) &#125;&#125;: &#123;&#123; page.tag.toLowerCase() &#125;&#125; | &#123;&#123; title &#125;&#125;&#123;% endblock %&#125;####&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">block</span> <span class=\"string\">title</span> <span class=\"string\">%</span>&#125; &#123;&#123; <span class=\"string\">page.tag.toLowerCase()</span> &#125;&#125; <span class=\"string\">|</span> &#123;&#123; <span class=\"string\">title</span> &#125;&#125;&#123;<span class=\"string\">%</span> <span class=\"string\">endblock</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">block</span> <span class=\"string\">class</span> <span class=\"string\">%</span>&#125;<span class=\"string\">tag</span> <span class=\"string\">posts-collapse</span>&#123;<span class=\"string\">%</span> <span class=\"string\">endblock</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">block</span> <span class=\"string\">content</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"comment\">#################&#125;</span></span><br><span class=\"line\">  &#123;<span class=\"comment\">### TAG BLOCK ###&#125;</span></span><br><span class=\"line\">  &#123;<span class=\"comment\">#################&#125;</span></span><br><span class=\"line\">  <span class=\"string\">&lt;div</span> <span class=\"string\">class=&quot;post-block&quot;&gt;</span></span><br><span class=\"line\">    <span class=\"string\">&lt;div</span> <span class=\"string\">class=&quot;post-content&quot;&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;div</span> <span class=\"string\">class=&quot;collection-title&quot;&gt;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;h1</span> <span class=\"string\">class=&quot;collection-header&quot;&gt;</span></span><br><span class=\"line\">          &#123;&#123;<span class=\"bullet\">-</span> <span class=\"string\">page.tag.toLowerCase()</span> &#125;&#125;</span><br><span class=\"line\">          &#123;<span class=\"comment\">####注释掉，不想显示 &lt;small&gt;&#123;&#123; __(&#x27;title.tag&#x27;) &#125;&#125;&lt;/small&gt;####&#125;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;/h1&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;/div&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      &#123;&#123; <span class=\"string\">post_template.render(page.posts)</span> &#125;&#125;</span><br><span class=\"line\">    <span class=\"string\">&lt;/div&gt;</span></span><br><span class=\"line\">  <span class=\"string\">&lt;/div&gt;</span></span><br><span class=\"line\">  &#123;<span class=\"comment\">#####################&#125;</span></span><br><span class=\"line\">  &#123;<span class=\"comment\">### END TAG BLOCK ###&#125;</span></span><br><span class=\"line\">  &#123;<span class=\"comment\">#####################&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">include</span> <span class=\"string\">&#x27;_partials/pagination.njk&#x27;</span> <span class=\"string\">-%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">endblock</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">block</span> <span class=\"string\">sidebar</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">  &#123;&#123; <span class=\"string\">sidebar_template.render(false)</span> &#125;&#125;</span><br><span class=\"line\">&#123;<span class=\"string\">%</span> <span class=\"string\">endblock</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"hexo-设置首页中文章的分类于小写\"><a href=\"#hexo-设置首页中文章的分类于小写\" class=\"headerlink\" title=\"hexo 设置首页中文章的分类于小写\"></a>hexo 设置首页中文章的分类于小写</h1><p>找到主题文件夹中的 layout 目录，我的是<code>D:\\hexo\\themes\\next\\layout\\_partials\\post\\post-meta.njk</code></p>\n<p> 将在<code>cat.name</code>后面添加<code>.toLowerCase()</code>。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">&lt;div</span> <span class=\"string\">class=&quot;post-meta&quot;&gt;</span></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">set</span> <span class=\"string\">date_diff</span> <span class=\"string\">=</span> <span class=\"string\">date(post.date)</span> <span class=\"type\">!=</span> <span class=\"string\">date(post.updated)</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">set</span> <span class=\"string\">time_diff</span> <span class=\"string\">=</span> <span class=\"string\">time(post.date)</span> <span class=\"type\">!=</span> <span class=\"string\">time(post.updated)</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">if</span> <span class=\"string\">theme.post_meta.created_at</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">    <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item&quot;&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item-icon&quot;&gt;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;i</span> <span class=\"string\">class=&quot;far</span> <span class=\"string\">fa-calendar&quot;&gt;&lt;/i&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item-text&quot;&gt;&#123;&#123;</span> <span class=\"string\">__(&#x27;post.posted&#x27;)</span> <span class=\"string\">&#125;&#125;&lt;/span&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      &#123;<span class=\"string\">%-</span> <span class=\"string\">if</span> <span class=\"string\">not</span> <span class=\"string\">date_diff</span> <span class=\"string\">and</span> <span class=\"string\">time_diff</span> <span class=\"string\">and</span> <span class=\"string\">theme.post_meta.updated_at.enable</span> <span class=\"string\">and</span> <span class=\"string\">theme.post_meta.updated_at.another_day</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">        &#123;<span class=\"string\">%-</span> <span class=\"string\">set</span> <span class=\"string\">create_title</span> <span class=\"string\">=</span> <span class=\"string\">__(&#x27;post.created&#x27;)</span> <span class=\"string\">+</span> <span class=\"string\">__(&#x27;symbol.colon&#x27;)</span> <span class=\"string\">+</span> <span class=\"string\">full_date(post.date)</span> <span class=\"string\">+</span> <span class=\"string\">&#x27; / &#x27;</span> <span class=\"string\">+</span> <span class=\"string\">__(&#x27;post.modified&#x27;)</span> <span class=\"string\">+</span> <span class=\"string\">__(&#x27;symbol.colon&#x27;)</span> <span class=\"string\">+</span> <span class=\"string\">time(post.updated)</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">      &#123;<span class=\"string\">%</span> <span class=\"string\">else</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">        &#123;<span class=\"string\">%-</span> <span class=\"string\">set</span> <span class=\"string\">create_title</span> <span class=\"string\">=</span> <span class=\"string\">__(&#x27;post.created&#x27;)</span> <span class=\"string\">+</span> <span class=\"string\">__(&#x27;symbol.colon&#x27;)</span> <span class=\"string\">+</span> <span class=\"string\">full_date(post.date)</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">      &#123;<span class=\"string\">%-</span> <span class=\"string\">endif</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"string\">&lt;time</span> <span class=\"string\">title=&quot;&#123;&#123;</span> <span class=\"string\">create_title</span> <span class=\"string\">&#125;&#125;&quot;</span> <span class=\"string\">itemprop=&quot;dateCreated</span> <span class=\"string\">datePublished&quot;</span> <span class=\"string\">datetime=&quot;&#123;&#123;</span> <span class=\"string\">moment(post.date).format()</span> <span class=\"string\">&#125;&#125;&quot;&gt;&#123;&#123;</span> <span class=\"string\">date(post.date)</span> <span class=\"string\">&#125;&#125;&lt;/time&gt;</span></span><br><span class=\"line\">    <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">endif</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">if</span> <span class=\"string\">theme.post_meta.updated_at.enable</span> <span class=\"string\">and</span> <span class=\"string\">(not</span> <span class=\"string\">theme.post_meta.updated_at.another_day</span> <span class=\"string\">or</span> <span class=\"string\">date_diff</span> <span class=\"string\">or</span> <span class=\"string\">not</span> <span class=\"string\">theme.post_meta.created_at)</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">    <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item&quot;&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item-icon&quot;&gt;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;i</span> <span class=\"string\">class=&quot;far</span> <span class=\"string\">fa-calendar-check&quot;&gt;&lt;/i&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item-text&quot;&gt;&#123;&#123;</span> <span class=\"string\">__(&#x27;post.edited&#x27;)</span> <span class=\"string\">&#125;&#125;&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;time</span> <span class=\"string\">title=&quot;&#123;&#123;</span> <span class=\"string\">__(&#x27;post.modified&#x27;)</span> <span class=\"string\">+</span> <span class=\"string\">__(&#x27;symbol.colon&#x27;)</span> <span class=\"string\">+</span> <span class=\"string\">full_date(post.updated)</span> <span class=\"string\">&#125;&#125;&quot;</span> <span class=\"string\">itemprop=&quot;dateModified&quot;</span> <span class=\"string\">datetime=&quot;&#123;&#123;</span> <span class=\"string\">moment(post.updated).format()</span> <span class=\"string\">&#125;&#125;&quot;&gt;&#123;&#123;</span> <span class=\"string\">date(post.updated)</span> <span class=\"string\">&#125;&#125;&lt;/time&gt;</span></span><br><span class=\"line\">    <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">endif</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">if</span> <span class=\"string\">post.categories</span> <span class=\"string\">and</span> <span class=\"string\">post.categories.length</span> <span class=\"string\">and</span> <span class=\"string\">theme.post_meta.categories</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">    <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item&quot;&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item-icon&quot;&gt;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;i</span> <span class=\"string\">class=&quot;far</span> <span class=\"string\">fa-folder&quot;&gt;&lt;/i&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item-text&quot;&gt;&#123;&#123;</span> <span class=\"string\">__(&#x27;post.in&#x27;)</span> <span class=\"string\">&#125;&#125;&lt;/span&gt;</span></span><br><span class=\"line\">      &#123;<span class=\"string\">%-</span> <span class=\"string\">for</span> <span class=\"string\">cat</span> <span class=\"string\">in</span> <span class=\"string\">post.categories.toArray()</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">        <span class=\"string\">&lt;span</span> <span class=\"string\">itemprop=&quot;about&quot;</span> <span class=\"string\">itemscope</span> <span class=\"string\">itemtype=&quot;http://schema.org/Thing&quot;&gt;</span></span><br><span class=\"line\">        &#123;<span class=\"comment\">####cat.name.toLowerCase()####&#125;</span></span><br><span class=\"line\">          <span class=\"string\">&lt;a</span> <span class=\"string\">href=&quot;<span class=\"template-variable\">&#123;&#123; url_for(cat.path) &#125;&#125;</span></span><span class=\"string\">&quot; itemprop=&quot;</span><span class=\"string\">url&quot;</span> <span class=\"string\">rel=&quot;index&quot;&gt;&lt;span</span> <span class=\"string\">itemprop=&quot;name&quot;&gt;<span class=\"template-variable\">&#123;&#123; cat.name.toLowerCase() &#125;&#125;</span></span><span class=\"string\">&lt;/span&gt;&lt;/a&gt;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">        &#123;<span class=\"string\">%-</span> <span class=\"string\">set</span> <span class=\"string\">cat_length</span> <span class=\"string\">=</span> <span class=\"string\">post.categories.length</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">        &#123;<span class=\"string\">%-</span> <span class=\"string\">if</span> <span class=\"string\">cat_length</span> <span class=\"string\">&gt;</span> <span class=\"number\">1</span> <span class=\"string\">and</span> <span class=\"string\">loop.index</span> <span class=\"type\">!==</span> <span class=\"string\">cat_length</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">          &#123;&#123; <span class=\"string\">__(&#x27;symbol.comma&#x27;)</span> &#125;&#125;</span><br><span class=\"line\">        &#123;<span class=\"string\">%-</span> <span class=\"string\">endif</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">      &#123;<span class=\"string\">%-</span> <span class=\"string\">endfor</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">    <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">endif</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"comment\"># LeanCloud PageView #&#125;</span></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">if</span> <span class=\"string\">theme.leancloud_visitors.enable</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">    <span class=\"string\">&lt;span</span> <span class=\"string\">id=&quot;<span class=\"template-variable\">&#123;&#123; url_for(post.path) &#125;&#125;</span></span><span class=\"string\">&quot; class=&quot;</span><span class=\"string\">post-meta-item</span> <span class=\"string\">leancloud_visitors&quot;</span> <span class=\"string\">data-flag-title=&quot;<span class=\"template-variable\">&#123;&#123; post.title &#125;&#125;</span></span><span class=\"string\">&quot; title=&quot;</span>&#123;&#123; <span class=\"string\">__(&#x27;post.views&#x27;)</span> &#125;&#125;<span class=\"string\">&quot;&gt;</span></span><br><span class=\"line\"><span class=\"string\">      &lt;span class=&quot;</span><span class=\"string\">post-meta-item-icon&quot;&gt;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;i</span> <span class=\"string\">class=&quot;far</span> <span class=\"string\">fa-eye&quot;&gt;&lt;/i&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item-text&quot;&gt;<span class=\"template-variable\">&#123;&#123; __(&#x27;post.views&#x27;) + __(&#x27;symbol.colon&#x27;) &#125;&#125;</span></span><span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;leancloud-visitors-count&quot;&gt;&lt;/span&gt;</span></span><br><span class=\"line\">    <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">endif</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">if</span> <span class=\"string\">theme.firestore.enable</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">    <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item&quot;</span> <span class=\"string\">title=&quot;<span class=\"template-variable\">&#123;&#123; __(&#x27;post.views&#x27;) &#125;&#125;</span></span><span class=\"string\">&quot;&gt;</span></span><br><span class=\"line\"><span class=\"string\">      &lt;span class=&quot;</span><span class=\"string\">post-meta-item-icon&quot;&gt;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;i</span> <span class=\"string\">class=&quot;far</span> <span class=\"string\">fa-eye&quot;&gt;&lt;/i&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item-text&quot;&gt;<span class=\"template-variable\">&#123;&#123; __(&#x27;post.views&#x27;) + __(&#x27;symbol.colon&#x27;) &#125;&#125;</span></span><span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;firestore-visitors-count&quot;&gt;&lt;/span&gt;</span></span><br><span class=\"line\">    <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">endif</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">if</span> <span class=\"string\">not</span> <span class=\"string\">is_index</span> <span class=\"string\">and</span> <span class=\"string\">theme.busuanzi_count.enable</span> <span class=\"string\">and</span> <span class=\"string\">theme.busuanzi_count.post_views</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">    <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item&quot;</span> <span class=\"string\">title=&quot;<span class=\"template-variable\">&#123;&#123; __(&#x27;post.views&#x27;) &#125;&#125;</span></span><span class=\"string\">&quot; id=&quot;</span><span class=\"string\">busuanzi_container_page_pv&quot;&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item-icon&quot;&gt;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;i</span> <span class=\"string\">class=&quot;<span class=\"template-variable\">&#123;&#123; theme.busuanzi_count.post_views_icon &#125;&#125;</span></span><span class=\"string\">&quot;&gt;&lt;/i&gt;</span></span><br><span class=\"line\"><span class=\"string\">      &lt;/span&gt;</span></span><br><span class=\"line\"><span class=\"string\">      &lt;span class=&quot;</span><span class=\"string\">post-meta-item-text&quot;&gt;<span class=\"template-variable\">&#123;&#123; __(&#x27;post.views&#x27;) + __(&#x27;symbol.colon&#x27;) &#125;&#125;</span></span><span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">id=&quot;busuanzi_value_page_pv&quot;&gt;&lt;/span&gt;</span></span><br><span class=\"line\">    <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">endif</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;&#123;<span class=\"bullet\">-</span> <span class=\"string\">next_inject(&#x27;postMeta&#x27;)</span> &#125;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">if</span> <span class=\"string\">theme.symbols_count_time.separated_meta</span> <span class=\"string\">and</span> <span class=\"string\">config.symbols_count_time.symbols</span> <span class=\"string\">and</span> <span class=\"string\">config.symbols_count_time.time</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">    <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-break&quot;&gt;&lt;/span&gt;</span></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">endif</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">if</span> <span class=\"string\">config.symbols_count_time.symbols</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">    <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item&quot;</span> <span class=\"string\">title=&quot;<span class=\"template-variable\">&#123;&#123; __(&#x27;symbols_count_time.count&#x27;) &#125;&#125;</span></span><span class=\"string\">&quot;&gt;</span></span><br><span class=\"line\"><span class=\"string\">      &lt;span class=&quot;</span><span class=\"string\">post-meta-item-icon&quot;&gt;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;i</span> <span class=\"string\">class=&quot;far</span> <span class=\"string\">fa-file-word&quot;&gt;&lt;/i&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item-text&quot;&gt;<span class=\"template-variable\">&#123;&#123; __(&#x27;symbols_count_time.count&#x27;) + __(&#x27;symbol.colon&#x27;) &#125;&#125;</span></span><span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span&gt;<span class=\"template-variable\">&#123;&#123; symbolsCount(post) &#125;&#125;</span></span><span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">    <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">endif</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">if</span> <span class=\"string\">config.symbols_count_time.time</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\">    <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item&quot;</span> <span class=\"string\">title=&quot;<span class=\"template-variable\">&#123;&#123; __(&#x27;symbols_count_time.time&#x27;) &#125;&#125;</span></span><span class=\"string\">&quot;&gt;</span></span><br><span class=\"line\"><span class=\"string\">      &lt;span class=&quot;</span><span class=\"string\">post-meta-item-icon&quot;&gt;</span></span><br><span class=\"line\">        <span class=\"string\">&lt;i</span> <span class=\"string\">class=&quot;far</span> <span class=\"string\">fa-clock&quot;&gt;&lt;/i&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span</span> <span class=\"string\">class=&quot;post-meta-item-text&quot;&gt;<span class=\"template-variable\">&#123;&#123; __(&#x27;symbols_count_time.time&#x27;) &#125;&#125;</span></span> <span class=\"string\">&amp;asymp;&lt;/span&gt;</span></span><br><span class=\"line\">      <span class=\"string\">&lt;span&gt;<span class=\"template-variable\">&#123;&#123; symbolsTime(post, config.symbols_count_time.awl, config.symbols_count_time.wpm, __(&#x27;symbols_count_time.time_minutes&#x27;)) &#125;&#125;</span></span><span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">    <span class=\"string\">&lt;/span&gt;</span></span><br><span class=\"line\">  &#123;<span class=\"string\">%-</span> <span class=\"string\">endif</span> <span class=\"string\">%</span>&#125;</span><br><span class=\"line\"><span class=\"string\">&lt;/div&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"hexo-更改-url-中-uri\"><a href=\"#hexo-更改-url-中-uri\" class=\"headerlink\" title=\"hexo 更改 url 中 uri\"></a>hexo 更改 url 中 uri</h1><p>更改<code>hexo</code>的<code>_config.yaml</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#permalink: :year/:month/:day/:title/  默认显示年月日加标题的，更改成只显示标题</span></span><br><span class=\"line\"><span class=\"attr\">permalink:</span> <span class=\"string\">:title/</span></span><br></pre></td></tr></table></figure>\n","categories":["hexo"],"tags":["hexo"]},{"title":"hexo主题美化","url":"/hexo/hexo-theme-custom/","content":"<h1 id=\"更改侧边栏背景颜色\"><a href=\"#更改侧边栏背景颜色\" class=\"headerlink\" title=\"更改侧边栏背景颜色\"></a>更改侧边栏背景颜色</h1><p>更改配置文件<code>themes\\next\\source\\css\\_common\\outline\\sidebar\\sidebar.styl</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">.sidebar &#123;</span><br><span class=\"line\">  background: <span class=\"variable\">$black</span>-deep; <span class=\"comment\">#背景颜色</span></span><br><span class=\"line\">  bottom: 0;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (!hexo-config(<span class=\"string\">&#x27;back2top.sidebar&#x27;</span>))&#123;</span><br><span class=\"line\">    box-shadow: inset 0 2px 6px black;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  position: fixed;</span><br><span class=\"line\">  top: 0;</span><br><span class=\"line\"></span><br><span class=\"line\">  +tablet-<span class=\"function\"><span class=\"title\">mobile</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!hexo-config(<span class=\"string\">&#x27;sidebar.onmobile&#x27;</span>)) &#123;</span><br><span class=\"line\">      display: none;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"修改底部用户图标为跳动的心\"><a href=\"#修改底部用户图标为跳动的心\" class=\"headerlink\" title=\"修改底部用户图标为跳动的心\"></a>修改底部用户图标为跳动的心</h1><p>在主题的<code>_config.yml</code>中修改如下</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#网站的页脚设置部分</span></span><br><span class=\"line\"><span class=\"attr\">footer:</span></span><br><span class=\"line\">  <span class=\"comment\"># Specify the date when the site was setup. If not defined, current year will be used.</span></span><br><span class=\"line\">  <span class=\"attr\">since:</span> <span class=\"number\">2021</span> <span class=\"comment\">#网站的建站时间</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># Icon between year and copyright info.</span></span><br><span class=\"line\">  <span class=\"attr\">icon:</span> <span class=\"comment\">#这里的icon是页脚建站时间和网站名字之间的图标，默认是 `user`图标</span></span><br><span class=\"line\">    <span class=\"comment\"># Icon name in Font Awesome. See: https://fontawesome.com/icons</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">fa</span> <span class=\"string\">fa-heart</span>  <span class=\"comment\">#图标名称</span></span><br><span class=\"line\">    <span class=\"comment\"># If you want to animate the icon, set it to true.</span></span><br><span class=\"line\">    <span class=\"attr\">animated:</span> <span class=\"literal\">true</span> <span class=\"comment\">#是否是动画，默认</span></span><br><span class=\"line\">    <span class=\"comment\"># Change the color of icon, using Hex Code.</span></span><br><span class=\"line\">    <span class=\"attr\">color:</span> <span class=\"string\">&quot;#ff0000&quot;</span> <span class=\"comment\">#图标颜色</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<h1 id=\"修改底部信息居中\"><a href=\"#修改底部信息居中\" class=\"headerlink\" title=\"修改底部信息居中\"></a>修改底部信息居中</h1><p>修改文件<code>D:\\hexoblog\\docblog\\themes\\next\\source\\css\\_schemes\\Mist\\_layout.styl</code></p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">Tags</span></span><br><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">--------------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">hr</span> &#123;</span><br><span class=\"line\">  <span class=\"attr\">height:</span> <span class=\"string\">2px;</span></span><br><span class=\"line\">  <span class=\"attr\">margin:</span> <span class=\"string\">20px</span> <span class=\"number\">0</span><span class=\"string\">;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">Components</span></span><br><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">--------------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">.btn</span> &#123;</span><br><span class=\"line\">  <span class=\"attr\">padding:</span> <span class=\"number\">0</span> <span class=\"string\">10px;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">.headband</span> &#123;</span><br><span class=\"line\">  <span class=\"attr\">display:</span> <span class=\"string\">none;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">Page</span> <span class=\"bullet\">-</span> <span class=\"string\">Container</span></span><br><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">--------------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">.main-inner</span> &#123;</span><br><span class=\"line\">  <span class=\"attr\">padding-bottom:</span> <span class=\"string\">80px;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">+mobile()</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">width:</span> <span class=\"string\">auto;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">.content</span> &#123;</span><br><span class=\"line\">  <span class=\"attr\">padding-top:</span> <span class=\"string\">80px;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">+mobile()</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">padding-top:</span> <span class=\"string\">60px;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">Pagination</span></span><br><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">--------------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">.pagination</span> &#123;</span><br><span class=\"line\">  <span class=\"attr\">margin:</span> <span class=\"string\">120px</span> <span class=\"number\">0</span> <span class=\"number\">0</span><span class=\"string\">;</span></span><br><span class=\"line\">  <span class=\"attr\">text-align:</span> <span class=\"string\">left;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">+mobile()</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">margin:</span> <span class=\"string\">80px</span> <span class=\"string\">10px</span> <span class=\"number\">0</span><span class=\"string\">;</span></span><br><span class=\"line\">    <span class=\"attr\">text-align:</span> <span class=\"string\">center;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">Footer</span></span><br><span class=\"line\"><span class=\"string\">//</span> <span class=\"string\">--------------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">.footer</span> &#123;</span><br><span class=\"line\">  <span class=\"attr\">background:</span> <span class=\"string\">var(--content-bg-color);</span></span><br><span class=\"line\">  <span class=\"attr\">color:</span> <span class=\"string\">var(--text-color);</span></span><br><span class=\"line\">  <span class=\"attr\">padding:</span> <span class=\"string\">10px</span> <span class=\"number\">0</span><span class=\"string\">;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">.footer-inner</span> &#123;</span><br><span class=\"line\">  <span class=\"attr\">text-align:</span> <span class=\"string\">center;</span>  <span class=\"comment\">#left改为center</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"string\">+mobile()</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">text-align:</span> <span class=\"string\">center;</span></span><br><span class=\"line\">    <span class=\"attr\">width:</span> <span class=\"string\">auto;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"内联代码文字背景\"><a href=\"#内联代码文字背景\" class=\"headerlink\" title=\"内联代码文字背景\"></a>内联代码文字背景</h1><p>在<code>G:\\hexo-doubao\\themes\\next\\source\\css\\main.styl</code>最后面添加下面的代码</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">code</span> &#123;</span><br><span class=\"line\">    <span class=\"string\">/*</span> <span class=\"string\">Customize</span> <span class=\"string\">inline</span> <span class=\"string\">code</span> <span class=\"string\">styles</span> <span class=\"string\">here</span> <span class=\"string\">*/</span></span><br><span class=\"line\">    <span class=\"attr\">background-color:</span> <span class=\"comment\">#fffff5; /* Background color */</span></span><br><span class=\"line\">    <span class=\"attr\">color:</span> <span class=\"comment\">#58C9B9; /* Text color */</span></span><br><span class=\"line\">    <span class=\"attr\">padding:</span> <span class=\"string\">5px</span> <span class=\"string\">7px;</span> <span class=\"string\">/*</span> <span class=\"string\">Padding</span> <span class=\"string\">around</span> <span class=\"string\">the</span> <span class=\"string\">code</span> <span class=\"string\">*/</span></span><br><span class=\"line\">    <span class=\"attr\">border-radius:</span> <span class=\"string\">4px;</span> <span class=\"string\">/*</span> <span class=\"string\">Border</span> <span class=\"string\">radius</span> <span class=\"string\">for</span> <span class=\"string\">rounded</span> <span class=\"string\">corners</span> <span class=\"string\">*/</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>字体和背景颜色取自<a href=\"https://www.webdesignrankings.com/resources/lolcolors/\">取色器</a></p>\n<h1 id=\"修改主题-css-配置\"><a href=\"#修改主题-css-配置\" class=\"headerlink\" title=\"修改主题 css 配置\"></a>修改主题 css 配置</h1><p>在<code>G:\\hexo\\themes\\next\\source\\css\\_common\\components\\post\\post-body.styl</code>文件后面追加</p>\n<p>如果想设置鼠标移动上去后变色，也可以设置</p>\n<figure class=\"highlight css\"><table><tr><td class=\"code\"><pre><span class=\"line\">  <span class=\"selector-tag\">a</span><span class=\"selector-pseudo\">:not</span>(<span class=\"selector-class\">.btn</span>)&#123;</span><br><span class=\"line\">  <span class=\"attribute\">color</span>: <span class=\"number\">#1971c2</span>; //超链接显示颜色</span><br><span class=\"line\">  <span class=\"attribute\">border-bottom</span>: none;</span><br><span class=\"line\">//  &amp;<span class=\"selector-pseudo\">:hover</span> &#123;</span><br><span class=\"line\">//\t<span class=\"attribute\">color</span>: <span class=\"number\">#00FA9A</span>;  //鼠标移动上去后超链接颜色</span><br><span class=\"line\">//\t<span class=\"attribute\">font-weight</span>: bold;</span><br><span class=\"line\">//\t<span class=\"attribute\">text-decoration</span>: underline;</span><br><span class=\"line\">//\t&#125;</span><br><span class=\"line\">  &#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"首页文章标题居中\"><a href=\"#首页文章标题居中\" class=\"headerlink\" title=\"首页文章标题居中\"></a>首页文章标题居中</h1><p>由于 Next 中的 Mist 主题首页文章的标题默认是左对齐的。添加配置后才可以是居中。</p>\n<p>添加配置到<code>D:\\hexo\\themes\\next\\source\\css\\_schemes\\Mist\\_menu.styl</code>中，重新启动就可以让首页文章的标题居中。</p>\n<figure class=\"highlight css\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"selector-class\">.posts-expand</span> <span class=\"selector-class\">.post-title</span>, <span class=\"selector-class\">.posts-expand</span> <span class=\"selector-class\">.post-meta</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">text-align</span>: center;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"首页文章简介居中\"><a href=\"#首页文章简介居中\" class=\"headerlink\" title=\"首页文章简介居中\"></a>首页文章简介居中</h1><p>更改<code>D:\\hexo\\themes\\next\\source\\css\\_schemes\\Mist\\_posts-expand.styl</code>中的配置，重新启动就可以让章简介的居中。</p>\n<figure class=\"highlight css\"><table><tr><td class=\"code\"><pre><span class=\"line\">// Post Expand</span><br><span class=\"line\">// --------------------------------------------------</span><br><span class=\"line\"><span class=\"selector-class\">.posts-expand</span> &#123;</span><br><span class=\"line\">  &amp;<span class=\"selector-class\">.index</span> &#123;</span><br><span class=\"line\">    <span class=\"selector-class\">.post-header</span> &#123;</span><br><span class=\"line\">      <span class=\"attribute\">text-align</span>: $scheme-text-align;</span><br><span class=\"line\"></span><br><span class=\"line\">      +mobile() &#123;</span><br><span class=\"line\">        <span class=\"attribute\">text-align</span>: center;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"selector-class\">.post-meta-container</span> &#123;</span><br><span class=\"line\">      <span class=\"attribute\">margin-top</span>: <span class=\"number\">5px</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"selector-class\">.post-meta</span> &#123;</span><br><span class=\"line\">//由<span class=\"attribute\">flex</span>-start更改为center</span><br><span class=\"line\">      <span class=\"attribute\">justify-content</span>: center;</span><br><span class=\"line\"></span><br><span class=\"line\">      +mobile() &#123;</span><br><span class=\"line\">        <span class=\"attribute\">justify-content</span>: center;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"selector-class\">.post-eof</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">display</span>: none;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"selector-class\">.post-block</span><span class=\"selector-pseudo\">:not</span>(<span class=\"selector-pseudo\">:first-of-type</span>) &#123;</span><br><span class=\"line\">    <span class=\"attribute\">margin-top</span>: <span class=\"number\">120px</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"selector-class\">.post-header</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">margin-bottom</span>: <span class=\"number\">20px</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"selector-class\">.post-tags</span> &#123;</span><br><span class=\"line\">    <span class=\"selector-tag\">a</span> &#123;</span><br><span class=\"line\">      <span class=\"attribute\">background</span>: <span class=\"built_in\">var</span>(--content-bg-color);</span><br><span class=\"line\">      <span class=\"attribute\">border-bottom</span>: <span class=\"number\">0</span>;</span><br><span class=\"line\">      <span class=\"attribute\">padding</span>: <span class=\"number\">1px</span> <span class=\"number\">5px</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">      &amp;<span class=\"selector-pseudo\">:hover</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">background</span>: <span class=\"built_in\">var</span>(--menu-item-bg-color);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"selector-class\">.post-nav</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">margin-top</span>: <span class=\"number\">40px</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"selector-class\">.post-button</span> &#123;</span><br><span class=\"line\">  <span class=\"attribute\">margin-top</span>: <span class=\"number\">20px</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"selector-class\">.btn</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">background</span>: none;</span><br><span class=\"line\">    <span class=\"attribute\">border</span>: <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"attribute\">border-bottom</span>: <span class=\"number\">2px</span> solid <span class=\"built_in\">var</span>(--btn-default-border-color);</span><br><span class=\"line\">    <span class=\"attribute\">padding</span>: <span class=\"number\">0</span>;</span><br><span class=\"line\">    <span class=\"attribute\">transition-property</span>: border;</span><br><span class=\"line\"></span><br><span class=\"line\">    &amp;<span class=\"selector-pseudo\">:hover</span> &#123;</span><br><span class=\"line\">      <span class=\"attribute\">border-bottom-color</span>: <span class=\"built_in\">var</span>(--btn-default-hover-border-color);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"修改浏览器标签页-title\"><a href=\"#修改浏览器标签页-title\" class=\"headerlink\" title=\"修改浏览器标签页 title\"></a>修改浏览器标签页 title</h1><p>更改<code>themes\\next\\layout\\page.swig</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;% block title %&#125;</span><br><span class=\"line\">  &#123;%- <span class=\"built_in\">set</span> page_title_suffix = <span class=\"string\">&#x27; | &#x27;</span> + title %&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#123;%- <span class=\"keyword\">if</span> page.type === <span class=\"string\">&#x27;categories&#x27;</span> and not page.title %&#125;</span><br><span class=\"line\">    &#123;&#123;- __(<span class=\"string\">&#x27;title.category&#x27;</span>) + page_title_suffix &#125;&#125;</span><br><span class=\"line\">  &#123;%- <span class=\"keyword\">elif</span> page.type === <span class=\"string\">&#x27;tags&#x27;</span> and not page.title %&#125;</span><br><span class=\"line\">    &#123;&#123;- __(<span class=\"string\">&#x27;title.tag&#x27;</span>) + page_title_suffix &#125;&#125;</span><br><span class=\"line\">  &#123;%- <span class=\"keyword\">elif</span> page.type === <span class=\"string\">&#x27;schedule&#x27;</span> and not page.title %&#125;</span><br><span class=\"line\">    &#123;&#123;- __(<span class=\"string\">&#x27;title.schedule&#x27;</span>) + page_title_suffix &#125;&#125;</span><br><span class=\"line\">  &#123;%- <span class=\"keyword\">else</span> %&#125;</span><br><span class=\"line\">    &#123;&#123;- page.name + page_title_suffix &#125;&#125;#有title更改为name</span><br><span class=\"line\">  &#123;%- endif %&#125;</span><br><span class=\"line\">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>\n\n<p><code>在对应菜单的index.md文件中修改title为name</code></p>\n","categories":["hexo"],"tags":["hexo"]},{"title":"hexo搭建和安装相关组件","url":"/hexo/hexo-use-next-setup-blog/","content":"<h2 id=\"初始化博客目录\"><a href=\"#初始化博客目录\" class=\"headerlink\" title=\"初始化博客目录\"></a>初始化博客目录</h2><p><code>例如：D:\\hexoblog\\docblog</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">[D:\\hexoblog\\docblog]$ hexo init</span><br><span class=\"line\">INFO  Cloning hexo-starter https://github.com/hexojs/hexo-starter.git</span><br><span class=\"line\">INFO  Install dependencies</span><br><span class=\"line\">npm WARN config global `--global`, `--<span class=\"built_in\">local</span>` are deprecated. Use `--location=global` instead.</span><br><span class=\"line\">INFO  Start blogging with Hexo</span><br></pre></td></tr></table></figure>\n\n<p><code>目录信息</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">.</span><br><span class=\"line\">├── _config.yml <span class=\"comment\">#Hexo的配置文件</span></span><br><span class=\"line\">├── db.json <span class=\"comment\">#Hexo自动生成的文件</span></span><br><span class=\"line\">├── package.json <span class=\"comment\">#插件配置文件，下同</span></span><br><span class=\"line\">├── package-lock.json</span><br><span class=\"line\">├── node_modules <span class=\"comment\">#生成网站需要用到的Node.js模块</span></span><br><span class=\"line\">├── scaffolds <span class=\"comment\">#存放模板的文件夹</span></span><br><span class=\"line\">├── <span class=\"built_in\">source</span> <span class=\"comment\">#博客Markdown源文件夹</span></span><br><span class=\"line\">├── public <span class=\"comment\">#存放生成的静态HTML文件</span></span><br><span class=\"line\">└── themes <span class=\"comment\">#主题文件夹</span></span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<p><code>环境的各个信息</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">[D:\\hexoblog\\docblog]$ hexo -v</span><br><span class=\"line\">INFO  Validating config</span><br><span class=\"line\">hexo: 6.2.0</span><br><span class=\"line\">hexo-cli: 4.3.0</span><br><span class=\"line\">os: win32 10.0.22000</span><br><span class=\"line\">node: 16.15.1</span><br><span class=\"line\">v8: 9.4.146.24-node.21</span><br><span class=\"line\">uv: 1.43.0</span><br><span class=\"line\">zlib: 1.2.11</span><br><span class=\"line\">brotli: 1.0.9</span><br><span class=\"line\">ares: 1.18.1</span><br><span class=\"line\">modules: 93</span><br><span class=\"line\">nghttp2: 1.47.0</span><br><span class=\"line\">napi: 8</span><br><span class=\"line\">llhttp: 6.0.4</span><br><span class=\"line\">openssl: 1.1.1o+quic</span><br><span class=\"line\">cldr: 40.0</span><br><span class=\"line\">icu: 70.1</span><br><span class=\"line\">tz: 2021a3</span><br><span class=\"line\">unicode: 14.0</span><br><span class=\"line\">ngtcp2: 0.1.0-DEV</span><br><span class=\"line\">nghttp3: 0.1.0-DEV</span><br><span class=\"line\"></span><br><span class=\"line\">[D:\\hexoblog\\docblog]$ npm -v</span><br><span class=\"line\">npm WARN config global `--global`, `--<span class=\"built_in\">local</span>` are deprecated. Use `--location=global` instead.</span><br><span class=\"line\">8.17.0</span><br><span class=\"line\"></span><br><span class=\"line\">[D:\\hexoblog\\docblog]$ node -v</span><br><span class=\"line\">v16.15.1</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装所需插件\"><a href=\"#安装所需插件\" class=\"headerlink\" title=\"安装所需插件\"></a>安装所需插件</h2><h3 id=\"安装-Next-主题\"><a href=\"#安装-Next-主题\" class=\"headerlink\" title=\"安装 Next 主题\"></a>安装 Next 主题</h3><figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">[D:\\hexoblog\\docblog]$ git <span class=\"built_in\">clone</span> https://github.com/theme-next/hexo-theme-next themes/next</span><br><span class=\"line\">Cloning into <span class=\"string\">&#x27;themes/next&#x27;</span>...</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装字数统计和阅读时长\"><a href=\"#安装字数统计和阅读时长\" class=\"headerlink\" title=\"安装字数统计和阅读时长\"></a>安装字数统计和阅读时长</h3><figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">[D:\\hexoblog\\docblog]$ npm install hexo-symbols-count-time --save</span><br><span class=\"line\">npm WARN config global `--global`, `--<span class=\"built_in\">local</span>` are deprecated. Use `--location=global` instead.</span><br><span class=\"line\">npm WARN deprecated highlight.js@9.18.5: Support has ended <span class=\"keyword\">for</span> 9.x series. Upgrade to @latest</span><br><span class=\"line\"></span><br><span class=\"line\">added 8 packages, and audited 249 packages <span class=\"keyword\">in</span> 25s</span><br><span class=\"line\"></span><br><span class=\"line\">20 packages are looking <span class=\"keyword\">for</span> funding</span><br><span class=\"line\">  run `npm fund` <span class=\"keyword\">for</span> details</span><br><span class=\"line\"></span><br><span class=\"line\">3 moderate severity vulnerabilities</span><br><span class=\"line\"></span><br><span class=\"line\">To address all issues, run:</span><br><span class=\"line\">  npm audit fix</span><br><span class=\"line\"></span><br><span class=\"line\">Run `npm audit` <span class=\"keyword\">for</span> details.</span><br><span class=\"line\"></span><br><span class=\"line\">[D:\\hexoblog\\docblog]$ npm install eslint --save</span><br><span class=\"line\">npm WARN config global `--global`, `--<span class=\"built_in\">local</span>` are deprecated. Use `--location=global` instead.</span><br><span class=\"line\"></span><br><span class=\"line\">added 71 packages, and audited 320 packages <span class=\"keyword\">in</span> 1m</span><br><span class=\"line\"></span><br><span class=\"line\">40 packages are looking <span class=\"keyword\">for</span> funding</span><br><span class=\"line\">  run `npm fund` <span class=\"keyword\">for</span> details</span><br><span class=\"line\"></span><br><span class=\"line\">3 moderate severity vulnerabilities</span><br><span class=\"line\"></span><br><span class=\"line\">To address all issues (including breaking changes), run:</span><br><span class=\"line\">  npm audit fix --force</span><br><span class=\"line\"></span><br><span class=\"line\">Run `npm audit` <span class=\"keyword\">for</span> details.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装-git-远程部署\"><a href=\"#安装-git-远程部署\" class=\"headerlink\" title=\"安装 git 远程部署\"></a>安装 git 远程部署</h3><figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">[D:\\hexoblog\\docblog]$  npm install hexo-deployer-git --save</span><br><span class=\"line\">npm WARN config global `--global`, `--<span class=\"built_in\">local</span>` are deprecated. Use `--location=global` instead.</span><br><span class=\"line\"></span><br><span class=\"line\">added 1 package, and audited 321 packages <span class=\"keyword\">in</span> 3s</span><br><span class=\"line\"></span><br><span class=\"line\">40 packages are looking <span class=\"keyword\">for</span> funding</span><br><span class=\"line\">  run `npm fund` <span class=\"keyword\">for</span> details</span><br><span class=\"line\"></span><br><span class=\"line\">3 moderate severity vulnerabilities</span><br><span class=\"line\"></span><br><span class=\"line\">To address all issues (including breaking changes), run:</span><br><span class=\"line\">  npm audit fix --force</span><br><span class=\"line\"></span><br><span class=\"line\">Run `npm audit` <span class=\"keyword\">for</span> details.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"添加搜索\"><a href=\"#添加搜索\" class=\"headerlink\" title=\"添加搜索\"></a>添加搜索</h3><figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">[D:\\hexoblog\\docblog]$ npm install hexo-generator-searchdb --save</span><br><span class=\"line\">npm WARN config global `--global`, `--<span class=\"built_in\">local</span>` are deprecated. Use `--location=global` instead.</span><br><span class=\"line\"></span><br><span class=\"line\">added 1 package, and audited 322 packages <span class=\"keyword\">in</span> 3s</span><br><span class=\"line\"></span><br><span class=\"line\">40 packages are looking <span class=\"keyword\">for</span> funding</span><br><span class=\"line\">  run `npm fund` <span class=\"keyword\">for</span> details</span><br><span class=\"line\"></span><br><span class=\"line\">3 moderate severity vulnerabilities</span><br><span class=\"line\"></span><br><span class=\"line\">To address all issues (including breaking changes), run:</span><br><span class=\"line\">  npm audit fix --force</span><br><span class=\"line\"></span><br><span class=\"line\">Run `npm audit` <span class=\"keyword\">for</span> details.</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"添加图片\"><a href=\"#添加图片\" class=\"headerlink\" title=\"添加图片\"></a>添加图片</h3><figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">[D:\\hexoblog\\docblog]$ npm install https://github.com/CodeFalling/hexo-asset-image --save</span><br><span class=\"line\"></span><br><span class=\"line\">added 21 packages, and audited 338 packages <span class=\"keyword\">in</span> 15s</span><br><span class=\"line\"></span><br><span class=\"line\">50 packages are looking <span class=\"keyword\">for</span> funding</span><br><span class=\"line\">  run `npm fund` <span class=\"keyword\">for</span> details</span><br><span class=\"line\"></span><br><span class=\"line\">9 vulnerabilities (3 moderate, 5 high, 1 critical)</span><br><span class=\"line\"></span><br><span class=\"line\">To address all issues possible (including breaking changes), run:</span><br><span class=\"line\">  npm audit fix --force</span><br><span class=\"line\"></span><br><span class=\"line\">Some issues need review, and may require choosing</span><br><span class=\"line\">a different dependency.</span><br><span class=\"line\"></span><br><span class=\"line\">Run `npm audit` <span class=\"keyword\">for</span> details.</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"更改配置文件\"><a href=\"#更改配置文件\" class=\"headerlink\" title=\"更改配置文件\"></a>更改配置文件</h2><p><code>更改_config.yml中的主题配置</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Extensions</span></span><br><span class=\"line\"><span class=\"comment\">## Plugins: https://hexo.io/plugins/</span></span><br><span class=\"line\"><span class=\"comment\">## Themes: https://hexo.io/themes/</span></span><br><span class=\"line\">theme: next</span><br></pre></td></tr></table></figure>\n\n<p><code>更改_config.yml中的Site配置</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Site</span></span><br><span class=\"line\">title: dooubb</span><br><span class=\"line\">subtitle: <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">description: <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">keywords:</span><br><span class=\"line\">author: dooubb</span><br><span class=\"line\">language: zh-CN</span><br><span class=\"line\">timezone: <span class=\"string\">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p><code>添加git部署配置</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Deployment</span></span><br><span class=\"line\"><span class=\"comment\">## Docs: https://hexo.io/docs/one-command-deployment</span></span><br><span class=\"line\">deploy:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: git</span><br><span class=\"line\">  ignore_hidden: <span class=\"literal\">false</span> <span class=\"comment\"># 添加这个属性值为false 此配置为了git workflows工作</span></span><br><span class=\"line\">  repo:</span><br><span class=\"line\">    <span class=\"comment\">#gitee: https://gitee.com/dooubb/doc.git,master</span></span><br><span class=\"line\">    github: https://github.com/dooubb/doco.git,master</span><br></pre></td></tr></table></figure>\n\n<p><code>在_config.yml添加字数统计和阅读时长配置</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">symbols_count_time:</span><br><span class=\"line\">  symbols: <span class=\"literal\">true</span></span><br><span class=\"line\">  time: <span class=\"literal\">true</span></span><br><span class=\"line\">  total_symbols: <span class=\"literal\">false</span></span><br><span class=\"line\">  total_time: <span class=\"literal\">false</span></span><br><span class=\"line\">  exclude_codeblock: <span class=\"literal\">false</span></span><br><span class=\"line\">  awl: 4</span><br><span class=\"line\">  wpm: 275</span><br><span class=\"line\">  suffix: <span class=\"string\">&quot;mins.&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"更改主题配置文件\"><a href=\"#更改主题配置文件\" class=\"headerlink\" title=\"更改主题配置文件\"></a>更改主题配置文件</h2><p><code>更改NexT主题下_config.yml配置文件</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ---------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># Scheme Settings 主题显示样式</span></span><br><span class=\"line\"><span class=\"comment\"># ---------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># Schemes</span></span><br><span class=\"line\"><span class=\"comment\">#scheme: Muse</span></span><br><span class=\"line\">scheme: Mist</span><br><span class=\"line\"><span class=\"comment\">#scheme: Pisces</span></span><br><span class=\"line\"><span class=\"comment\">#scheme: Gemini</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ---------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># Post wordcount display settings</span></span><br><span class=\"line\"><span class=\"comment\"># Dependencies: https://github.com/theme-next/hexo-symbols-count-time</span></span><br><span class=\"line\"><span class=\"comment\"># ---------------------------------------------------------------</span></span><br><span class=\"line\">symbols_count_time:</span><br><span class=\"line\">  separated_meta: <span class=\"literal\">false</span>     <span class=\"comment\"># 是否另起一行（true的话不和发表时间等同一行）</span></span><br><span class=\"line\">  item_text_post: <span class=\"literal\">false</span>     <span class=\"comment\"># 首页文章统计数量前是否显示文字描述（本文字数、阅读时长）</span></span><br><span class=\"line\"> <span class=\"comment\"># item_text_total: false   # 页面底部统计数量前是否显示文字描述（站点总字数、站点阅读时长）</span></span><br><span class=\"line\">  awl: 4                   <span class=\"comment\"># Average Word Length</span></span><br><span class=\"line\">  wpm: 275                 <span class=\"comment\"># Words Per Minute（每分钟阅读词数）</span></span><br><span class=\"line\">  suffix: mins.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ---------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># Site Information Settings 网页小图标</span></span><br><span class=\"line\"><span class=\"comment\"># See: https://theme-next.org/docs/getting-started/</span></span><br><span class=\"line\"><span class=\"comment\"># ---------------------------------------------------------------</span></span><br><span class=\"line\">favicon:</span><br><span class=\"line\">  small: /images/qpp.png</span><br><span class=\"line\">  medium: /images/qpp.png</span><br><span class=\"line\">  apple_touch_icon: /images/apple-touch-icon-next.png</span><br><span class=\"line\">  safari_pinned_tab: /images/logo.svg</span><br><span class=\"line\">  <span class=\"comment\">#android_manifest: /images/manifest.json</span></span><br><span class=\"line\">  <span class=\"comment\">#ms_browserconfig: /images/browserconfig.xml</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ---------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"comment\"># Sidebar Settings 文章的目录显示位置</span></span><br><span class=\"line\"><span class=\"comment\"># See: https://theme-next.org/docs/theme-settings/sidebar</span></span><br><span class=\"line\"><span class=\"comment\"># ---------------------------------------------------------------</span></span><br><span class=\"line\">sidebar:</span><br><span class=\"line\">  <span class=\"comment\"># Sidebar Position.</span></span><br><span class=\"line\">  <span class=\"comment\">#position: left</span></span><br><span class=\"line\">  position: right</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Social Links</span></span><br><span class=\"line\"><span class=\"comment\"># Usage: `Key: permalink || icon`</span></span><br><span class=\"line\"><span class=\"comment\"># Key is the link label showing to end users.</span></span><br><span class=\"line\"><span class=\"comment\"># Value before `||` delimiter is the target permalink, value after `||` delimiter is the name of Font Awesome icon.</span></span><br><span class=\"line\">social:</span><br><span class=\"line\">  GitHub: https://github.com/dooubb  || fab fa-github</span><br><span class=\"line\">  E-Mail: fanq1213@163.com || fa fa-envelope</span><br><span class=\"line\"></span><br><span class=\"line\">social_icons:</span><br><span class=\"line\">  <span class=\"built_in\">enable</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">  icons_only: <span class=\"literal\">false</span></span><br><span class=\"line\">  transition: <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Local Search 本地搜索</span></span><br><span class=\"line\"><span class=\"comment\"># Dependencies: https://github.com/theme-next/hexo-generator-searchdb</span></span><br><span class=\"line\">local_search:</span><br><span class=\"line\">  <span class=\"built_in\">enable</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"comment\"># If auto, trigger search by changing input.</span></span><br><span class=\"line\">  <span class=\"comment\"># If manual, trigger search by pressing enter key or search button.</span></span><br><span class=\"line\">  trigger: auto</span><br><span class=\"line\">  <span class=\"comment\"># Show top n results per article, show all results by setting to -1</span></span><br><span class=\"line\">  top_n_per_article: 1</span><br><span class=\"line\">  <span class=\"comment\"># Unescape html strings to the readable one.</span></span><br><span class=\"line\">  unescape: <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"comment\"># Preload the search data when the page loads.</span></span><br><span class=\"line\">  preload: <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#文章创建时间和更新时间</span></span><br><span class=\"line\"><span class=\"comment\"># Post meta display settings</span></span><br><span class=\"line\">post_meta:</span><br><span class=\"line\">  item_text: <span class=\"literal\">true</span></span><br><span class=\"line\">  created_at: <span class=\"literal\">true</span></span><br><span class=\"line\">  updated_at:</span><br><span class=\"line\">    <span class=\"built_in\">enable</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">    another_day: <span class=\"literal\">false</span>  <span class=\"comment\">#如果是true表示同一天只显示创建时间</span></span><br><span class=\"line\">  categories: <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"修改首页文章标题和统计信息居中\"><a href=\"#修改首页文章标题和统计信息居中\" class=\"headerlink\" title=\"修改首页文章标题和统计信息居中\"></a>修改首页文章标题和统计信息居中</h2><p><code>替换themes/next/source/css/_schemes/Mist/_posts-expanded.styl文件内容</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">// Post Expand</span><br><span class=\"line\">// --------------------------------------------------</span><br><span class=\"line\">.posts-expand &#123;</span><br><span class=\"line\">  &amp;.index &#123;</span><br><span class=\"line\">    .post-title&#123;</span><br><span class=\"line\">      text-align: center; <span class=\"comment\">#文章标题</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    .post-meta &#123;</span><br><span class=\"line\">      text-align: center; <span class=\"comment\">#统计信息</span></span><br><span class=\"line\"></span><br><span class=\"line\">      +<span class=\"function\"><span class=\"title\">mobile</span></span>() &#123;</span><br><span class=\"line\">        text-align: center;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    .post-meta &#123;</span><br><span class=\"line\">      margin: 5px 0 20px 0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .post-eof &#123;</span><br><span class=\"line\">    display: none;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .post-block:not(:first-child) &#123;</span><br><span class=\"line\">    margin-top: 120px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .post-title, .post-meta &#123;</span><br><span class=\"line\">    text-align: center;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .post-body img &#123;</span><br><span class=\"line\">    margin-left: 0;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .post-tags &#123;</span><br><span class=\"line\">    text-align: left;</span><br><span class=\"line\"></span><br><span class=\"line\">    a &#123;</span><br><span class=\"line\">      background: <span class=\"variable\">$whitesmoke</span>;</span><br><span class=\"line\">      border-bottom: none;</span><br><span class=\"line\">      padding: 1px 5px;</span><br><span class=\"line\"></span><br><span class=\"line\">      &amp;:hover &#123;</span><br><span class=\"line\">        background: <span class=\"variable\">$grey</span>-light;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  .post-nav &#123;</span><br><span class=\"line\">    margin-top: 40px;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">.post-button &#123;</span><br><span class=\"line\">  margin-top: 20px;</span><br><span class=\"line\">  text-align: left;</span><br><span class=\"line\"></span><br><span class=\"line\">  .btn &#123;</span><br><span class=\"line\">    // color: <span class=\"variable\">$grey</span>-dim;</span><br><span class=\"line\">    background: none;</span><br><span class=\"line\">    border: 0;</span><br><span class=\"line\">    border-bottom: 2px solid var(--btn-default-border-color);</span><br><span class=\"line\">    padding: 0;</span><br><span class=\"line\">    transition-property: border;</span><br><span class=\"line\"></span><br><span class=\"line\">    &amp;:hover &#123;</span><br><span class=\"line\">      border-bottom-color: var(--btn-default-hover-border-color);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"添加网站运行时长和备案号\"><a href=\"#添加网站运行时长和备案号\" class=\"headerlink\" title=\"添加网站运行时长和备案号\"></a>添加网站运行时长和备案号</h2><p><code>全部替换themes\\next\\layout\\_partials\\footer.swig文件</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">&#123;%- <span class=\"keyword\">if</span> theme.footer.beian.enable %&#125;</span><br><span class=\"line\">  &lt;div class=<span class=\"string\">&quot;beian&quot;</span>&gt;</span><br><span class=\"line\">    &#123;&#123;- next_url(<span class=\"string\">&#x27;https://beian.miit.gov.cn&#x27;</span>, theme.footer.beian.icp + <span class=\"string\">&#x27; &#x27;</span>) &#125;&#125;</span><br><span class=\"line\">    &#123;%- <span class=\"keyword\">if</span> theme.footer.beian.gongan_icon_url %&#125;</span><br><span class=\"line\">      &lt;img src=<span class=\"string\">&quot;&#123;&#123; url_for(theme.footer.beian.gongan_icon_url) &#125;&#125;&quot;</span> style=<span class=\"string\">&quot;display: inline-block;&quot;</span>&gt;</span><br><span class=\"line\">    &#123;%- endif %&#125;</span><br><span class=\"line\">    &#123;%- <span class=\"keyword\">if</span> theme.footer.beian.gongan_id and theme.footer.beian.gongan_num %&#125;</span><br><span class=\"line\">      &#123;&#123;- next_url(<span class=\"string\">&#x27;http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=&#x27;</span> + theme.footer.beian.gongan_id, theme.footer.beian.gongan_num + <span class=\"string\">&#x27; &#x27;</span>) &#125;&#125;</span><br><span class=\"line\">    &#123;%- endif %&#125;</span><br><span class=\"line\">  &lt;/div&gt;</span><br><span class=\"line\">&#123;%- endif %&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;div class=<span class=\"string\">&quot;copyright&quot;</span>&gt;</span><br><span class=\"line\">  &#123;%- <span class=\"built_in\">set</span> copyright_year = <span class=\"built_in\">date</span>(null, <span class=\"string\">&#x27;YYYY&#x27;</span>) %&#125;</span><br><span class=\"line\">  &amp;copy; &#123;% <span class=\"keyword\">if</span> theme.footer.since and theme.footer.since != copyright_year %&#125;&#123;&#123; theme.footer.since &#125;&#125; – &#123;% endif %&#125;</span><br><span class=\"line\">  &lt;span itemprop=<span class=\"string\">&quot;copyrightYear&quot;</span>&gt;&#123;&#123; copyright_year &#125;&#125;&lt;/span&gt;</span><br><span class=\"line\">  &lt;span class=<span class=\"string\">&quot;with-love&quot;</span>&gt;</span><br><span class=\"line\">    &lt;i class=<span class=\"string\">&quot;&#123;&#123; theme.footer.icon.name &#125;&#125;&quot;</span>&gt;&lt;/i&gt;</span><br><span class=\"line\">  &lt;/span&gt;</span><br><span class=\"line\">  &lt;span class=<span class=\"string\">&quot;author&quot;</span> itemprop=<span class=\"string\">&quot;copyrightHolder&quot;</span>&gt;&#123;&#123; theme.footer.copyright or author &#125;&#125; &amp;&amp; &lt;span <span class=\"built_in\">id</span>=<span class=\"string\">&quot;sitetime&quot;</span>&gt;&lt;/span&gt;</span><br><span class=\"line\">  &lt;script language=javascript&gt;</span><br><span class=\"line\">\t<span class=\"keyword\">function</span> <span class=\"function\"><span class=\"title\">siteTime</span></span>()&#123;</span><br><span class=\"line\">\t\twindow.setTimeout(<span class=\"string\">&quot;siteTime()&quot;</span>, 1000);</span><br><span class=\"line\">\t\tvar seconds = 1000;</span><br><span class=\"line\">\t\tvar minutes = seconds * 60;</span><br><span class=\"line\">\t\tvar hours = minutes * 60;</span><br><span class=\"line\">\t\tvar days = hours * 24;</span><br><span class=\"line\">\t\tvar years = days * 365;</span><br><span class=\"line\">\t\tvar today = new Date();</span><br><span class=\"line\">\t\tvar todayYear = today.getFullYear();</span><br><span class=\"line\">\t\tvar todayMonth = today.getMonth()+1;</span><br><span class=\"line\">\t\tvar todayDate = today.getDate();</span><br><span class=\"line\">\t\tvar todayHour = today.getHours();</span><br><span class=\"line\">\t\tvar todayMinute = today.getMinutes();</span><br><span class=\"line\">\t\tvar todaySecond = today.getSeconds();</span><br><span class=\"line\">\t\t/* Date.UTC() -- 返回<span class=\"built_in\">date</span>对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)</span><br><span class=\"line\">\t\tyear - 作为<span class=\"built_in\">date</span>对象的年份，为4位年份值</span><br><span class=\"line\">\t\tmonth - 0-11之间的整数，做为<span class=\"built_in\">date</span>对象的月份</span><br><span class=\"line\">\t\tday - 1-31之间的整数，做为<span class=\"built_in\">date</span>对象的天数</span><br><span class=\"line\">\t\thours - 0(午夜24点)-23之间的整数，做为<span class=\"built_in\">date</span>对象的小时数</span><br><span class=\"line\">\t\tminutes - 0-59之间的整数，做为<span class=\"built_in\">date</span>对象的分钟数</span><br><span class=\"line\">\t\tseconds - 0-59之间的整数，做为<span class=\"built_in\">date</span>对象的秒数</span><br><span class=\"line\">\t\tmicroseconds - 0-999之间的整数，做为<span class=\"built_in\">date</span>对象的毫秒数 */</span><br><span class=\"line\">\t\tvar t1 = Date.UTC(2018,02,13,15,00,00); //北京时间2018-2-13 00:00:00</span><br><span class=\"line\">\t\tvar t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);</span><br><span class=\"line\">\t\tvar diff = t2-t1;</span><br><span class=\"line\">\t\tvar diffYears = Math.floor(diff/years);</span><br><span class=\"line\">\t\tvar diffDays = Math.floor((diff/days)-diffYears*<span class=\"number\">365</span>);</span><br><span class=\"line\">\t\tvar diffHours = Math.floor((diff-(diffYears*<span class=\"number\">365</span>+diffDays)*days)/hours);</span><br><span class=\"line\">\t\tvar diffMinutes = Math.floor((diff-(diffYears*<span class=\"number\">365</span>+diffDays)*days-diffHours*hours)/minutes);</span><br><span class=\"line\">\t\tvar diffSeconds = Math.floor((diff-(diffYears*<span class=\"number\">365</span>+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);</span><br><span class=\"line\">\t\tdocument.getElementById(&quot;sitetime&quot;).innerHTML=&quot; 已运行&quot;+/*diffYears+&quot; 年 &quot;+*/diffDays+&quot; 天 &quot;+diffHours+&quot; 小时 &quot;+diffMinutes+&quot; 分钟 &quot;+diffSeconds+&quot; 秒&quot;;</span><br><span class=\"line\">\t&#125;/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/</span><br><span class=\"line\">\tsiteTime();</span><br><span class=\"line\">&lt;/script&gt;&lt;/span&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;%- if theme.footer.powered %&#125;</span><br><span class=\"line\">  &lt;div class=&quot;powered-by&quot;&gt;</span><br><span class=\"line\">    &#123;%- set next_site = &#x27;https://theme-next.org&#x27; %&#125;</span><br><span class=\"line\">    &#123;%- if theme.scheme !== &#x27;Gemini&#x27; %&#125;</span><br><span class=\"line\">      &#123;%- set next_site = &#x27;https://&#x27; + theme.scheme | lower + &#x27;.theme-next.org&#x27; %&#125;</span><br><span class=\"line\">    &#123;%- endif %&#125;</span><br><span class=\"line\">    &#123;&#123;- __(&#x27;footer.powered&#x27;, next_url(&#x27;https://hexo.io&#x27;, &#x27;Hexo&#x27;, &#123;class: &#x27;theme-link&#x27;&#125;) + &#x27; &amp; &#x27; + next_url(next_site, &#x27;NexT.&#x27; + theme.scheme, &#123;class: &#x27;theme-link&#x27;&#125;)) &#125;&#125;</span><br><span class=\"line\">    &lt;a href=<span class=\"string\">&quot;https://beian.miit.gov.cn/&quot;</span>&gt;京ICP备2022022850号-1&lt;/a&gt;</span><br><span class=\"line\">  &lt;/div&gt;</span><br><span class=\"line\">&#123;%- endif %&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;%- <span class=\"keyword\">if</span> theme.add_this_id %&#125;</span><br><span class=\"line\">  &lt;div class=<span class=\"string\">&quot;addthis_inline_share_toolbox&quot;</span>&gt;</span><br><span class=\"line\">    &lt;script src=<span class=\"string\">&quot;//s7.addthis.com/js/300/addthis_widget.js#pubid=&#123;&#123; theme.add_this_id &#125;&#125;&quot;</span> async=<span class=\"string\">&quot;async&quot;</span>&gt;&lt;/script&gt;</span><br><span class=\"line\">  &lt;/div&gt;</span><br><span class=\"line\">&#123;%- endif %&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&#123;- next_inject(<span class=\"string\">&#x27;footer&#x27;</span>) &#125;&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n","categories":["hexo"],"tags":["hexo"]},{"title":"next启用fancybox","url":"/hexo/next-enable-fancybox/","content":"<h1 id=\"开启-fancybox\"><a href=\"#开启-fancybox\" class=\"headerlink\" title=\"开启 fancybox\"></a>开启 fancybox</h1><p>在 <code>theme/next/</code> 文件夹下找到 Next 7.0+ 主题的 <code>_config.yml</code> 配置文件</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># FancyBox is a tool that offers a nice and elegant way to add zooming functionality for images.</span></span><br><span class=\"line\"><span class=\"comment\"># For more information: https://fancyapps.com/fancybox</span></span><br><span class=\"line\"><span class=\"attr\">fancybox:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<p>启用后<code>fancybox</code>，<code>hexo</code>文章中的图片可以点击放大查看，文章中的显示如下图</p>\n<p><img src=\"/hexo/next-enable-fancybox/image-20240708214608291.png\" alt=\"image-20240708214608291\"></p>\n<p>但是文章中的图片下面会有 md 文件中引用图片的名字(默认是[]中的名字)</p>\n<span id=\"more\"></span>\n\n<h1 id=\"fancybox-隐藏图片标题\"><a href=\"#fancybox-隐藏图片标题\" class=\"headerlink\" title=\"fancybox 隐藏图片标题\"></a>fancybox 隐藏图片标题</h1><p>更改<code>D:\\hexo\\themes\\next\\source\\js\\utils.js</code>中的代码</p>\n<figure class=\"highlight js\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//原值</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> imageTitle = $image.<span class=\"title function_\">attr</span>(<span class=\"string\">&#x27;title&#x27;</span>) || $image.<span class=\"title function_\">attr</span>(<span class=\"string\">&#x27;alt&#x27;</span>);</span><br><span class=\"line\"><span class=\"comment\">//更改后的</span></span><br><span class=\"line\"><span class=\"keyword\">var</span> imageTitle =  $image.<span class=\"title function_\">attr</span>(<span class=\"string\">&#x27;alt&#x27;</span>);</span><br></pre></td></tr></table></figure>\n\n<p>更改后文章中的显示</p>\n<p><img src=\"/hexo/next-enable-fancybox/image-20240708214927642.png\" alt=\"image-20240708214927642\"></p>\n","categories":["hexo"],"tags":["hexo"]},{"title":"kustomization的使用","url":"/k8s/kustomization/","content":"<h1 id=\"安装-kustomize-命令\"><a href=\"#安装-kustomize-命令\" class=\"headerlink\" title=\"安装 kustomize 命令\"></a>安装 kustomize 命令</h1><figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/sh</span></span><br><span class=\"line\">wget https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize/v5.4.3/kustomize_v5.4.3_linux_amd64.tar.gz &gt;/dev/null 2&gt;&amp;1</span><br><span class=\"line\">tar -xzvf kustomize_v5.4.3_linux_amd64.tar.gz -C /usr/local/bin/ &gt;/dev/null 2&gt;&amp;1</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x /usr/local/bin/kustomize</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"kustomization\"><a href=\"#kustomization\" class=\"headerlink\" title=\"kustomization\"></a>kustomization</h1><p>kustomize 是一个通过 kustomization 文件定制 kubernetes 对象的工具，它可以通过一些资源生成一些新的资源，也可以定制不同的资源的集合。</p>\n<h2 id=\"kustomization-常见目录布局\"><a href=\"#kustomization-常见目录布局\" class=\"headerlink\" title=\"kustomization 常见目录布局\"></a>kustomization 常见目录布局</h2><figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">├──</span> <span class=\"string\">base</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">├──</span> <span class=\"string\">deployment.yaml</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">├──</span> <span class=\"string\">kustomization.yaml</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">└──</span> <span class=\"string\">service.yaml</span></span><br><span class=\"line\"><span class=\"string\">└──</span> <span class=\"string\">overlays</span></span><br><span class=\"line\">    <span class=\"string\">├──</span> <span class=\"string\">dev</span></span><br><span class=\"line\">    <span class=\"string\">│</span>   <span class=\"string\">├──</span> <span class=\"string\">kustomization.yaml</span></span><br><span class=\"line\">    <span class=\"string\">│</span>   <span class=\"string\">└──</span> <span class=\"string\">patch.yaml</span></span><br><span class=\"line\">    <span class=\"string\">├──</span> <span class=\"string\">prod</span></span><br><span class=\"line\">    <span class=\"string\">│</span>   <span class=\"string\">├──</span> <span class=\"string\">kustomization.yaml</span></span><br><span class=\"line\">    <span class=\"string\">│</span>   <span class=\"string\">└──</span> <span class=\"string\">patch.yaml</span></span><br><span class=\"line\">    <span class=\"string\">└──</span> <span class=\"string\">staging</span></span><br><span class=\"line\">        <span class=\"string\">├──</span> <span class=\"string\">kustomization.yaml</span></span><br><span class=\"line\">        <span class=\"string\">└──</span> <span class=\"string\">patch.yaml</span></span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><p><code>/bases</code>目录保存的是基本的配置</p>\n</li>\n<li><p><code>/overlays</code>【此文件夹也可以省略】里放置的不同环境的配置，例如 <code>/dev</code>、<code>/staging</code>，<code>/prod</code>这些就是不同环境的配置，</p>\n</li>\n<li><p><code>/base</code>等文件夹下都有一个 kustomization .yml 文件，用于配置。</p>\n</li>\n</ul>\n<span id=\"more\"></span>\n\n<h2 id=\"kustomization-自定义目录布局\"><a href=\"#kustomization-自定义目录布局\" class=\"headerlink\" title=\"kustomization 自定义目录布局\"></a>kustomization 自定义目录布局</h2><figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">├──</span> <span class=\"string\">base</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">├──</span> <span class=\"string\">configmap</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">│</span>   <span class=\"string\">├──</span> <span class=\"string\">configmap.yaml</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">│</span>   <span class=\"string\">└──</span> <span class=\"string\">kustomization.yaml</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">├──</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">│</span>   <span class=\"string\">├──</span> <span class=\"string\">deployment.yaml</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">│</span>   <span class=\"string\">├──</span> <span class=\"string\">kustomization.yaml</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">│</span>   <span class=\"string\">└──</span> <span class=\"string\">service.yaml</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">└──</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"string\">│</span>       <span class=\"string\">├──</span> <span class=\"string\">deployment.yaml</span></span><br><span class=\"line\"><span class=\"string\">│</span>       <span class=\"string\">├──</span> <span class=\"string\">kustomization.yaml</span></span><br><span class=\"line\"><span class=\"string\">│</span>       <span class=\"string\">└──</span> <span class=\"string\">service.yaml</span></span><br><span class=\"line\"><span class=\"string\">└──</span> <span class=\"string\">overlays</span></span><br><span class=\"line\">    <span class=\"string\">├──</span> <span class=\"string\">dev</span></span><br><span class=\"line\">    <span class=\"string\">│</span>   <span class=\"string\">├──</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"string\">│</span>   <span class=\"string\">│</span>   <span class=\"string\">├──</span> <span class=\"string\">kustomization.yaml</span></span><br><span class=\"line\">    <span class=\"string\">│</span>   <span class=\"string\">│</span>   <span class=\"string\">└──</span> <span class=\"string\">patch.yaml</span></span><br><span class=\"line\">    <span class=\"string\">│</span>   <span class=\"string\">└──</span> <span class=\"string\">redis</span></span><br><span class=\"line\">    <span class=\"string\">│</span>       <span class=\"string\">├──</span> <span class=\"string\">kustomization.yaml</span></span><br><span class=\"line\">    <span class=\"string\">│</span>       <span class=\"string\">└──</span> <span class=\"string\">patch.yaml</span></span><br><span class=\"line\">    <span class=\"string\">├──</span> <span class=\"string\">prod</span></span><br><span class=\"line\">    <span class=\"string\">└──</span> <span class=\"string\">staging</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"kustomization-yml-常用字段详解\"><a href=\"#kustomization-yml-常用字段详解\" class=\"headerlink\" title=\"kustomization.yml 常用字段详解\"></a>kustomization.yml 常用字段详解</h1><p>kustomize 提供了比较丰富的字段选择，除此之外还可以自定义插件，下面会大概列举一下每个字段的含义，当我们需要用到的时候知道有这么个能力，然后再去 Kustomize 官方文档 查找对应的 API 文档就行了。kustomization.yaml 中常用字段参考官方文档:</p>\n<ul>\n<li><a href=\"https://kubectl.docs.kubernetes.io/zh/api-reference/kustomization/\">kustomization.yaml | SIG CLI</a></li>\n<li><a href=\"https://kubectl.docs.kubernetes.io/references/kustomize/kustomization/\">The Kustomization File | SIG CLI</a></li>\n</ul>\n<h2 id=\"resources\"><a href=\"#resources\" class=\"headerlink\" title=\"resources \"></a><code>resources </code></h2><p>表示 k8s 资源的位置，这个可以是一个文件，也可以指向一个文件夹，读取的时候会按照顺序读取，路径可以是相对路径也可以是绝对路径，如果是相对路径那么就是相对于 <code>kustomization.yml</code>的路径</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kustomize.config.k8s.io/v1beta1</span> <span class=\"comment\">#创建该对象所使用的API版本</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Kustomization</span> <span class=\"comment\">#创建的对象的类别</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resources:</span> <span class=\"comment\">#资源文件的位置</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">nginx.yaml</span> <span class=\"comment\">#资源文件为当前文件夹下的nginx.yaml</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">../configmap</span> <span class=\"comment\">#资源文件为当前文件夹同级文件夹config</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"namespace\"><a href=\"#namespace\" class=\"headerlink\" title=\"namespace\"></a><code>namespace</code></h2><p>为所有资源添加 <code>namespace</code></p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kustomize.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Kustomization</span></span><br><span class=\"line\"><span class=\"attr\">namespace:</span> <span class=\"string\">doubao</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"images\"><a href=\"#images\" class=\"headerlink\" title=\"images\"></a><code>images</code></h2><p>修改镜像的<code>name</code>、<code>tag</code> 或 <code>image digest</code> ，而无需使用 <code>patches</code> 。例如，对于这种 kubernetes Deployment 片段：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"string\">...</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">dockerhub.qingcloud.com/doubao/nginx:latest</span></span><br></pre></td></tr></table></figure>\n\n<p>想要将 <code>image</code> 做如下更改：</p>\n<ul>\n<li>将 nginx tag 从 <code>latest</code> 改为 <code>stable-perl</code></li>\n</ul>\n<p>只需在 <code>kustomization</code> 中添加以下内容：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kustomize.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Kustomization</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">images:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">dockerhub.qingcloud.com/doubao/nginx</span> <span class=\"comment\">#deploy中的镜像名字</span></span><br><span class=\"line\">  <span class=\"attr\">newName:</span> <span class=\"string\">dockerhub.qingcloud.com/doubao/nginx</span> <span class=\"comment\">#新的镜像名字</span></span><br><span class=\"line\">  <span class=\"attr\">newTag:</span> <span class=\"string\">stable-perl</span> <span class=\"comment\">#新的镜像的tag</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"replicas\"><a href=\"#replicas\" class=\"headerlink\" title=\"replicas\"></a><code>replicas</code></h2><p>修改资源副本数</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kustomize.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Kustomization</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">replicas:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">  <span class=\"attr\">count:</span> <span class=\"number\">5</span></span><br></pre></td></tr></table></figure>\n\n<p>该字段内容为列表，所以可以同时修改许多资源。</p>\n<p>由于这个声明无法设置 <code>kind:</code> 或 <code>group:</code>，所以他只能匹配如下资源中的一种：</p>\n<ul>\n<li><code>Deployment</code></li>\n<li><code>ReplicationController</code></li>\n<li><code>ReplicaSet</code></li>\n<li><code>StatefulSet</code></li>\n</ul>\n<h2 id=\"namePrefix\"><a href=\"#namePrefix\" class=\"headerlink\" title=\"namePrefix\"></a><code>namePrefix</code></h2><p>为所有资源和引用的名称添加前缀</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kustomize.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Kustomization</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">namePrefix:</span> <span class=\"string\">doubao-</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"nameSuffix\"><a href=\"#nameSuffix\" class=\"headerlink\" title=\"nameSuffix\"></a><code>nameSuffix</code></h2><p>为所有资源和引用的名称添加后缀</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kustomize.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Kustomization</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">nameSuffix:</span> <span class=\"string\">-v2</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"patches\"><a href=\"#patches\" class=\"headerlink\" title=\"patches\"></a><code>patches</code></h2><p>在资源上添加或覆盖字段，<code>Kustomization</code> 使用 <code>patches</code> 字段来提供该功能。</p>\n<p><code>patches</code> 字段包含要按指定顺序应用的 patch 列表。</p>\n<p>patch 可以:</p>\n<ul>\n<li>是一个 <code>strategic merge patch</code>，或者是一个 <code>JSON patch</code>。</li>\n<li>也可以是 patch 文件或 inline string</li>\n<li>针对单个资源或多个资源</li>\n</ul>\n<p>目标选择器可以通过 group、version、kind、name、namespace、标签选择器和注释选择器来选择资源，选择一个或多个匹配所有<strong>指定</strong>字段的资源来应用 patch。</p>\n<p><code>patch.yml更该了镜像拉取策略和pod的实例数</code></p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">6</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br></pre></td></tr></table></figure>\n\n<p><code>patch.json中修改了deployment的name和部署镜像后的名字</code></p>\n<figure class=\"highlight json\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">[</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;op&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;replace&quot;</span><span class=\"punctuation\">,</span> <span class=\"attr\">&quot;path&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;/metadata/name&quot;</span><span class=\"punctuation\">,</span> <span class=\"attr\">&quot;value&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;jsonredis&quot;</span> <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#123;</span> <span class=\"attr\">&quot;op&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;add&quot;</span><span class=\"punctuation\">,</span> <span class=\"attr\">&quot;path&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;/spec/template/spec/containers/0/name&quot;</span><span class=\"punctuation\">,</span> <span class=\"attr\">&quot;value&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;jsonredis&quot;</span><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">]</span></span><br></pre></td></tr></table></figure>\n\n<p><code>kustomization.yml中添加了patch</code></p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kustomize.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Kustomization</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resources:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">../../../base/redis</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改base/redis/redis.yml中的replicas</span></span><br><span class=\"line\"><span class=\"attr\">replicas:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">    <span class=\"attr\">count:</span> <span class=\"number\">5</span></span><br><span class=\"line\"><span class=\"comment\">#修改base/redis/redis.yml中的镜像</span></span><br><span class=\"line\"><span class=\"attr\">images:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">dockerhub.qingcloud.com/doubao/redis</span></span><br><span class=\"line\">    <span class=\"attr\">newName:</span> <span class=\"string\">dockerhub.qingcloud.com/doubao/redis</span></span><br><span class=\"line\">    <span class=\"attr\">newTag:</span> <span class=\"string\">latest</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#patch属性来添加或者覆盖</span></span><br><span class=\"line\"><span class=\"attr\">patches:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">patch.yaml</span> <span class=\"comment\">#使用patch.yml中的参数覆盖base/redis/redis.yml，和patchesStrategicMerge一样</span></span><br><span class=\"line\">    <span class=\"attr\">target:</span></span><br><span class=\"line\">      <span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">patch:</span> <span class=\"string\">|-</span> \t\t\t<span class=\"comment\">#使用json的方式来替换base/redis/redis.ym.和patchesJson6902一样</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">op:</span> <span class=\"string\">replace</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/spec/template/spec/containers/0/name</span></span><br><span class=\"line\">        <span class=\"attr\">value:</span> <span class=\"string\">bigredis</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">op:</span> <span class=\"string\">replace</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/spec/template/spec/containers/0/ports/0/containerPort</span></span><br><span class=\"line\">        <span class=\"attr\">value:</span> <span class=\"number\">8001</span></span><br><span class=\"line\">    <span class=\"attr\">target:</span></span><br><span class=\"line\">      <span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">patch.json</span> <span class=\"comment\">#使用patch.json中的参数覆盖base/redis/redis.yml，和patchesJson6902一样</span></span><br><span class=\"line\">    <span class=\"attr\">target:</span></span><br><span class=\"line\">      <span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span> <span class=\"comment\">#所选择的对象类别</span></span><br><span class=\"line\">      <span class=\"attr\">version:</span> <span class=\"string\">v1</span> <span class=\"comment\">#对象的版本</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">redis</span> <span class=\"comment\">#deployment的name</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">namespace:</span> <span class=\"string\">doubao</span></span><br><span class=\"line\"><span class=\"attr\">namePrefix:</span> <span class=\"string\">poc-</span></span><br><span class=\"line\"><span class=\"attr\">nameSuffix:</span> <span class=\"string\">-v2</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"patchesJson6902\"><a href=\"#patchesJson6902\" class=\"headerlink\" title=\"patchesJson6902\"></a><code>patchesJson6902</code></h3><p>列表中的每个条目都应可以解析为 <code>kubernetes</code> 对象和将应用于该对象的 <code>JSON patch</code>。</p>\n<p><code>patch.json</code></p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\">[</span><br><span class=\"line\">  &#123; <span class=\"attr\">&quot;op&quot;:</span> <span class=\"string\">&quot;replace&quot;</span>, <span class=\"attr\">&quot;path&quot;:</span> <span class=\"string\">&quot;/metadata/name&quot;</span>, <span class=\"attr\">&quot;value&quot;:</span> <span class=\"string\">&quot;jsonredis&quot;</span> &#125;,</span><br><span class=\"line\">  &#123; <span class=\"attr\">&quot;op&quot;:</span> <span class=\"string\">&quot;add&quot;</span>, <span class=\"attr\">&quot;path&quot;:</span> <span class=\"string\">&quot;/spec/template/spec/containers/0/name&quot;</span>, <span class=\"attr\">&quot;value&quot;:</span> <span class=\"string\">&quot;jsonredis&quot;</span>&#125;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"patchesStrategicMerge\"><a href=\"#patchesStrategicMerge\" class=\"headerlink\" title=\"patchesStrategicMerge\"></a><code>patchesStrategicMerge</code></h3><p>使用 <code>strategic merge patch</code> 标准 <code>Patch resources</code>.</p>\n<p><code>patch.yml</code></p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">6</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">Always</span></span><br></pre></td></tr></table></figure>\n\n<p><code>commonAnnotations</code> 为所有资源加上 <code>annotations</code> 如果对应的 key 已经存在值，这个值将会被覆盖</p>\n<p><code>commonLabels</code> 为所有资源的加上 <code>label</code> 和 <code>label selector</code> 注意：这个操作会比较危险</p>\n<h2 id=\"configMapGenerator\"><a href=\"#configMapGenerator\" class=\"headerlink\" title=\"configMapGenerator\"></a><code>configMapGenerator</code></h2><p>列表中的每个条目都将生成一个 ConfigMap （合计可以生成 n 个 ConfigMap）。</p>\n<p>以下示例创建四个 ConfigMap：</p>\n<ul>\n<li>第一个使用给定文件的名称和内容创建数据</li>\n<li>第二个使用文件中的键&#x2F;值对将数据创建为键&#x2F;值</li>\n<li>第三个使用 <code>literals</code> 中的键&#x2F;值对创建数据作为键&#x2F;值</li>\n<li>第四个通过 <code>options</code> 设置单个 ConfigMap 的注释和标签</li>\n</ul>\n<p>每个 configMapGenerator 项均接受的参数 <code>behavior: [create|replace|merge]</code>，这个参数允许修改或替换父级现有的 configMap。</p>\n<p>此外，每个条目都有一个 <code>options</code> 字段，该字段具有与 kustomization 文件的 <code>generatorOptions</code> 字段相同的子字段。</p>\n<p><code>options</code> 字段允许用户为生成的实例添加标签和（或）注释，或者分别禁用该实例名称的哈希后缀。此处添加的标签和注释不会被 kustomization 文件 <code>generatorOptions</code> 字段关联的全局选项覆盖。但是如果全局 <code>generatorOptions</code> 字段指定 <code>disableNameSuffixHash: true</code>，其他 <code>options</code> 的设置将无法将其覆盖。</p>\n<h3 id=\"ConfigMap-from-file\"><a href=\"#ConfigMap-from-file\" class=\"headerlink\" title=\"ConfigMap from file\"></a>ConfigMap from file</h3><p><code>kustomization.yml</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kustomize.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Kustomization</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resources:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">../../../base/redis</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">generatorOptions:</span> <span class=\"comment\">#全局设置</span></span><br><span class=\"line\">  <span class=\"attr\">disableNameSuffixHash:</span> <span class=\"literal\">true</span> <span class=\"comment\">#禁止在CM的名字后面添加hash值</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">configMapGenerator:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">base-config</span> <span class=\"comment\">#已经存在的configMap的名字</span></span><br><span class=\"line\">  <span class=\"attr\">behavior:</span> <span class=\"string\">merge</span> <span class=\"comment\">#将新生成的configMap合并到上面已经存在的CM中</span></span><br><span class=\"line\">  <span class=\"attr\">file:</span> <span class=\"comment\">#根据下面的资源文件生产的CM</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">application.properties</span> <span class=\"comment\">#同级目录下的资源文件</span></span><br><span class=\"line\">  <span class=\"attr\">options:</span></span><br><span class=\"line\">    <span class=\"attr\">disableNameSuffixHash:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<p><code>application.properties</code></p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">dou</span>=<span class=\"string\">bao #根据此键值对生产CM</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ConfigMap-from-env-file\"><a href=\"#ConfigMap-from-env-file\" class=\"headerlink\" title=\"ConfigMap from env file\"></a>ConfigMap from env file</h3><p><code>kustomization.yml</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kustomize.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Kustomization</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resources:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">../../../base/redis</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">generatorOptions:</span> <span class=\"comment\">#全局设置</span></span><br><span class=\"line\">  <span class=\"attr\">disableNameSuffixHash:</span> <span class=\"literal\">true</span> <span class=\"comment\">#禁止在CM的名字后面添加hash值</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">configMapGenerator:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">base-config</span> <span class=\"comment\">#已经存在的configMap的名字</span></span><br><span class=\"line\">  <span class=\"attr\">behavior:</span> <span class=\"string\">merge</span> <span class=\"comment\">#将新生成的configMap合并到上面已经存在的CM中</span></span><br><span class=\"line\">  <span class=\"attr\">envs:</span> <span class=\"comment\">#根据下面的资源文件生产的CM设置成env[环境变量]</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">application.properties</span> <span class=\"comment\">#同级目录下的资源文件</span></span><br><span class=\"line\">  <span class=\"attr\">options:</span></span><br><span class=\"line\">    <span class=\"attr\">disableNameSuffixHash:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<p><code>application.properties</code></p>\n<figure class=\"highlight properties\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">dou</span>=<span class=\"string\">bao #根据此键值对生产CM</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"ConfigMap-from-Literals\"><a href=\"#ConfigMap-from-Literals\" class=\"headerlink\" title=\"ConfigMap from Literals\"></a>ConfigMap from Literals</h3><p><code>kustomization.yml</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kustomize.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Kustomization</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resources:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">../../../base/redis</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">generatorOptions:</span></span><br><span class=\"line\">  <span class=\"attr\">disableNameSuffixHash:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">configMapGenerator:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">redis-config-gen</span></span><br><span class=\"line\">  <span class=\"attr\">literals:</span>\t<span class=\"comment\">#根据此属性下的键值对生产CM</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">doubao=xixi</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"secretGenerator\"><a href=\"#secretGenerator\" class=\"headerlink\" title=\"secretGenerator\"></a><code>secretGenerator</code></h2><p>生成 Secret 资源。</p>\n<p>列表中的每个条目都将生成一个 Secret（合计可以生成 n 个 Secrets）。</p>\n<p>功能与 configMapGenerator 字段类似。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kustomize.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Kustomization</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">resources:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">../../../base/redis</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">generatorOptions:</span></span><br><span class=\"line\">  <span class=\"attr\">disableNameSuffixHash:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"attr\">secretGenerator:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">db-secret</span>\t<span class=\"comment\">#secret名字</span></span><br><span class=\"line\">    <span class=\"attr\">files:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;db.username&quot;</span> <span class=\"comment\">#从文件中读取信息</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;db.password&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p><code>db.username</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">root</span></span><br></pre></td></tr></table></figure>\n\n<p><code>db.password</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">123456</span></span><br></pre></td></tr></table></figure>\n\n<p><code>生产的db-secret</code></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">db.password:</span> <span class=\"string\">cm9vdA==</span></span><br><span class=\"line\">  <span class=\"attr\">db.username:</span> <span class=\"string\">MTIzNDU2</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">db-secret</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">doubao</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">Opaque</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"generatorOptions\"><a href=\"#generatorOptions\" class=\"headerlink\" title=\"generatorOptions\"></a><code>generatorOptions</code></h2><p>用于控制<code>configMapGenerator</code> 和<code>secretGenerator</code> 的行为</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">kustomize.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Kustomization</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">generatorOptions:</span></span><br><span class=\"line\">  <span class=\"comment\">#给所有生成的资源添加标签</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">kustomize.generated.resources:</span> <span class=\"string\">somevalue</span></span><br><span class=\"line\">  <span class=\"comment\">#给所有生成的资源添加注解</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kustomize.generated.resource:</span> <span class=\"string\">somevalue</span></span><br><span class=\"line\">  <span class=\"comment\"># true是禁止生成hash后缀</span></span><br><span class=\"line\">  <span class=\"attr\">disableNameSuffixHash:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Kustomize-的内置功能\"><a href=\"#Kustomize-的内置功能\" class=\"headerlink\" title=\"Kustomize 的内置功能\"></a>Kustomize 的内置功能</h1><p><a href=\"https://kubectl.docs.kubernetes.io/references/kustomize/builtins/\">Kustomize Built-Ins | SIG CLI (kubernetes.io)</a></p>\n","categories":["k8s"],"tags":["k8s"]},{"title":"rancher管理k8s","url":"/k8s/rancher-install-mini-k8s/","content":"<h1 id=\"初始化-rke2-集群\"><a href=\"#初始化-rke2-集群\" class=\"headerlink\" title=\"初始化 rke2 集群\"></a>初始化 rke2 集群</h1><h2 id=\"新建-4-台-Ubuntu24\"><a href=\"#新建-4-台-Ubuntu24\" class=\"headerlink\" title=\"新建 4 台 Ubuntu24\"></a>新建 4 台 Ubuntu24</h2><p>设置每台 vm 的 hostname</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">hostnamectl set-hostname master-node</span><br><span class=\"line\">hostnamectl set-hostname worker-node-01</span><br><span class=\"line\">hostnamectl set-hostname worker-node-02</span><br><span class=\"line\">hostnamectl set-hostname devops</span><br></pre></td></tr></table></figure>\n\n<p>由于 vm 是复制出来的，需要重新生成机器码并重启</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">rm</span> -rf /etc/machine-id</span><br><span class=\"line\">systemd-machine-id-setup</span><br><span class=\"line\">reboot</span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<h2 id=\"安装-master-的-rke2\"><a href=\"#安装-master-的-rke2\" class=\"headerlink\" title=\"安装 master 的 rke2\"></a>安装 master 的 rke2</h2><p>安装脚本</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -sfL https://get.rke2.io |  INSTALL_RKE2_VERSION=v1.30.1+rke2r1 sh -</span><br></pre></td></tr></table></figure>\n\n<p>设置 rke2 自启动</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rke2-server.service</span><br></pre></td></tr></table></figure>\n\n<p>启动 rke2</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl start rke2-server.service</span><br></pre></td></tr></table></figure>\n\n<p>查看启动日志</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">journalctl -u rke2-server -f</span><br></pre></td></tr></table></figure>\n\n<p>安装程序后：</p>\n<ul>\n<li><code>rke2-server</code> 服务将被安装。<code>rke2-server</code> 服务将被配置为在节点重启后或进程崩溃或被杀时自动重启。</li>\n<li>其他的实用程序将被安装在<code>/var/lib/rancher/rke2/bin/</code>。它们包括 <code>kubectl</code>, <code>crictl</code>, 和 <code>ctr</code>. 注意，这些东西默认不在你的路径上。</li>\n<li>还有两个清理脚本会安装到 <code>/usr/local/bin/rke2</code> 的路径上。它们是 <code>rke2-killall.sh</code>和<code>rke2-uninstall.sh</code>。</li>\n<li>一个 <a href=\"https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/\">kubeconfig</a> 文件将被写入<code>/etc/rancher/rke2/rke2.yaml</code>。</li>\n<li>一个可用于注册其他 server 或 agent 节点的令牌将在 <code>/var/lib/rancher/rke2/server/node-token</code> 文件中创建。</li>\n</ul>\n<h2 id=\"安装-node01-的-rke2\"><a href=\"#安装-node01-的-rke2\" class=\"headerlink\" title=\"安装 node01 的 rke2\"></a>安装 node01 的 rke2</h2><p>安装脚本</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE=<span class=\"string\">&quot;agent&quot;</span> INSTALL_RKE2_VERSION=v1.30.1+rke2r1 sh -</span><br></pre></td></tr></table></figure>\n\n<p>设置 rke2 自启动</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rke2-agent.service</span><br></pre></td></tr></table></figure>\n\n<p>修改 rke2 的&#x2F;etc&#x2F;rancher&#x2F;rke2&#x2F;config.yaml</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">server: https://192.168.121.202:9345</span><br><span class=\"line\">token: K104ef6c38212b6b606595dec8f75fe0d51d530bed461375fb2f1fcbbf9a1d1ecb9::server:07a20527579a6d49cca4f50f9d6b0372</span><br></pre></td></tr></table></figure>\n\n<p>启动 rke2</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl start rke2-agent.service</span><br></pre></td></tr></table></figure>\n\n<p>查看启动日志</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">journalctl -u rke2-server -f</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"安装-node02-的-rke2\"><a href=\"#安装-node02-的-rke2\" class=\"headerlink\" title=\"安装 node02 的 rke2\"></a>安装 node02 的 rke2</h2><p>安装脚本</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -sfL https://get.rke2.io | INSTALL_RKE2_TYPE=<span class=\"string\">&quot;agent&quot;</span> INSTALL_RKE2_VERSION=v1.30.1+rke2r1 sh -</span><br></pre></td></tr></table></figure>\n\n<p>设置 rke2 自启动</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rke2-agent.service</span><br></pre></td></tr></table></figure>\n\n<p>修改 rke2 的&#x2F;etc&#x2F;rancher&#x2F;rke2&#x2F;config.yaml</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">server: https://192.168.121.202:9345</span><br><span class=\"line\">token: K104ef6c38212b6b606595dec8f75fe0d51d530bed461375fb2f1fcbbf9a1d1ecb9::server:07a20527579a6d49cca4f50f9d6b0372</span><br></pre></td></tr></table></figure>\n\n<p>启动 rke2</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">systemctl start rke2-agent.service</span><br></pre></td></tr></table></figure>\n\n<p>查看启动日志</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">journalctl -u rke2-server -f</span><br></pre></td></tr></table></figure>\n\n<p>等待安装完成在任意 master 上执行</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@master-node:~# /var/lib/rancher/rke2/bin/kubectl --kubeconfig /etc/rancher/rke2/rke2.yaml get nodes -o wide</span><br><span class=\"line\">NAME             STATUS   ROLES                       AGE   VERSION          INTERNAL-IP       EXTERNAL-IP   OS-IMAGE           KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class=\"line\">master-node      Ready    control-plane,etcd,master   20h   v1.30.1+rke2r1   192.168.121.202   &lt;none&gt;        Ubuntu 24.04 LTS   6.8.0-36-generic   containerd://1.7.11-k3s2</span><br><span class=\"line\">worker-node-01   Ready    &lt;none&gt;                      20h   v1.30.1+rke2r1   192.168.121.203   &lt;none&gt;        Ubuntu 24.04 LTS   6.8.0-36-generic   containerd://1.7.11-k3s2</span><br><span class=\"line\">worker-node-02   Ready    &lt;none&gt;                      20h   v1.30.1+rke2r1   192.168.121.204   &lt;none&gt;        Ubuntu 24.04 LTS   6.8.0-36-generic   containerd://1.7.11-k3s2</span><br><span class=\"line\">root@master-node:~#</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"连接集群\"><a href=\"#连接集群\" class=\"headerlink\" title=\"连接集群\"></a>连接集群</h2><p>安装 kubectl</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">curl -LO <span class=\"string\">&quot;https://dl.k8s.io/release/<span class=\"subst\">$(curl -L -s https://dl.k8s.io/release/stable.txt)</span>/bin/linux/amd64/kubectl&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span> kubectl /usr/bin/</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x /usr/bin/kubectl</span><br></pre></td></tr></table></figure>\n\n<p>初始化 kubeconfig</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#将master中的/etc/rancher/rke2/rke2.yaml中的内容复制到 ~/.kube/config中,并且更改api server的url为master的ip</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p ~/.kube</span><br></pre></td></tr></table></figure>\n\n<p>执行命令</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">root@devops:~# kubectl get node -owide</span><br><span class=\"line\">NAME             STATUS   ROLES                       AGE   VERSION          INTERNAL-IP       EXTERNAL-IP   OS-IMAGE           KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class=\"line\">master-node      Ready    control-plane,etcd,master   20h   v1.30.1+rke2r1   192.168.121.202   &lt;none&gt;        Ubuntu 24.04 LTS   6.8.0-36-generic   containerd://1.7.11-k3s2</span><br><span class=\"line\">worker-node-01   Ready    &lt;none&gt;                      20h   v1.30.1+rke2r1   192.168.121.203   &lt;none&gt;        Ubuntu 24.04 LTS   6.8.0-36-generic   containerd://1.7.11-k3s2</span><br><span class=\"line\">worker-node-02   Ready    &lt;none&gt;                      20h   v1.30.1+rke2r1   192.168.121.204   &lt;none&gt;        Ubuntu 24.04 LTS   6.8.0-36-generic   containerd://1.7.11-k3s2</span><br><span class=\"line\">root@devops:~#</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"部署-rancher\"><a href=\"#部署-rancher\" class=\"headerlink\" title=\"部署 rancher\"></a>部署 rancher</h1><h2 id=\"部署-rancher-1\"><a href=\"#部署-rancher-1\" class=\"headerlink\" title=\"部署 rancher\"></a>部署 rancher</h2><figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#rancher镜像已经同步到青云的镜像仓库</span></span><br><span class=\"line\">docker run -d --restart=unless-stopped \\</span><br><span class=\"line\">  --name rancher \\</span><br><span class=\"line\">  -p 80:80 -p 443:443 \\</span><br><span class=\"line\">  --privileged \\</span><br><span class=\"line\">  dockerhub.qingcloud.com/doubao/rancher:latest</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"导入现有-k8s-集群\"><a href=\"#导入现有-k8s-集群\" class=\"headerlink\" title=\"导入现有 k8s 集群\"></a>导入现有 k8s 集群</h2><p>启动完成后，ui 登录后，导入现有集群，选项标准 k8s 即可，导入成功后的 Clusters 会显示新的集群</p>\n<p><img src=\"/k8s/rancher-install-mini-k8s/image-20240708103042614.png\" alt=\"rancher\"></p>\n","categories":["k8s"],"tags":["k8s"]},{"title":"mysql","url":"/mysql/mysql/","content":"<h1 id=\"安装-mysql9\"><a href=\"#安装-mysql9\" class=\"headerlink\" title=\"安装 mysql9\"></a>安装 mysql9</h1><p>使用<code>docker compose</code>安装</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">services:</span><br><span class=\"line\">  mysql:</span><br><span class=\"line\">    image: dockerhub.qingcloud.com/doubao/mysql:9.0.1</span><br><span class=\"line\">    container_name: mysql9</span><br><span class=\"line\">    restart: always</span><br><span class=\"line\">    environment:</span><br><span class=\"line\">      MYSQL_ROOT_PASSWORD: root</span><br><span class=\"line\">      MYSQL_USER: app</span><br><span class=\"line\">      MYSQL_PASSWORD: app</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - <span class=\"string\">&quot;3306:3306&quot;</span></span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - ../mysql/data:/var/lib/mysql</span><br><span class=\"line\">      - ../mysql/my.cnf:/etc/mysql/my.cnf</span><br><span class=\"line\">      - ../mysql/logs:/var/log/mysql</span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<p><code>my.cnf</code>配置文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[mysqld]</span><br><span class=\"line\"># 基本设置</span><br><span class=\"line\">user=mysql</span><br><span class=\"line\">port=3306</span><br><span class=\"line\">socket=/var/run/mysqld/mysqld.sock</span><br><span class=\"line\">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class=\"line\">secure-file-priv=/var/lib/mysql-files</span><br><span class=\"line\">datadir=/var/lib/mysql</span><br><span class=\"line\"></span><br><span class=\"line\"># 性能优化</span><br><span class=\"line\">key_buffer_size=16M</span><br><span class=\"line\">max_allowed_packet=64M</span><br><span class=\"line\">table_open_cache=400</span><br><span class=\"line\">sort_buffer_size=4M</span><br><span class=\"line\">read_buffer_size=4M</span><br><span class=\"line\">read_rnd_buffer_size=4M</span><br><span class=\"line\">myisam_sort_buffer_size=64M</span><br><span class=\"line\">thread_cache_size=8</span><br><span class=\"line\"></span><br><span class=\"line\"># InnoDB 引擎设置</span><br><span class=\"line\">innodb_buffer_pool_size=1G</span><br><span class=\"line\">innodb_log_file_size=256M</span><br><span class=\"line\">innodb_flush_log_at_trx_commit=1</span><br><span class=\"line\">innodb_file_per_table=1</span><br><span class=\"line\">innodb_open_files=400</span><br><span class=\"line\">innodb_io_capacity=400</span><br><span class=\"line\">innodb_flush_method=O_DIRECT</span><br><span class=\"line\"></span><br><span class=\"line\"># 日志设置</span><br><span class=\"line\">log_error=/var/log/mysql/error.log</span><br><span class=\"line\">slow_query_log=1</span><br><span class=\"line\">slow_query_log_file=/var/log/mysql/mysql-slow.log</span><br><span class=\"line\">long_query_time=2</span><br></pre></td></tr></table></figure>\n\n<p>目录结构</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">── mysql/</span><br><span class=\"line\">    ├── data/</span><br><span class=\"line\">    ├── logs/</span><br><span class=\"line\">    └── my.cnf</span><br></pre></td></tr></table></figure>\n","categories":["mysql"],"tags":["mysql"]},{"title":"mysql主从","url":"/mysql/mysql8-master-slave-install/","content":"<h1 id=\"mysql-高可用\"><a href=\"#mysql-高可用\" class=\"headerlink\" title=\"mysql 高可用\"></a>mysql 高可用</h1><p>使用 docker compose 部署主从 mysql 的主从架构</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">mysql-master:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">dockerhub.qingcloud.com/doubao/mysql:8.0.39</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">mysql-master</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"string\">root</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_USER:</span> <span class=\"string\">app</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_PASSWORD:</span> <span class=\"string\">app</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;3306:3306&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./master/data:/var/lib/mysql</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./master/config/my.cnf:/etc/mysql/my.cnf</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./master/logs:/var/log/mysql</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">mysql-cluster</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">mysql-slave:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">dockerhub.qingcloud.com/doubao/mysql:8.0.39</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">mysql-slave</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"attr\">MYSQL_ROOT_PASSWORD:</span> <span class=\"string\">root</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;3307:3306&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./slave/data:/var/lib/mysql</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./slave/config/my.cnf:/etc/mysql/my.cnf</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./slave/logs:/var/log/mysql</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">mysql-master</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">mysql-cluster</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">mysql-cluster:</span></span><br><span class=\"line\">    <span class=\"attr\">driver:</span> <span class=\"string\">bridge</span></span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<p>master config</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">[mysqld]</span><br><span class=\"line\"><span class=\"comment\">#id需要唯一</span></span><br><span class=\"line\">server-id=1</span><br><span class=\"line\">log-bin=mysql-bin</span><br><span class=\"line\"><span class=\"comment\"># 基本设置</span></span><br><span class=\"line\">user=mysql</span><br><span class=\"line\">port=3306</span><br><span class=\"line\">socket=/var/run/mysqld/mysqld.sock</span><br><span class=\"line\">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class=\"line\">secure-file-priv=/var/lib/mysql-files</span><br><span class=\"line\">datadir=/var/lib/mysql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 性能优化</span></span><br><span class=\"line\">key_buffer_size=16M</span><br><span class=\"line\">max_allowed_packet=64M</span><br><span class=\"line\">table_open_cache=400</span><br><span class=\"line\">sort_buffer_size=4M</span><br><span class=\"line\">read_buffer_size=4M</span><br><span class=\"line\">read_rnd_buffer_size=4M</span><br><span class=\"line\">myisam_sort_buffer_size=64M</span><br><span class=\"line\">thread_cache_size=8</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># InnoDB 引擎设置</span></span><br><span class=\"line\">innodb_buffer_pool_size=1G</span><br><span class=\"line\">innodb_log_file_size=256M</span><br><span class=\"line\">innodb_flush_log_at_trx_commit=1</span><br><span class=\"line\">innodb_file_per_table=1</span><br><span class=\"line\">innodb_open_files=400</span><br><span class=\"line\">innodb_io_capacity=400</span><br><span class=\"line\">innodb_flush_method=O_DIRECT</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 日志设置</span></span><br><span class=\"line\">log_error=/var/log/mysql/error.log</span><br><span class=\"line\">slow_query_log=1</span><br><span class=\"line\">slow_query_log_file=/var/log/mysql/mysql-slow.log</span><br><span class=\"line\">long_query_time=2slave config</span><br></pre></td></tr></table></figure>\n\n<p>slave config</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">[mysqld]</span><br><span class=\"line\"><span class=\"comment\">#id需要唯一</span></span><br><span class=\"line\">server-id=2</span><br><span class=\"line\">relay-log=relay-bin</span><br><span class=\"line\">log-bin=mysql-bin</span><br><span class=\"line\"><span class=\"comment\"># 基本设置</span></span><br><span class=\"line\">user=mysql</span><br><span class=\"line\">port=3306</span><br><span class=\"line\">socket=/var/run/mysqld/mysqld.sock</span><br><span class=\"line\">pid-file=/var/run/mysqld/mysqld.pid</span><br><span class=\"line\">secure-file-priv=/var/lib/mysql-files</span><br><span class=\"line\">datadir=/var/lib/mysql</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 性能优化</span></span><br><span class=\"line\">key_buffer_size=16M</span><br><span class=\"line\">max_allowed_packet=64M</span><br><span class=\"line\">table_open_cache=400</span><br><span class=\"line\">sort_buffer_size=4M</span><br><span class=\"line\">read_buffer_size=4M</span><br><span class=\"line\">read_rnd_buffer_size=4M</span><br><span class=\"line\">myisam_sort_buffer_size=64M</span><br><span class=\"line\">thread_cache_size=8</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># InnoDB 引擎设置</span></span><br><span class=\"line\">innodb_buffer_pool_size=1G</span><br><span class=\"line\">innodb_log_file_size=256M</span><br><span class=\"line\">innodb_flush_log_at_trx_commit=1</span><br><span class=\"line\">innodb_file_per_table=1</span><br><span class=\"line\">innodb_open_files=400</span><br><span class=\"line\">innodb_io_capacity=400</span><br><span class=\"line\">innodb_flush_method=O_DIRECT</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 日志设置</span></span><br><span class=\"line\">log_error=/var/log/mysql/error.log</span><br><span class=\"line\">slow_query_log=1</span><br><span class=\"line\">slow_query_log_file=/var/log/mysql/mysql-slow.log</span><br><span class=\"line\">long_query_time=2</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"部署服务\"><a href=\"#部署服务\" class=\"headerlink\" title=\"部署服务\"></a>部署服务</h1><p>使用 docker compose 启动服务后，先进去容器，然后连接 mysql</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#进入容器</span></span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> -it mysql-master bash</span><br><span class=\"line\"><span class=\"comment\">#连接mysql</span></span><br><span class=\"line\">mysql -h localhost -u root -proot</span><br></pre></td></tr></table></figure>\n\n<p>连接完成后，执行下面的 sql 新建用户。</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">CREATE</span> <span class=\"keyword\">USER</span> <span class=\"string\">&#x27;replica&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span> IDENTIFIED <span class=\"keyword\">BY</span> <span class=\"string\">&#x27;replica-password&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">GRANT</span> REPLICATION SLAVE <span class=\"keyword\">ON</span> <span class=\"operator\">*</span>.<span class=\"operator\">*</span> <span class=\"keyword\">TO</span> <span class=\"string\">&#x27;replica&#x27;</span>@<span class=\"string\">&#x27;%&#x27;</span>;</span><br><span class=\"line\">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure>\n\n<p>查看 master 的 binlog 信息，slave 同步的时候需要。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysql&gt; SHOW MASTER STATUS\\G;</span><br><span class=\"line\">*************************** 1. row ***************************</span><br><span class=\"line\">             File: mysql-bin.000003</span><br><span class=\"line\">         Position: 862</span><br><span class=\"line\">     Binlog_Do_DB:</span><br><span class=\"line\"> Binlog_Ignore_DB:</span><br><span class=\"line\">Executed_Gtid_Set:</span><br><span class=\"line\">1 row <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>\n\n<p>同样的方式进入到 slave 容器中，然后执行同步命令然后启动同步</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysql&gt; CHANGE MASTER TO MASTER_HOST=<span class=\"string\">&#x27;mysql-master&#x27;</span>, MASTER_USER=<span class=\"string\">&#x27;replica&#x27;</span>, MASTER_PASSWORD=<span class=\"string\">&#x27;replica-password&#x27;</span>, MASTER_LOG_FILE=<span class=\"string\">&#x27;mysql-bin.000005&#x27;</span>, MASTER_LOG_POS=157,  get_master_public_key=1;</span><br></pre></td></tr></table></figure>\n\n<p><code> get_master_public_key=1;</code>是为了解决 slave 连接 master 的认证问题。因为 mysql8 以后使用<code>&#39;caching_sha2_password</code>密码加密。所以特殊处理。</p>\n<p><code>MASTER_LOG_FILE=&#39;mysql-bin.000005&#39;, MASTER_LOG_POS=157,</code>这两个信息就是从<code>master status</code>中获取到的。</p>\n<p>执行<code>START SLAVE</code>启动同步；</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysql&gt; START SLAVE;</span><br><span class=\"line\">Query OK, 0 rows affected, 1 warning (0.03 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; SHOW SLAVE STATUS\\G</span><br><span class=\"line\">*************************** 1. row ***************************</span><br><span class=\"line\">               Slave_IO_State: Waiting <span class=\"keyword\">for</span> <span class=\"built_in\">source</span> to send event</span><br><span class=\"line\">                  Master_Host: mysql-master</span><br><span class=\"line\">                  Master_User: replica</span><br><span class=\"line\">                  Master_Port: 3306</span><br><span class=\"line\">                Connect_Retry: 60</span><br><span class=\"line\">              Master_Log_File: mysql-bin.000005</span><br><span class=\"line\">          Read_Master_Log_Pos: 157</span><br><span class=\"line\">               Relay_Log_File: relay-bin.000002</span><br><span class=\"line\">                Relay_Log_Pos: 326</span><br><span class=\"line\">        Relay_Master_Log_File: mysql-bin.000005</span><br><span class=\"line\">             Slave_IO_Running: Yes</span><br><span class=\"line\">            Slave_SQL_Running: Yes</span><br><span class=\"line\">              Replicate_Do_DB:</span><br><span class=\"line\">          Replicate_Ignore_DB:</span><br><span class=\"line\">           Replicate_Do_Table:</span><br><span class=\"line\">       Replicate_Ignore_Table:</span><br><span class=\"line\">      Replicate_Wild_Do_Table:</span><br><span class=\"line\">  Replicate_Wild_Ignore_Table:</span><br><span class=\"line\">                   Last_Errno: 0</span><br><span class=\"line\">                   Last_Error:</span><br><span class=\"line\">                 Skip_Counter: 0</span><br><span class=\"line\">          Exec_Master_Log_Pos: 157</span><br><span class=\"line\">              Relay_Log_Space: 530</span><br><span class=\"line\">              Until_Condition: None</span><br><span class=\"line\">               Until_Log_File:</span><br><span class=\"line\">                Until_Log_Pos: 0</span><br><span class=\"line\">           Master_SSL_Allowed: No</span><br><span class=\"line\">           Master_SSL_CA_File:</span><br><span class=\"line\">           Master_SSL_CA_Path:</span><br><span class=\"line\">              Master_SSL_Cert:</span><br><span class=\"line\">            Master_SSL_Cipher:</span><br><span class=\"line\">               Master_SSL_Key:</span><br><span class=\"line\">        Seconds_Behind_Master: 0</span><br><span class=\"line\">Master_SSL_Verify_Server_Cert: No</span><br><span class=\"line\">                Last_IO_Errno: 0</span><br><span class=\"line\">                Last_IO_Error:</span><br><span class=\"line\">               Last_SQL_Errno: 0</span><br><span class=\"line\">               Last_SQL_Error:</span><br><span class=\"line\">  Replicate_Ignore_Server_Ids:</span><br><span class=\"line\">             Master_Server_Id: 1</span><br><span class=\"line\">                  Master_UUID: 377a786f-5262-11ef-8bef-0242ac120002</span><br><span class=\"line\">             Master_Info_File: mysql.slave_master_info</span><br><span class=\"line\">                    SQL_Delay: 0</span><br><span class=\"line\">          SQL_Remaining_Delay: NULL</span><br><span class=\"line\">      Slave_SQL_Running_State: Replica has <span class=\"built_in\">read</span> all relay <span class=\"built_in\">log</span>; waiting <span class=\"keyword\">for</span> more updates</span><br><span class=\"line\">           Master_Retry_Count: 86400</span><br><span class=\"line\">                  Master_Bind:</span><br><span class=\"line\">      Last_IO_Error_Timestamp:</span><br><span class=\"line\">     Last_SQL_Error_Timestamp:</span><br><span class=\"line\">               Master_SSL_Crl:</span><br><span class=\"line\">           Master_SSL_Crlpath:</span><br><span class=\"line\">           Retrieved_Gtid_Set:</span><br><span class=\"line\">            Executed_Gtid_Set:</span><br><span class=\"line\">                Auto_Position: 0</span><br><span class=\"line\">         Replicate_Rewrite_DB:</span><br><span class=\"line\">                 Channel_Name:</span><br><span class=\"line\">           Master_TLS_Version:</span><br><span class=\"line\">       Master_public_key_path:</span><br><span class=\"line\">        Get_master_public_key: 1</span><br><span class=\"line\">            Network_Namespace:</span><br><span class=\"line\">1 row <span class=\"keyword\">in</span> <span class=\"built_in\">set</span>, 1 warning (0.00 sec)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"验证同步\"><a href=\"#验证同步\" class=\"headerlink\" title=\"验证同步\"></a>验证同步</h1><p>在 master 上新建一个库</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysql&gt; create database <span class=\"built_in\">test</span>;</span><br><span class=\"line\">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure>\n\n<p>在 slave 上查看库是否同步过来</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">mysql&gt; show databases;</span><br><span class=\"line\">+--------------------+</span><br><span class=\"line\">| Database           |</span><br><span class=\"line\">+--------------------+</span><br><span class=\"line\">| information_schema |</span><br><span class=\"line\">| mysql              |</span><br><span class=\"line\">| performance_schema |</span><br><span class=\"line\">| sys                |</span><br><span class=\"line\">| <span class=\"built_in\">test</span>               |</span><br><span class=\"line\">+--------------------+</span><br><span class=\"line\">5 rows <span class=\"keyword\">in</span> <span class=\"built_in\">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure>\n","categories":["mysql"],"tags":["mysql"]},{"title":"rime","url":"/rime/rime-customize-config/","content":"<h1 id=\"安装-rime\"><a href=\"#安装-rime\" class=\"headerlink\" title=\"安装 rime\"></a>安装 rime</h1><p>‌‌‌ 根据官方网站安装即可 <a href=\"https://github.com/rime/weasel\">rime</a></p>\n<h1 id=\"安装薄荷输入法\"><a href=\"#安装薄荷输入法\" class=\"headerlink\" title=\"安装薄荷输入法\"></a>安装薄荷输入法</h1><p>‌‌‌ 根据官方网站安装即可 <a href=\"https://github.com/Mintimate/oh-my-rime\">oh-my-rime</a></p>\n<h1 id=\"自定义输入法皮肤配色\"><a href=\"#自定义输入法皮肤配色\" class=\"headerlink\" title=\"自定义输入法皮肤配色\"></a>自定义输入法皮肤配色</h1><p>‌‌‌ 根据官方文档操作即可，下面文档中有详细介绍皮肤各个地方的参数，如何更改。<a href=\"https://github.com/rime/weasel/wiki\">rime-wiki</a>。‌ 也可以使用在线编辑的网友来自定义更改，下面有三个</p>\n<ul>\n<li><p><a href=\"https://pdog18.github.io/rime-soak/#/theme\">https://pdog18.github.io/rime-soak/#/theme</a></p>\n</li>\n<li><p><a href=\"https://owlzou.github.io/weasel-theme-editor/\">https://owlzou.github.io/weasel-theme-editor/</a></p>\n</li>\n<li><p><a href=\"https://fxliang.github.io/RimeSeeMe/\">https://fxliang.github.io/RimeSeeMe/</a></p>\n<span id=\"more\"></span></li>\n</ul>\n<h1 id=\"自用输入法皮肤配色\"><a href=\"#自用输入法皮肤配色\" class=\"headerlink\" title=\"自用输入法皮肤配色\"></a>自用输入法皮肤配色</h1><p>‌‌‌ 由于自己平时使用搜狗输入法居多，所以习惯了搜狗输入法的默认皮肤，基于<code>小鹤飞扬／flypy</code>配色主题更改了自己喜好的配色。<br>‌‌‌ 下面的 yaml 文件需要放在<code>用户文件夹</code>下的<code>weasel.custom.yaml</code>中</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#patch:</span></span><br><span class=\"line\"><span class=\"comment\">#  style/horizontal: true</span></span><br><span class=\"line\"><span class=\"comment\">#  style/color_scheme: soak</span></span><br><span class=\"line\"><span class=\"comment\">#  style/layout/margin_x: 9</span></span><br><span class=\"line\"><span class=\"comment\">#  style/layout/margin_y: 6</span></span><br><span class=\"line\"><span class=\"comment\">#  preset_color_schemes:</span></span><br><span class=\"line\"><span class=\"comment\">#    soak:</span></span><br><span class=\"line\"><span class=\"comment\">#      text_color: 0</span></span><br><span class=\"line\"><span class=\"comment\">#      back_color: 16382457</span></span><br><span class=\"line\"><span class=\"comment\">#      border_color: 13027014</span></span><br><span class=\"line\"><span class=\"comment\">#      label_color: 16744448</span></span><br><span class=\"line\"><span class=\"comment\">#      hilited_text_color: 16744448</span></span><br><span class=\"line\"><span class=\"comment\">#      hilited_back_color: 16777215</span></span><br><span class=\"line\"><span class=\"comment\">#      candidate_text_color: 16744448</span></span><br><span class=\"line\"><span class=\"comment\">#      comment_text_color: 16744448</span></span><br><span class=\"line\"><span class=\"comment\">#      hilited_candidate_text_color: 176</span></span><br><span class=\"line\"><span class=\"comment\">#      hilited_comment_text_color: 176</span></span><br><span class=\"line\"><span class=\"comment\">#      hilited_candidate_back_color: 16777215</span></span><br><span class=\"line\"><span class=\"comment\">#      hilited_label_color: 5592522</span></span><br><span class=\"line\"><span class=\"string\">‌‌‌</span>　　<span class=\"attr\">patch:</span></span><br><span class=\"line\">  <span class=\"attr\">menu/page_size:</span> <span class=\"number\">9</span></span><br><span class=\"line\">  <span class=\"attr\">style/horizontal:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"attr\">style/color_scheme:</span> <span class=\"string\">soak</span></span><br><span class=\"line\">  <span class=\"attr\">style/layout/margin_x:</span> <span class=\"number\">9</span></span><br><span class=\"line\">  <span class=\"attr\">style/layout/margin_y:</span> <span class=\"number\">6</span></span><br><span class=\"line\">  <span class=\"attr\">preset_color_schemes:</span></span><br><span class=\"line\">    <span class=\"attr\">soak:</span></span><br><span class=\"line\">      <span class=\"attr\">text_color:</span> <span class=\"number\">0</span></span><br><span class=\"line\">      <span class=\"attr\">back_color:</span> <span class=\"number\">16250871</span></span><br><span class=\"line\">      <span class=\"attr\">border_color:</span> <span class=\"number\">13027014</span></span><br><span class=\"line\">      <span class=\"attr\">label_color:</span> <span class=\"number\">16744448</span></span><br><span class=\"line\">      <span class=\"attr\">hilited_text_color:</span> <span class=\"number\">16744448</span></span><br><span class=\"line\">      <span class=\"attr\">hilited_back_color:</span> <span class=\"number\">16777215</span></span><br><span class=\"line\">      <span class=\"attr\">candidate_text_color:</span> <span class=\"number\">16744448</span></span><br><span class=\"line\">      <span class=\"attr\">comment_text_color:</span> <span class=\"number\">16744448</span></span><br><span class=\"line\">      <span class=\"attr\">hilited_candidate_text_color:</span> <span class=\"number\">1381881</span></span><br><span class=\"line\">      <span class=\"attr\">hilited_comment_text_color:</span> <span class=\"number\">1381881</span></span><br><span class=\"line\">      <span class=\"attr\">hilited_candidate_back_color:</span> <span class=\"number\">16777215</span></span><br><span class=\"line\">      <span class=\"attr\">hilited_label_color:</span> <span class=\"number\">5592522</span></span><br></pre></td></tr></table></figure>\n\n<p>‌‌‌ 如果想更改候选词圆角的话，需要更改<code>用户文件夹</code>下<code>weasel.yaml</code>中<code>layout</code>下面的配置。由于我只使用这一个皮肤，所以把 rime 自带的皮肤配色都删除了。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Weasel settings</span></span><br><span class=\"line\"><span class=\"comment\"># encoding: utf-8</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 感谢 @[Mirtle](https://github.com/mirtlecn) 整理</span></span><br><span class=\"line\"><span class=\"comment\"># Rime 定制指南 &lt;https://github.com/rime/home/wiki/CustomizationGuide#定製指南&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># Weasel 定制文档 &lt;https://github.com/rime/weasel/wiki/Weasel-定製化&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># Weasel 字体设定 &lt;https://github.com/rime/weasel/wiki/字體設定&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 部分选项需要将 Weasel 更新至最新开发版才能生效</span></span><br><span class=\"line\"><span class=\"string\">‌‌‌</span>　　<span class=\"attr\">config_version:</span> <span class=\"string\">&quot;2024-03-02&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># [app_options]</span></span><br><span class=\"line\"><span class=\"comment\"># 针对特定应用的设置</span></span><br><span class=\"line\"><span class=\"string\">‌‌‌</span>　　<span class=\"attr\">app_options:</span></span><br><span class=\"line\">  <span class=\"attr\">firefox.exe:</span></span><br><span class=\"line\">    <span class=\"attr\">inline_preedit:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 行内显示预编辑区：规避 &lt;https://github.com/rime/weasel/issues/946&gt;</span></span><br><span class=\"line\">  <span class=\"attr\">iexplore.exe:</span></span><br><span class=\"line\">    <span class=\"attr\">inline_preedit:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 兼容 IE</span></span><br><span class=\"line\">  <span class=\"attr\">browser.exe:</span></span><br><span class=\"line\">    <span class=\"attr\">inline_preedit:</span> <span class=\"literal\">true</span> <span class=\"comment\"># 兼容 Yandex</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># [global settings]</span></span><br><span class=\"line\"><span class=\"string\">‌‌‌</span>　　<span class=\"attr\">show_notifications:</span> <span class=\"literal\">true</span>                   <span class=\"comment\"># 是否显示状态变化的通知：true；false；option_list（方案内的开头 option）</span></span><br><span class=\"line\"><span class=\"string\">‌‌‌</span>　　<span class=\"attr\">show_notifications_time:</span> <span class=\"number\">1200</span>              <span class=\"comment\"># 通知显示的时间，单位 ms</span></span><br><span class=\"line\"><span class=\"string\">‌‌‌</span>　　<span class=\"attr\">global_ascii:</span> <span class=\"literal\">false</span>                        <span class=\"comment\"># 切换为 ascii 模式时，是否影响所有窗口：true；false</span></span><br><span class=\"line\"><span class=\"comment\"># [End of &lt;global settings&gt;]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># [style]</span></span><br><span class=\"line\"><span class=\"comment\"># 字体；候选项、候选窗口的行为、布局及样式</span></span><br><span class=\"line\"><span class=\"string\">‌‌‌</span>　　<span class=\"attr\">style:</span></span><br><span class=\"line\">  <span class=\"attr\">color_scheme:</span> <span class=\"string\">mint_light_blue</span>             <span class=\"comment\"># 默认配色方案</span></span><br><span class=\"line\">  <span class=\"attr\">color_scheme_dark:</span> <span class=\"string\">mint_dark_blue</span>         <span class=\"comment\"># 深色模式下，Weasel 的配色方案，Windows 10 1809+ 可用</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 全局字体</span></span><br><span class=\"line\">  <span class=\"comment\"># 格式：字体1:起始码位:结束码位:字重:字形,字体2……，字体会依次 fallback</span></span><br><span class=\"line\">  <span class=\"comment\"># 详细设定请参考 &lt;https://github.com/rime/weasel/wiki/字體設定&gt;</span></span><br><span class=\"line\">  <span class=\"attr\">font_face:</span> <span class=\"string\">&quot;Segoe UI Emoji:30:39, Segoe UI Emoji:23:23, Segoe UI Emoji:2a:2a, Segoe UI Emoji:fe0f:fe0f, Segoe UI Emoji:20e3:20e3, Microsoft YaHei, SF Pro, Segoe UI Emoji, Noto Color Emoji&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">label_font_face:</span> <span class=\"string\">&quot;Microsoft YaHei&quot;</span>       <span class=\"comment\"># 标签字体</span></span><br><span class=\"line\">  <span class=\"attr\">comment_font_face:</span> <span class=\"string\">&quot;Microsoft YaHei&quot;</span>     <span class=\"comment\"># 注释字体</span></span><br><span class=\"line\">  <span class=\"attr\">font_point:</span> <span class=\"number\">12</span>                           <span class=\"comment\"># 全局字体字号</span></span><br><span class=\"line\">  <span class=\"attr\">label_font_point:</span> <span class=\"number\">12</span>                     <span class=\"comment\"># 标签字体字号，不设定 fallback 到 font_point</span></span><br><span class=\"line\">  <span class=\"attr\">comment_font_point:</span> <span class=\"number\">10</span>                   <span class=\"comment\"># 注释字体字号，不设定 fallback 到 font_point</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">inline_preedit:</span> <span class=\"literal\">false</span>                     <span class=\"comment\"># 行内显示预编辑区：true；false</span></span><br><span class=\"line\">  <span class=\"attr\">preedit_type:</span> <span class=\"string\">composition</span>                <span class=\"comment\"># 预编辑区内容：composition（编码）； preview（选中的候选）；preview_all（全部候选）</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">fullscreen:</span> <span class=\"literal\">false</span>                        <span class=\"comment\"># 候选窗口全屏显示：true；false</span></span><br><span class=\"line\">  <span class=\"attr\">vertical_text:</span> <span class=\"literal\">false</span>                     <span class=\"comment\"># 竖排文本：true；false</span></span><br><span class=\"line\">  <span class=\"comment\"># text_orientation: horizontal           # 文本排列方向，效果和 `vertical_text` 相同：horizontal；vertical</span></span><br><span class=\"line\">  <span class=\"attr\">candidate_list_layout:</span> <span class=\"string\">stacked</span>           <span class=\"comment\"># stacked | linear  候选项排列方向（似乎只有在custom内才可以生效）</span></span><br><span class=\"line\">  <span class=\"attr\">horizontal:</span> <span class=\"literal\">false</span>                        <span class=\"comment\"># 候选项水平排列（在custom内和andidate_list_layout的linear效果一样）</span></span><br><span class=\"line\">  <span class=\"attr\">vertical_text_left_to_right:</span> <span class=\"literal\">false</span>       <span class=\"comment\"># 竖排方向是否从左到右：true；false</span></span><br><span class=\"line\">  <span class=\"attr\">vertical_text_with_wrap:</span> <span class=\"literal\">false</span>           <span class=\"comment\"># 文本竖排模式下，自动换行：true；false</span></span><br><span class=\"line\">  <span class=\"attr\">vertical_auto_reverse:</span> <span class=\"literal\">false</span>             <span class=\"comment\"># 文本竖排模式下，候选窗口位于光标上方时倒序排列：true；false</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">label_format:</span> <span class=\"string\">&quot;%s&quot;</span>                       <span class=\"comment\"># 标签字符：例如 %s. 效果为 1. 2. 3. ....</span></span><br><span class=\"line\">  <span class=\"attr\">mark_text:</span> <span class=\"string\">&quot;|&quot;</span>                           <span class=\"comment\"># 标记字符，显示在选中的候选标签前，需要在配色方案中指定颜色；如该项为空字符串 &quot;&quot; 而配色方案中 hilited_mark_color 非透明色，则显示 Windows 11 输入法风格标记</span></span><br><span class=\"line\">  <span class=\"attr\">ascii_tip_follow_cursor:</span> <span class=\"literal\">false</span>           <span class=\"comment\"># 切换 ASCII 模式时，提示跟随鼠标，而非输入光标</span></span><br><span class=\"line\">  <span class=\"attr\">enhanced_position:</span> <span class=\"literal\">true</span>                  <span class=\"comment\"># 无法定位候选框时，在窗口左上角显示候选框：true；false</span></span><br><span class=\"line\">  <span class=\"attr\">display_tray_icon:</span> <span class=\"literal\">false</span>                 <span class=\"comment\"># 托盘显示独立于语言栏的额外图标：true；false</span></span><br><span class=\"line\">  <span class=\"attr\">antialias_mode:</span> <span class=\"string\">default</span>                  <span class=\"comment\"># 次像素反锯齿设定：default；force_dword；cleartype；grayscale；aliased</span></span><br><span class=\"line\">  <span class=\"attr\">candidate_abbreviate_length:</span> <span class=\"number\">30</span>          <span class=\"comment\"># 候选项略写，超过此数字则用省略号代替。设置为 0 则不启用此功能</span></span><br><span class=\"line\">  <span class=\"attr\">mouse_hover_ms:</span> <span class=\"number\">0</span>                        <span class=\"comment\"># ! 已弃用。鼠标悬停选词响应时间（ms），设置为 0 时禁用该功能</span></span><br><span class=\"line\">  <span class=\"attr\">hover_type:</span> <span class=\"string\">none</span>                         <span class=\"comment\"># 鼠标在候选窗口悬停时：none（无动作）；hilite（选中鼠标下的候选）；semi_hilite（高亮鼠标下的候选）</span></span><br><span class=\"line\">  <span class=\"attr\">paging_on_scroll:</span> <span class=\"literal\">true</span>                   <span class=\"comment\"># 在候选窗口上滑动滚轮的行为：true（翻页）；false （选中下一个候选）</span></span><br><span class=\"line\">  <span class=\"attr\">click_to_capture:</span> <span class=\"literal\">false</span>                  <span class=\"comment\"># 鼠标点击候选项，创建截图：true；false</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">layout:</span></span><br><span class=\"line\">    <span class=\"attr\">baseline:</span> <span class=\"number\">0</span>                            <span class=\"comment\"># 字号百分比，与 linespacing 一同设置可解决字体跳动问题，设置为 0 为禁用</span></span><br><span class=\"line\">    <span class=\"attr\">linespacing:</span> <span class=\"number\">0</span>                         <span class=\"comment\"># 字号百分比，参考 &lt;https://github.com/rime/weasel/pull/1177&gt;</span></span><br><span class=\"line\">    <span class=\"attr\">align_type:</span> <span class=\"string\">center</span>                     <span class=\"comment\"># 标签、候选文字、注解文字之间的相对对齐方式：top ; center ; bottom</span></span><br><span class=\"line\">    <span class=\"attr\">max_height:</span> <span class=\"number\">600</span>                        <span class=\"comment\"># 候选框最大高度，horizontal 布局如宽超此尺寸则换行显示候选，设置为 0 不启用此功能</span></span><br><span class=\"line\">    <span class=\"attr\">max_width:</span> <span class=\"number\">0</span>                           <span class=\"comment\"># 候选框最大宽度，文本竖排模式下如高度超此尺寸则换列显示候选，设置为 0 不启用此功能</span></span><br><span class=\"line\">    <span class=\"attr\">min_height:</span> <span class=\"number\">0</span>                          <span class=\"comment\"># 候选框最小高度</span></span><br><span class=\"line\">    <span class=\"attr\">min_width:</span> <span class=\"number\">145</span>                          <span class=\"comment\"># 候选框最小宽度</span></span><br><span class=\"line\">    <span class=\"attr\">border_width:</span> <span class=\"number\">0</span>                        <span class=\"comment\"># 边框宽度；又名 border</span></span><br><span class=\"line\">    <span class=\"attr\">margin_x:</span> <span class=\"number\">8</span>                            <span class=\"comment\"># 主体元素和候选框的左右边距；为负值时，不显示候选框</span></span><br><span class=\"line\">    <span class=\"attr\">margin_y:</span> <span class=\"number\">8</span>                            <span class=\"comment\"># 主体元素的上下边距；为负值时，不显示候选框</span></span><br><span class=\"line\">    <span class=\"attr\">spacing:</span> <span class=\"number\">10</span>                            <span class=\"comment\"># inline_preedit 为否时，编码区域和候选区域的间距</span></span><br><span class=\"line\">    <span class=\"attr\">candidate_spacing:</span> <span class=\"number\">22</span>                  <span class=\"comment\"># 候选项之间的间距</span></span><br><span class=\"line\">    <span class=\"attr\">hilite_spacing:</span> <span class=\"number\">6</span>                      <span class=\"comment\"># 候选项和相应标签的间距</span></span><br><span class=\"line\">    <span class=\"attr\">hilite_padding:</span> <span class=\"number\">8</span>                      <span class=\"comment\"># 高亮区域和内部文字的间距，影响高亮区域大小</span></span><br><span class=\"line\">    <span class=\"comment\"># hilite_padding_x: 8                  # 高亮区域和内部文字的左右间距，如无特殊指定则依 hilite_padding 设置</span></span><br><span class=\"line\">    <span class=\"comment\"># hilite_padding_y: 8                  # 高亮区域和内部文字的上下间距，如无特殊指定则依 hilite_padding 设置</span></span><br><span class=\"line\">    <span class=\"attr\">shadow_radius:</span> <span class=\"number\">0</span>                       <span class=\"comment\"># 阴影区域半径，为 0 不显示阴影；需要同时在配色方案中指定非透明的阴影颜色</span></span><br><span class=\"line\">    <span class=\"attr\">shadow_offset_x:</span> <span class=\"number\">4</span>                     <span class=\"comment\"># 阴影左右偏移距离</span></span><br><span class=\"line\">    <span class=\"attr\">shadow_offset_y:</span> <span class=\"number\">4</span>                     <span class=\"comment\"># 阴影上下偏移距离</span></span><br><span class=\"line\">    <span class=\"attr\">corner_radius:</span> <span class=\"number\">4</span>                       <span class=\"comment\"># 候选窗口圆角半径</span></span><br><span class=\"line\">    <span class=\"attr\">round_corner:</span> <span class=\"number\">8</span>                        <span class=\"comment\"># 候选背景色块圆角半径，又名 hilited_corner_radius</span></span><br><span class=\"line\">    <span class=\"comment\"># type: vertical                       # 布局设置，效果和 style 下的设置相同：</span></span><br><span class=\"line\">                                           <span class=\"comment\"># horizontal（横向）；vertical（竖向） ; vertical_text（竖排文本） ; vertical+fullscreen（全屏） ; horizontal+fullscreen（横向全屏）</span></span><br><span class=\"line\"><span class=\"comment\"># [End of &lt;style&gt;]</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># [preset_color_schemes]</span></span><br><span class=\"line\"><span class=\"comment\"># 配色设定</span></span><br><span class=\"line\"><span class=\"comment\"># 在小狼毫用户目录新建 preview 文件夹，将自定义皮肤的截图重命名为 color_scheme_&lt;name&gt;.png 放入此文件夹，可以在「输入法设定」中看到自定义皮肤效果</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 小狼毫配色在线设计：</span></span><br><span class=\"line\"><span class=\"comment\"># [RIME 西米](https://fxliang.github.io/RimeSeeMe/)</span></span><br><span class=\"line\"><span class=\"comment\"># [润笔](https://pdog18.github.io/rime-soak/#/theme)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># [小狼毫配色详解](https://github.com/rime/weasel/wiki/定制小狼毫配色)</span></span><br></pre></td></tr></table></figure>\n\n<p>‌‌‌</p>\n","categories":["rime"],"tags":["rime"]},{"title":"tree","url":"/tools/tree-tools/","content":"<h1 id=\"windows-下直接使用-tree\"><a href=\"#windows-下直接使用-tree\" class=\"headerlink\" title=\"windows 下直接使用 tree\"></a>windows 下直接使用 tree</h1><p><code>tree</code>可以显示目录结构，windows 下在 cmd 中可以直接使用，但是显示会有点瑕疵，不会直接显示子级目录前面的<code>---</code></p>\n<figure class=\"highlight cmd\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">tree</span> /F /A</span><br><span class=\"line\"></span><br><span class=\"line\">+---base</span><br><span class=\"line\">|   +---config</span><br><span class=\"line\">|   |       config.yaml</span><br><span class=\"line\">|   |       kustomization.yaml</span><br><span class=\"line\">|   |</span><br><span class=\"line\">|   +---nginx</span><br><span class=\"line\">|   |       hpa.yaml</span><br><span class=\"line\">|   |       kustomization.yaml</span><br><span class=\"line\">|   |       nginx.yaml</span><br><span class=\"line\">|   |</span><br><span class=\"line\">|   \\---redis</span><br><span class=\"line\">|           hpa.yaml</span><br><span class=\"line\">|           kustomization.yaml</span><br><span class=\"line\">|           redis.yaml</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"git-中安装-tree-for-windows\"><a href=\"#git-中安装-tree-for-windows\" class=\"headerlink\" title=\"git 中安装 tree for windows\"></a>git 中安装 tree for windows</h1><p><a href=\"https://gnuwin32.sourceforge.net/packages/tree.html\">tree for windows</a>安装包。下载 Binaries，解压后将<code>tree.exe</code>复制到 git 的安装目录中的<code>D:\\develop\\Git\\usr\\bin</code>，新建 git bash</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"code\"><pre><span class=\"line\">tree -C -A</span><br><span class=\"line\"></span><br><span class=\"line\">├── config</span><br><span class=\"line\">│   ├── config.yaml</span><br><span class=\"line\">│   └── kustomization.yaml</span><br><span class=\"line\">├── nginx</span><br><span class=\"line\">│   ├── hpa.yaml</span><br><span class=\"line\">│   ├── kustomization.yaml</span><br><span class=\"line\">│   └── nginx.yaml</span><br><span class=\"line\">└── redis</span><br><span class=\"line\">    ├── hpa.yaml</span><br><span class=\"line\">    ├── kustomization.yaml</span><br><span class=\"line\">    └── redis.yaml</span><br></pre></td></tr></table></figure>\n\n<span id=\"more\"></span>\n\n<p>tree 命令行参数：</p>\n<ul>\n<li>-a 显示所有文件和目录。</li>\n<li>-A 使用 ASNI 绘图字符显示树状图而非以 ASCII 字符组合。</li>\n<li>-C 在文件和目录清单加上色彩，便于区分各种类型。</li>\n<li>-d 显示目录名称而非内容。</li>\n<li>-D 列出文件或目录的更改时间。</li>\n<li>-f 在每个文件或目录之前，显示完整的相对路径名称。</li>\n<li>-F 在执行文件，目录，Socket，符号连接，管道名称名称，各自加上”*“,”&#x2F;“,”&#x3D;”,”@”,”|”号。</li>\n<li>-g 列出文件或目录的所属群组名称，没有对应的名称时，则显示群组识别码。</li>\n<li>-i 不以阶梯状列出文件或目录名称。</li>\n<li>-I 不显示符合范本样式的文件或目录名称。</li>\n<li>-l 如遇到性质为符号连接的目录，直接列出该连接所指向的原始目录。</li>\n<li>-n 不在文件和目录清单加上色彩。</li>\n<li>-N 直接列出文件和目录名称，包括控制字符。</li>\n<li>-p 列出权限标示。</li>\n<li>-P 只显示符合范本样式的文件或目录名称。</li>\n<li>-q 用”?”号取代控制字符，列出文件和目录名称。</li>\n<li>-s 列出文件或目录大小。</li>\n<li>-t 用文件和目录的更改时间排序。</li>\n<li>-u 列出文件或目录的拥有者名称，没有对应的名称时，则显示用户识别码。</li>\n<li>-x 将范围局限在现行的文件系统中，若指定目录下的某些子目录，其存放于另一个文件系统上，则将该子目录予以排除在寻找范围外。</li>\n</ul>\n","categories":["tools"],"tags":["tools"]}]